<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>WTTT - Service Advisor Dashboard</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            /* Default (fallback) brand palette ‚Äî overridden dynamically via /api/v1/branding */
            --brand-primary: #4B2B7F;   /* purple */
            --brand-secondary: #0B1F3A; /* dark navy */
            --brand-accent: #F39C12;    /* orange */
            --brand-bg: #FFFFFF;
            --brand-text: #0B1F3A;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, var(--brand-secondary) 0%, var(--brand-primary) 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .brand-logo {
            height: 34px;
            width: auto;
            display: none; /* shown when branding logo exists */
        }
        .brand-title {
            font-weight: 900;
            letter-spacing: 0.2px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .btn-primary {
            background: var(--brand-accent);
            border: none;
            padding: 10px 20px;
            margin: 10px 0;
        }
        .btn-primary:hover {
            filter: brightness(0.92);
        }
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h3 {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 2.5em;
            color: var(--brand-primary);
            font-weight: bold;
        }
        .section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .btn-assign {
            background: var(--brand-primary);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 5px;
        }
        .btn-assign:hover {
            filter: brightness(0.92);
        }
        .btn-assign:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-reassign {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .btn-reassign:hover {
            background: #e0a800;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .badge.open { background: #ffc107; color: #000; }
        .badge.in_progress { background: #17a2b8; color: white; }
        .badge.completed { background: #28a745; color: white; }
        .badge.assigned { background: var(--brand-secondary); color: white; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow: hidden;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 2;
        }
        .modal-header h2 {
            color: #333;
            margin: 0;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--brand-primary);
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .vehicle-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .btn-submit {
            background: var(--brand-accent);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .btn-submit:hover {
            filter: brightness(0.92);
        }
        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Create Job Card UX: scrollable body + sticky footer + accordion sections */
        .modal-body-scroll {
            max-height: calc(90vh - 140px);
            overflow-y: auto;
            padding-right: 6px;
            padding-bottom: 90px; /* prevents last fields from being covered by sticky footer */
        }

        .modal-footer-sticky {
            position: sticky;
            bottom: 0;
            background: #fff;
            padding: 12px 0 12px;
            border-top: 1px solid #eee;
            z-index: 2;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* In the sticky footer, the submit button should NOT be full-width (prevents overlap) */
        .modal-footer-sticky .btn-submit {
            width: auto;
            margin-top: 0;
            padding: 12px 18px;
        }

        /* Footer "Cancel" button should be visible in modals (header .btn is white-on-blue) */
        .modal-footer-sticky .btn {
            background: #e9ecef;
            color: #333;
            border: 1px solid #d0d7de;
        }
        .modal-footer-sticky .btn:hover {
            background: #dee2e6;
        }

        /* Technician modal can be taller (weekly schedule grid) ‚Äî allow scrolling instead of clipping */
        #technicianModal .modal-content {
            overflow-y: auto;
        }
        #technicianModal .form-actions {
            position: sticky;
            bottom: 0;
            background: #fff;
            padding-top: 12px;
            margin-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        .btn-pseudo-disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        .accordion-tools {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0 15px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 10px;
        }

        .accordion-tools .hint {
            color: #666;
            font-size: 0.9em;
        }

        .acc-section {
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            background: #fff;
        }

        .acc-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: 800;
            color: #333;
        }

        .acc-header .sub {
            font-weight: 600;
            color: #666;
            font-size: 0.85em;
        }

        .acc-body {
            padding: 14px;
            display: none;
        }

        .acc-section.open .acc-body {
            display: block;
        }

        .acc-section.open .acc-header {
            background: #eef6ff;
        }
        .error-msg {
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        /* Job Cards list UX */
        .filter-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .filter-group .filter-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 160px;
        }
        .filter-group .filter-item label {
            font-size: 0.8em;
            color: #666;
            font-weight: 700;
        }
        .filter-group select,
        .filter-group input[type="text"],
        .filter-group input[type="date"] {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fff;
            min-height: 38px;
        }
        .jobcards-table-wrap {
            overflow-x: auto;
            border: 1px solid #eee;
            border-radius: 10px;
            background: #fff;
        }
        table.jobcards-table {
            width: 100%;
            border-collapse: collapse;
        }
        table.jobcards-table th,
        table.jobcards-table td {
            padding: 12px 12px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
        }
        table.jobcards-table th {
            position: sticky;
            top: 0;
            z-index: 1;
            background: #f8f9fa;
        }
        table.jobcards-table tr:nth-child(even) td {
            background: #fcfcfd;
        }
        .cell-muted {
            color: #666;
            font-size: 0.85em;
            margin-top: 4px;
        }
        .jobcards-actions {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap; /* keep actions on one line */
            justify-content: flex-end;
            overflow-x: auto; /* allow horizontal scroll if needed */
            -webkit-overflow-scrolling: touch;
            padding-bottom: 2px;
        }
        .jobcards-actions .btn,
        .jobcards-actions .btn-assign,
        .jobcards-actions .btn-reassign {
            white-space: nowrap;
        }
        .jobcards-col-actions {
            min-width: 220px;
            text-align: right;
        }
        .jobcards-col-job {
            min-width: 130px;
        }
        .jobcards-col-customer {
            min-width: 140px;
        }
        .jobcards-col-asset {
            min-width: 180px;
        }

        /* Advisor dashboard tabs (reduce scrolling) */
        .advisor-tabbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0 18px;
        }
        .advisor-tabbar .tabbtn {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 999px;
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 800;
            color: #333;
        }
        .advisor-tabbar .tabbtn.active {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
            color: #fff;
        }
        .advisor-tab-panel {
            display: none;
        }
        .advisor-tab-panel.active {
            display: block;
        }
        .floating-top {
            position: fixed;
            right: 18px;
            bottom: 18px;
            z-index: 999;
            display: none;
        }

        /* Prevent job number line from wrapping (keep date on its own line) */
        td.jobcards-col-job > div:first-child {
            white-space: nowrap;
        }

        /* Responsive tighten-up */
        @media (max-width: 1100px) {
            table.jobcards-table th,
            table.jobcards-table td {
                padding: 10px 10px;
            }
            .jobcards-actions .btn,
            .jobcards-actions .btn-assign,
            .jobcards-actions .btn-reassign {
                padding: 5px 8px !important;
                font-size: 0.82em !important;
            }
            .jobcards-col-actions {
                min-width: 200px;
            }
            .jobcards-col-asset {
                min-width: 150px;
            }
        }
        .form-group small {
            color: #6c757d !important;
            font-size: 0.875em;
            font-style: italic;
            display: block;
            margin-top: 5px;
            line-height: 1.4;
            text-decoration: none !important;
        }
        .form-group label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        .form-group textarea {
            resize: vertical;
            font-family: inherit;
        }
    </style>
    <link rel="stylesheet" href="theme.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="brand">
                <img class="brand-logo" data-brand="logo" alt="System Logo">
                <h1 class="brand-title"><span data-brand="system-name">WTTT</span> <span style="font-weight:700;">‚Äî Service Advisor</span></h1>
            </div>
            <div class="user-info">
                <div id="userDisplay"></div>
                <a href="index.html" class="btn" onclick="logout()">Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-grid">
            <div class="card">
                <h3>Job Cards</h3>
                <div class="stat-value" id="totalJobCards">-</div>
            </div>
            <div class="card">
                <h3>Active Assignments</h3>
                <div class="stat-value" id="activeAssignments">-</div>
            </div>
            <div class="card">
                <h3>Pending Assignments</h3>
                <div class="stat-value" id="pendingAssignments">-</div>
            </div>
        </div>

        <div class="advisor-tabbar" id="advisorTabbar">
            <button class="tabbtn active" type="button" onclick="showAdvisorTab('jobcards')">Job Cards</button>
            <button class="tabbtn" type="button" onclick="showAdvisorTab('assignments')">Assignments</button>
            <button class="tabbtn" type="button" onclick="showAdvisorTab('team')">Team</button>
            <button class="tabbtn" type="button" onclick="showAdvisorTab('parts')">Parts</button>
            <button class="tabbtn" type="button" onclick="showAdvisorTab('reports')">Reports</button>
        </div>

        <div id="advisorTab-jobcards" class="advisor-tab-panel active">
        <div class="section">
            <h2>Job Cards</h2>
            <div class="filter-bar">
                <button class="btn-primary" onclick="openCreateJobCardModal()">+ Create New Job Card</button>
                <div class="filter-group">
                    <div class="filter-item">
                        <label for="filterLocation">Location</label>
                        <select id="filterLocation" onchange="loadJobCards()">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filterJobType">Job Type</label>
                        <select id="filterJobType" onchange="loadJobCards()">
                            <option value="">All Job Types</option>
                            <option value="Mechanical">Mechanical</option>
                            <option value="Electrical">Electrical</option>
                            <option value="Body Shop">Body Shop</option>
                            <option value="Diagnostics">Diagnostics</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filterStatus">Status</label>
                        <select id="filterStatus" onchange="loadJobCards()">
                            <option value="">All Statuses</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filterAssigned">Assigned</label>
                        <select id="filterAssigned" onchange="loadJobCards()">
                            <option value="">All</option>
                            <option value="assigned">Assigned</option>
                            <option value="unassigned">Unassigned</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="filterDatePreset">Date</label>
                        <select id="filterDatePreset" onchange="onJobCardsDatePresetChange()">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="filter-item" id="filterDateFromWrap" style="display:none;">
                        <label for="filterDateFrom">From</label>
                        <input type="date" id="filterDateFrom" onchange="loadJobCards()">
                    </div>
                    <div class="filter-item" id="filterDateToWrap" style="display:none;">
                        <label for="filterDateTo">To</label>
                        <input type="date" id="filterDateTo" onchange="loadJobCards()">
                    </div>
                    <div class="filter-item" style="min-width: 220px;">
                        <label for="filterAsset">Search</label>
                        <input type="text" id="filterAsset" placeholder="Search by asset / job # / customer..." onkeyup="loadJobCards()">
                    </div>
                    <div class="filter-item" style="min-width: 120px;">
                        <label>&nbsp;</label>
                        <button class="btn" type="button" onclick="resetJobCardFilters()" style="background:#6c757d; color:white; border:none;">Clear</button>
                    </div>
                </div>
            </div>
            <div id="jobCardsList" style="margin-top: 20px;">Loading...</div>
        </div>
        </div>

        <!-- Create Job Card Modal -->
        <div id="createJobCardModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="createJobCardModalTitle">Create New Job Card</h2>
                    <span class="close" onclick="closeCreateJobCardModal()">&times;</span>
                </div>
                <form id="createJobCardForm" novalidate>
                    <input type="hidden" id="edit_job_card_id">
                    <div class="accordion-tools">
                        <div class="hint"><strong>Tip:</strong> Expand only what you need to reduce scrolling.</div>
                        <div style="display:flex; gap:10px;">
                            <button type="button" class="btn" onclick="expandAllJobCardSections()">Expand all</button>
                            <button type="button" class="btn" onclick="collapseAllJobCardSections()">Collapse all</button>
                        </div>
                    </div>

                    <div class="modal-body-scroll" id="createJobCardScroll">
                        <div class="acc-section open" data-acc="job">
                            <button type="button" class="acc-header" onclick="toggleJobCardSection('job')">
                                <div>Job Basics <span class="sub">Job # + Customer</span></div>
                                <div class="sub">Toggle</div>
                            </button>
                            <div class="acc-body">
                                <div class="form-group">
                                    <label for="job_number">Job Number *</label>
                                    <input type="text" id="job_number" name="job_number" required placeholder="e.g., JC-2024-001">
                                    <div class="error-msg" id="job_number_error"></div>
                                </div>
                                <div class="form-group">
                                    <label for="customer_name">Company Name</label>
                                    <input type="text" id="customer_name" name="customer_name" placeholder="Company name">
                                </div>
                                <div class="form-group" id="customer_email_group" style="display: none;">
                                    <label for="customer_email">Email</label>
                                    <input type="email" id="customer_email" name="customer_email" placeholder="customer@example.com">
                                </div>
                                <div class="form-group" id="customer_phone_group" style="display: none;">
                                    <label for="customer_phone">Phone Number</label>
                                    <input type="tel" id="customer_phone" name="customer_phone" placeholder="+1 234 567 8900">
                                </div>
                                <div class="form-group" id="customer_address_group" style="display: none;">
                                    <label for="customer_address">Address</label>
                                    <textarea id="customer_address" name="customer_address" rows="2" placeholder="Customer address"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="acc-section" data-acc="vehicle">
                            <button type="button" class="acc-header" onclick="toggleJobCardSection('vehicle')">
                                <div>Vehicle / Motorcycle / Plate <span class="sub">Make/Model/Plate + History</span></div>
                                <div class="sub">Toggle</div>
                            </button>
                            <div class="acc-body">
                                <div class="form-group">
                                    <label>Vehicle / Motorcycle Information</label>
                                    <div class="vehicle-info">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="vehicle_make">Make</label>
                                                <input type="text" id="vehicle_make" name="vehicle_make" placeholder="e.g., Toyota / Yamaha">
                                            </div>
                                            <div class="form-group">
                                                <label for="vehicle_model">Model</label>
                                                <input type="text" id="vehicle_model" name="vehicle_model" placeholder="e.g., Camry / R1">
                                            </div>
                                        </div>
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="vehicle_year">Year</label>
                                                <input type="number" id="vehicle_year" name="vehicle_year" placeholder="e.g., 2020" min="1900" max="2100">
                                            </div>
                                            <div class="form-group">
                                                <label for="vehicle_vin">VIN / Chassis Number</label>
                                                <input type="text" id="vehicle_vin" name="vehicle_vin" placeholder="VIN / Chassis number">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="vehicle_license">Plate Number</label>
                                            <input type="text" id="vehicle_license" name="vehicle_license" placeholder="License plate number">
                                            <div id="plateHistoryBox" style="margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; display: none;">
                                                <div style="font-weight: 800; color:#333; margin-bottom: 6px;">Previous Bike Condition / Complaints</div>
                                                <div id="plateHistoryContent" style="color:#666; font-size:0.9em;"></div>
                                            </div>
                                        </div>
                                        <div class="form-group" id="vehicle_odometer_group" style="display: none;">
                                            <label for="vehicle_odometer">Odometer Reading</label>
                                            <input type="number" id="vehicle_odometer" name="vehicle_odometer" placeholder="e.g., 50000" min="0">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="acc-section open" data-acc="work">
                            <button type="button" class="acc-header" onclick="toggleJobCardSection('work')">
                                <div>Work Details <span class="sub">Work Type + Complaint + Condition</span></div>
                                <div class="sub">Toggle</div>
                            </button>
                            <div class="acc-body">
                                <div class="form-group">
                                    <label for="work_type">Work Type</label>
                                    <select id="work_type" name="work_type">
                                        <option value="">Select work type...</option>
                                    </select>
                                    <small style="color: #666; display: block; margin-top: 5px;">Type of work to be performed</small>
                                </div>
                                <div class="form-group" id="problem_description_group">
                                    <label for="problem_description">Complaint / Rider Issue</label>
                                    <textarea id="problem_description" name="problem_description" rows="4" placeholder="Describe the complaint / rider issue..."></textarea>
                                    <small style="color: #666; display: block; margin-top: 5px;">Customer complaint / rider issue</small>
                                </div>
                                <div class="form-group" id="bike_condition_review_group">
                                    <label for="bike_condition_review">Bike Condition Review</label>
                                    <textarea id="bike_condition_review" name="bike_condition_review" rows="3" placeholder="Quick check of current bike condition..."></textarea>
                                    <small style="color: #666; display: block; margin-top: 5px;">Record current condition (visible in plate history)</small>
                                </div>
                                <div class="form-group">
                                    <label for="priority">Priority</label>
                                    <select id="priority" name="priority">
                                        <option value="1">1 - Critical</option>
                                        <option value="2">2 - High</option>
                                        <option value="3" selected>3 - Medium</option>
                                        <option value="4">4 - Low</option>
                                        <option value="5">5 - Very Low</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="estimated_hours">Estimated Hours</label>
                                    <input type="number" id="estimated_hours" name="estimated_hours" step="0.5" min="0" placeholder="e.g., 1.5">
                                </div>
                            </div>
                        </div>

                        <div class="acc-section open" data-acc="assignment">
                            <button type="button" class="acc-header" onclick="toggleJobCardSection('assignment')">
                                <div>Location & Linking <span class="sub">Location/Job Type/Asset + Previous Job</span></div>
                                <div class="sub">Toggle</div>
                            </button>
                            <div class="acc-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="location_id">Location</label>
                                        <select id="location_id" name="location_id">
                                            <option value="">Select location...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="job_type">Job Type</label>
                                        <select id="job_type" name="job_type">
                                            <option value="">Select job type...</option>
                                            <!-- Job types will be loaded dynamically from Business Unit -->
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="asset_id">Asset/Vehicle</label>
                                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                                        <select id="asset_id" name="asset_id" style="flex: 1;">
                                            <option value="">Select asset or scan barcode...</option>
                                        </select>
                                        <button type="button" class="btn" onclick="openBarcodeScanner('asset')" style="background: #17a2b8; color: white; padding: 10px 15px;">
                                            üì∑ Scan Barcode
                                        </button>
                                    </div>
                                    <div style="margin-top: 8px; display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
                                        <div style="flex:1; min-width:260px;">
                                            <label for="asset_identifier" style="font-size:0.9em; color:#666;">Find by Plate / Asset Tag / Serial / Barcode</label>
                                            <input type="text" id="asset_identifier" placeholder="Type identifier and press Find..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px;">
                                        </div>
                                        <button type="button" class="btn" onclick="findAssetByIdentifier()" style="background:#6c757d; color:white; padding:10px 15px;">üîé Find</button>
                                    </div>
                                    <div id="assetIdentifierStatus" style="margin-top:6px; color:#666; font-size:0.85em;"></div>
                                    <small style="color: #666; display: block; margin-top: 5px;">You can select from the dropdown, scan barcode/QR, or search by identifier.</small>
                                </div>
                                <div class="form-group">
                                    <label for="parent_work_order_id">Parent Work Order (Optional)</label>
                                    <select id="parent_work_order_id" name="parent_work_order_id">
                                        <option value="">None (Standalone job)</option>
                                    </select>
                                    <small style="color: #666; display: block; margin-top: 5px;">Link to a parent work order for sequential jobs</small>
                                </div>
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label for="job_category">Job Category</label>
                                        <select id="job_category" name="job_category">
                                            <option value="service" selected>Service</option>
                                            <option value="complaint">Complaint</option>
                                        </select>
                                        <small style="color: #666; display: block; margin-top: 5px;">Classify as Service or Complaint.</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="previous_job_number">Previous Job Card Number (Optional)</label>
                                        <div style="display:flex; gap:10px; align-items:flex-end;">
                                            <input type="text" id="previous_job_number" placeholder="e.g., JC 2026-001" style="flex:1;">
                                            <button type="button" class="btn" onclick="linkPreviousJobCard()" style="background:#6c757d; color:white;">Link</button>
                                        </div>
                                        <input type="hidden" id="previous_job_card_id">
                                        <div id="previousJobLinkStatus" style="margin-top:6px; color:#666; font-size:0.85em;"></div>
                                        <div id="previousJobSummaryBox" style="margin-top:10px; padding:10px; background:#f8f9fa; border:1px solid #eee; border-radius:8px; display:none;">
                                            <div style="font-weight:800; color:#333; margin-bottom:6px;">Previous Job Summary</div>
                                            <div id="previousJobSummaryContent" style="color:#666; font-size:0.9em;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="acc-section" data-acc="notes">
                            <button type="button" class="acc-header" onclick="toggleJobCardSection('notes')">
                                <div>Notes <span class="sub">Optional</span></div>
                                <div class="sub">Toggle</div>
                            </button>
                            <div class="acc-body">
                                <div class="form-group">
                                    <label for="notes">Notes</label>
                                    <textarea id="notes" name="notes" rows="3" placeholder="Additional notes..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer-sticky">
                        <button type="button" class="btn" onclick="closeCreateJobCardModal()">Cancel</button>
                        <button type="button" class="btn" id="createJobCardPartsBtn" onclick="openPartsForCurrentJobCard()" style="background:#6f42c1; color:white; border:none;" title="Save the job card first to add parts">üîß Manage Parts</button>
                        <button type="submit" class="btn-submit" id="submitBtn">Create Job Card</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="advisorTab-assignments" class="advisor-tab-panel">
        <div class="section">
            <h2>Assignments</h2>
            <div id="assignmentsList">Loading...</div>
        </div>
        </div>

        <div id="advisorTab-team" class="advisor-tab-panel">
        <div class="section">
            <h2>üë• Team Management</h2>
            <button class="btn-primary" onclick="openAddTechnicianModal()" style="margin-bottom: 20px;">+ Add New Technician</button>
            <div id="techniciansList">Loading...</div>
        </div>
        </div>

        <div id="advisorTab-parts" class="advisor-tab-panel">
        <div class="section">
            <h2>üîß Parts Inventory</h2>
            <button class="btn-primary" onclick="openAddPartModal()" style="margin-bottom: 20px;">+ Add New Part</button>
            <div style="margin-bottom: 15px;">
                <input type="text" id="searchParts" placeholder="Search parts by name or number..." onkeyup="loadPartsInventory()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; width: 300px;">
            </div>
            <div id="partsInventoryList">Loading...</div>
        </div>
        </div>

        <div id="advisorTab-reports" class="advisor-tab-panel">
        <div class="section">
            <h2>Reports</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn-primary" onclick="openReportModal()">üìä Generate Report</button>
            <button class="btn" style="background: #fd7e14; color: white;" onclick="loadTechnicianEfficiencyReport()">üìä Technician KPIs (Job Efficiency & Utilization)</button>
                <button class="btn" style="background: #17a2b8; color: white;" onclick="loadAssetUtilizationReport()">üìà Asset Utilization</button>
                <button class="btn" style="background: #6f42c1; color: white;" onclick="loadPartsConsumptionReport()">üîß Parts Consumption</button>
                <button class="btn" style="background: #20c997; color: white;" onclick="loadLocationWorkloadReport()">üìç Location Workload</button>
            </div>
            <div id="reportResults" style="margin-top: 20px; display: none;">
                <div id="reportSummary"></div>
                <div id="reportData"></div>
            </div>
        </div>
        </div>
    </div>

    <button class="btn floating-top" id="scrollTopBtn" type="button" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" style="background:#343a40; color:white; border:none;">‚Üë Top</button>

    <!-- Assign Technician Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Technician</h3>
                <span class="close" onclick="closeAssignModal()">&times;</span>
            </div>
            <form id="assignForm">
                <input type="hidden" id="assignJobCardId">
                <div class="form-group">
                    <label>Job Card:</label>
                    <div id="assignJobCardInfo" style="padding: 10px; background: #f5f5f5; border-radius: 5px; margin-bottom: 10px;"></div>
                </div>
                <div class="form-group">
                    <label for="technicianSelect">Technician: <span style="color: red;">*</span></label>
                    <select id="technicianSelect" required>
                        <option value="">Loading technicians...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assignNotes">Notes (optional):</label>
                    <textarea id="assignNotes" placeholder="Add any notes about this assignment..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeAssignModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Assign</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generate Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Generate Report</h3>
                <span class="close" onclick="closeReportModal()">&times;</span>
            </div>
            <form id="reportForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportPeriod">Period: <span style="color: red;">*</span></label>
                        <select id="reportPeriod" name="period" required onchange="updateDateRange()">
                            <option value="day">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportTechnician">Technician (optional):</label>
                        <select id="reportTechnician" name="technician_id">
                            <option value="">All Technicians</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="customDateRange" style="display: none;">
                    <div class="form-group">
                        <label for="reportFrom">From Date: <span style="color: red;">*</span></label>
                        <input type="date" id="reportFrom" name="from">
                    </div>
                    <div class="form-group">
                        <label for="reportTo">To Date: <span style="color: red;">*</span></label>
                        <input type="date" id="reportTo" name="to">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeReportModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
                    <button type="submit" class="btn-primary">Generate Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reassign Technician Modal -->
    <div id="reassignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Reassign Technician</h3>
                <span class="close" onclick="closeReassignModal()">&times;</span>
            </div>
            <form id="reassignForm">
                <input type="hidden" id="reassignAssignmentId">
                <input type="hidden" id="reassignJobCardId">
                <input type="hidden" id="reassignCurrentTechnicianId">
                <div class="form-group">
                    <label>Job Card:</label>
                    <div id="reassignJobCardInfo" style="padding: 10px; background: #f5f5f5; border-radius: 5px; margin-bottom: 10px;"></div>
                </div>
                <div class="form-group">
                    <label>Current Technician:</label>
                    <div id="reassignCurrentTechnician" style="padding: 10px; background: #fff3cd; border-radius: 5px; margin-bottom: 10px; color: #856404;"></div>
                </div>
                <div class="form-group">
                    <label for="reassignTechnicianSelect">New Technician: <span style="color: red;">*</span></label>
                    <select id="reassignTechnicianSelect" required>
                        <option value="">Loading technicians...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reassignReason">Reason for Reassignment: <span style="color: red;">*</span></label>
                    <textarea id="reassignReason" required placeholder="e.g., Emergency, Technician unavailable, Priority change..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="reassignNotes">Additional Notes (optional):</label>
                    <textarea id="reassignNotes" placeholder="Add any additional notes..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeReassignModal()">Cancel</button>
                    <button type="submit" class="btn-primary" style="background: #ffc107; color: #000;">Reassign</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Technician Modal -->
    <div id="technicianModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="technicianModalTitle">Add New Technician</h2>
                <span class="close" onclick="closeTechnicianModal()">&times;</span>
            </div>
            <form id="technicianForm">
                <input type="hidden" id="technicianUserId">
                <div class="form-group">
                    <label for="technicianName">Full Name *</label>
                    <input type="text" id="technicianName" required placeholder="e.g., Ahmed Mohammed">
                </div>
                <div class="form-group">
                    <label for="technicianEmail">Email *</label>
                    <input type="email" id="technicianEmail" required placeholder="e.g., ahmed@example.com">
                </div>
                <div class="form-group">
                    <label for="technicianLocation">Home Location</label>
                    <select id="technicianLocation">
                        <option value="">Select location...</option>
                    </select>
                    <small style="color:#666;">Used for reporting when the technician has no jobs in the selected period.</small>
                </div>
                <div class="form-group">
                    <label for="technicianPassword">Password *</label>
                    <input type="password" id="technicianPassword" minlength="12" placeholder="Minimum 12 characters">
                    <small style="color: #666;">Leave blank when editing to keep current password</small>
                </div>
                <div class="form-group">
                    <label for="technicianEmployeeCode">Employee Code *</label>
                    <input type="text" id="technicianEmployeeCode" required placeholder="e.g., TECH001">
                </div>
                <div class="form-group">
                    <label for="technicianTrade">Trade/Specialty</label>
                    <input type="text" id="technicianTrade" placeholder="e.g., Mechanical, Electrical">
                </div>
                <div class="form-group">
                    <label>Hourly Rate</label>
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                        <input type="text" id="technicianHourlyRateCurrency" list="currencyCodes" value="AED" placeholder="AED" style="width: 90px;">
                        <input type="number" id="technicianHourlyRate" step="0.01" min="0" placeholder="e.g., 25.00" style="flex:1; min-width: 160px;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="technicianMaxJobs">Max Concurrent Jobs</label>
                    <input type="number" id="technicianMaxJobs" min="1" value="3" required>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="technicianActive" checked style="width: auto;">
                        <span>Active (Can be assigned to jobs)</span>
                    </label>
                </div>

                <div class="form-group" style="margin-top: 10px;">
                    <label><strong>Weekly Shift Schedule (Planned Hours)</strong></label>
                    <small style="color:#666; display:block; margin-top:4px;">
                        Set expected working hours per day. This is used for planning and performance analysis when clock-in/out data is missing.
                    </small>
                    <div id="techScheduleGrid" style="margin-top: 10px; display: grid; grid-template-columns: 110px 1fr 1fr; gap: 10px; align-items: center;">
                        <!-- populated by JS -->
                    </div>
                    <div style="margin-top: 8px; color:#666; font-size:0.85em;">
                        Timezone: <select id="techScheduleTimezone" style="padding:6px; border:1px solid #ddd; border-radius:6px;">
                            <option value="Asia/Dubai">Asia/Dubai</option>
                            <option value="Asia/Riyadh">Asia/Riyadh</option>
                            <option value="UTC">UTC</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeTechnicianModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Save Technician</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Part Modal -->
    <div id="partModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="partModalTitle">Add New Part</h2>
                <span class="close" onclick="closePartModal()">&times;</span>
            </div>
            <form id="partForm">
                <input type="hidden" id="partId">
                <div class="form-group">
                    <label for="partName">Part Name *</label>
                    <input type="text" id="partName" required placeholder="e.g., Brake Pad Set">
                </div>
                <div class="form-group">
                    <label for="partNumber">Part Number *</label>
                    <input type="text" id="partNumber" required placeholder="e.g., BP-001">
                </div>
                <div class="form-group">
                    <label for="partDescription">Description</label>
                    <textarea id="partDescription" rows="3" placeholder="Part description..."></textarea>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Unit Cost *</label>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <input type="text" id="partCurrency" list="currencyCodes" value="AED" placeholder="AED" style="width: 90px;">
                            <input type="number" id="partCost" step="0.01" min="0" required placeholder="0.00" style="flex:1; min-width: 160px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="partQuantity">Stock Quantity</label>
                        <input type="number" id="partQuantity" min="0" value="0" placeholder="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="partCategory">Category</label>
                    <input type="text" id="partCategory" placeholder="e.g., Brakes, Engine, Electrical">
                </div>
                <div class="form-group">
                    <label for="partBarcode">Barcode</label>
                    <input type="text" id="partBarcode" placeholder="Barcode for scanning">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="partActive" checked style="width: auto;">
                        <span>Active (Available for use)</span>
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closePartModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Save Part</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Job History Modal -->
    <div id="jobHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Job History</h3>
                <span class="close" onclick="closeJobHistoryModal()">&times;</span>
            </div>
            <div id="jobHistoryContent" style="max-height: 600px; overflow-y: auto;"></div>
            <div class="form-actions">
                <button type="button" class="btn" onclick="closeJobHistoryModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Work Order Parts Modal -->
    <div id="workOrderPartsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3>Work Order Parts - <span id="workOrderPartsJobNumber"></span></h3>
                <span class="close" onclick="closeWorkOrderPartsModal()">&times;</span>
            </div>
            <input type="hidden" id="workOrderPartsId">
            <div id="workOrderPartsList" style="margin-bottom: 20px;"></div>
            <div style="border-top: 2px solid #f0f0f0; padding-top: 20px; margin-top: 20px;">
                <h4>Add Part</h4>
                <form id="addPartForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="partSelect">Part: <span style="color: red;">*</span></label>
                            <select id="partSelect" required>
                                <option value="">Loading parts...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="partQuantity">Quantity:</label>
                            <input type="number" id="partQuantity" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="partUnitCost">Unit Cost ($):</label>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <input type="text" id="partUnitCurrency" list="currencyCodes" value="AED" placeholder="AED" style="width: 90px;">
                            <input type="number" id="partUnitCost" step="0.01" min="0" required style="flex:1; min-width: 160px;">
                        </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="partNotes">Notes (optional):</label>
                        <textarea id="partNotes" rows="2"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-primary" onclick="addPartToWorkOrder()">Add Part</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Asset Movements Modal -->
    <div id="assetMovementsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Asset Movements</h3>
                <span class="close" onclick="closeAssetMovementsModal()">&times;</span>
            </div>
            <div id="assetMovementsContent" style="max-height: 600px; overflow-y: auto;"></div>
            <div class="form-actions">
                <button type="button" class="btn" onclick="closeAssetMovementsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Currency codes (extend anytime) -->
    <datalist id="currencyCodes">
        <option value="AED"></option>
        <option value="USD"></option>
        <option value="SAR"></option>
        <option value="QAR"></option>
        <option value="KWD"></option>
        <option value="BHD"></option>
        <option value="OMR"></option>
        <option value="EUR"></option>
        <option value="GBP"></option>
        <option value="INR"></option>
        <option value="PKR"></option>
    </datalist>

    <script src="branding.js"></script>
    <script>
        const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE_URL = isLocalDev ? 'http://localhost:3000/api/v1' : '/api/v1';
        let accessToken = localStorage.getItem('access_token');
        let refreshToken = localStorage.getItem('refresh_token');
        let user = JSON.parse(localStorage.getItem('user') || '{}');
        let userBusinessUnitId = null;

        // Check if user is logged in
        if (!accessToken || !user.id) {
            window.location.href = 'index.html';
        }

        // Initialize business unit ID from user object
        if (user.business_unit_id) {
            userBusinessUnitId = user.business_unit_id;
        }

        // Load user's business unit ID if not already set
        async function loadBusinessUnitId() {
            if (!userBusinessUnitId) {
                try {
                    const response = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await response.json();
                    if (response.ok && userData.business_unit_id) {
                        userBusinessUnitId = userData.business_unit_id;
                        console.log('Business Unit ID loaded:', userBusinessUnitId);
                    } else {
                        console.warn('User is not assigned to any Business Unit - showing all data');
                    }
                } catch (error) {
                    console.error('Error loading business unit:', error);
                }
            }
            return true;
        }

        // Helper function to add business unit filter to URLs (OPTIONAL)
        function addBusinessUnitFilter(url) {
            if (!userBusinessUnitId) {
                console.log('No business unit filter - user may not be assigned to a BU');
                return url;
            }
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}business_unit_id=${userBusinessUnitId}`;
        }

        // Function to refresh access token
        async function refreshAccessToken() {
            try {
                if (!refreshToken) {
                    throw new Error('No refresh token available');
                }

                const response = await fetch(`${API_BASE_URL}/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh_token: refreshToken
                    })
                });

                const data = await response.json();

                if (response.ok && data.access_token) {
                    accessToken = data.access_token;
                    localStorage.setItem('access_token', accessToken);
                    return accessToken;
                } else {
                    throw new Error(data.error?.message || 'Token refresh failed');
                }
            } catch (error) {
                console.error('Token refresh error:', error);
                // Redirect to login if refresh fails
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user');
                window.location.href = 'index.html';
                throw error;
            }
        }

        // ------------------------
        // Currency helpers (ISO 4217 codes like AED, USD; extensible)
        // ------------------------
        function normalizeCurrencyCode(code) {
            const v = String(code || '').trim().toUpperCase();
            if (!v) return 'AED';
            // Keep it permissive: allow any 3-letter code so future currencies work without code changes
            return v.slice(0, 3);
        }

        function formatMoney(amount, currencyCode) {
            const code = normalizeCurrencyCode(currencyCode);
            const num = Number(amount || 0);
            try {
                return new Intl.NumberFormat(undefined, { style: 'currency', currency: code }).format(num);
            } catch {
                // Fallback if browser doesn't recognize the code
                return `${code} ${num.toFixed(2)}`;
            }
        }

        // ------------------------
        // Advisor dashboard tabs
        // ------------------------
        function showAdvisorTab(key) {
            const panels = Array.from(document.querySelectorAll('.advisor-tab-panel'));
            panels.forEach(p => p.classList.remove('active'));
            const activePanel = document.getElementById(`advisorTab-${key}`);
            if (activePanel) activePanel.classList.add('active');

            const buttons = Array.from(document.querySelectorAll('#advisorTabbar .tabbtn'));
            buttons.forEach(b => b.classList.remove('active'));
            const btn = buttons.find(b => (b.getAttribute('onclick') || '').includes(`'${key}'`));
            if (btn) btn.classList.add('active');

            try { localStorage.setItem('advisor_active_tab', key); } catch {}
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function initAdvisorTabs() {
            let key = 'jobcards';
            try {
                const saved = localStorage.getItem('advisor_active_tab');
                if (saved) key = saved;
            } catch {}
            showAdvisorTab(key);

            // Show floating top button after some scroll
            const topBtn = document.getElementById('scrollTopBtn');
            window.addEventListener('scroll', () => {
                if (!topBtn) return;
                topBtn.style.display = window.scrollY > 700 ? 'inline-block' : 'none';
            });
        }

        // Wrapper for fetch that handles token refresh automatically
        async function apiFetch(url, options = {}) {
            // Add authorization header if not present
            if (!options.headers) {
                options.headers = {};
            }
            if (!options.headers['Authorization']) {
                options.headers['Authorization'] = `Bearer ${accessToken}`;
            }
            if (!options.headers['Content-Type']) {
                options.headers['Content-Type'] = 'application/json';
            }

            // Make the request
            let response = await fetch(url, options);

            // If token expired, try to refresh and retry
            if (response.status === 401) {
                const errorData = await response.json().catch(() => ({}));
                if (errorData.error?.code === 'TOKEN_EXPIRED') {
                    try {
                        // Refresh token
                        await refreshAccessToken();
                        
                        // Update authorization header with new token
                        options.headers['Authorization'] = `Bearer ${accessToken}`;
                        
                        // Retry the original request
                        response = await fetch(url, options);
                    } catch (refreshError) {
                        // Refresh failed, redirect to login
                        return response; // Will trigger redirect in refreshAccessToken
                    }
                }
            }

            return response;
        }

        // Display user info
        document.getElementById('userDisplay').innerHTML = `
            <span>${user.display_name} (<span class="badge" style="background: var(--brand-primary); color: white;">Service Advisor</span>)</span>
        `;

        // Load job cards
        async function loadJobCards() {
            try {
                // Build query string with filters
                const filters = [];
                
                // Add business unit filter only if user has one
                if (userBusinessUnitId) {
                    filters.push(`business_unit_id=${userBusinessUnitId}`);
                }
                
                const locationFilter = document.getElementById('filterLocation')?.value;
                const jobTypeFilter = document.getElementById('filterJobType')?.value;
                const assetFilter = document.getElementById('filterAsset')?.value;
                const statusFilter = document.getElementById('filterStatus')?.value;
                const assignedFilter = document.getElementById('filterAssigned')?.value;
                const datePreset = document.getElementById('filterDatePreset')?.value;
                const dateFrom = document.getElementById('filterDateFrom')?.value;
                const dateTo = document.getElementById('filterDateTo')?.value;
                
                if (locationFilter) filters.push(`location_id=${locationFilter}`);
                if (jobTypeFilter) filters.push(`job_type=${encodeURIComponent(jobTypeFilter)}`);
                if (assetFilter) filters.push(`search=${encodeURIComponent(assetFilter)}`);
                
                const queryString = filters.length > 0 ? '?' + filters.join('&') : '';
                console.log('Loading job cards with URL:', `${API_BASE_URL}/jobcards${queryString}`);
                const response = await apiFetch(`${API_BASE_URL}/jobcards${queryString}`);
                const data = await response.json();
                console.log('Job cards response:', data);
                
                const rows = Array.isArray(data.data) ? data.data : [];
                const filtered = applyAdvisorJobCardsClientFilters(rows, {
                    status: statusFilter,
                    assigned: assignedFilter,
                    datePreset,
                    dateFrom,
                    dateTo,
                    search: assetFilter
                });

                // Populate status dropdown dynamically from actual data (and keep selection)
                populateJobCardsStatusFilter(rows, statusFilter);

                if (filtered.length > 0) {
                    document.getElementById('totalJobCards').textContent = filtered.length;
                    let html = `
                        <div class="jobcards-table-wrap">
                            <table class="jobcards-table">
                                <tr>
                                    <th class="jobcards-col-job">Job Number</th>
                                    <th class="jobcards-col-customer">Customer</th>
                                    <th class="jobcards-col-asset">Asset</th>
                                    <th>Location</th>
                                    <th>Job Type</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Assigned To</th>
                                    <th>Time Spent</th>
                                    <th class="jobcards-col-actions">Actions</th>
                                </tr>
                    `;
                    filtered.forEach(job => {
                        const assigned = job.assignments && job.assignments.length > 0 
                            ? job.assignments.map(a => a.technician_name).join(', ')
                            : 'Unassigned';
                        const hasAssignment = job.assignments && job.assignments.length > 0;
                        const assignmentId = hasAssignment && job.assignments[0] ? job.assignments[0].id : null;
                        const currentTechnicianId = hasAssignment && job.assignments[0] ? job.assignments[0].technician_id : null;
                        const timeSpent = job.total_time_formatted || (job.actual_hours ? `${parseFloat(job.actual_hours).toFixed(1)}h` : '-');
                        const timeDisplay = job.status === 'completed' && timeSpent !== '-' 
                            ? `<span style="color: #28a745; font-weight: bold;">${timeSpent}</span>` 
                            : timeSpent;
                        const assetInfo = job.asset_name ? `${job.asset_name}${job.asset_tag ? ' (' + job.asset_tag + ')' : ''}` : '-';
                        const locationInfo = job.location_name || '-';
                        const jobTypeInfo = job.job_type || '-';
                        const dateText = formatJobCardDate(job);
                        html += `
                            <tr>
                                <td class="jobcards-col-job">
                                    <div style="font-weight:800; color:#333;">${job.job_number}</div>
                                    ${dateText ? `<div class="cell-muted">${dateText}</div>` : ''}
                                </td>
                                <td>${job.customer_name}</td>
                                <td>${assetInfo}</td>
                                <td>${locationInfo}</td>
                                <td>${jobTypeInfo}</td>
                                <td><span class="badge ${job.status}">${job.status}</span></td>
                                <td>${job.priority}</td>
                                <td>${assigned}</td>
                                <td>${timeDisplay}</td>
                                <td class="jobcards-col-actions">
                                    <div class="jobcards-actions">
                                        <button class="btn" style="background:#343a40; color:white; padding: 5px 10px; font-size: 0.85em;" onclick="openEditJobCardModal(${job.id})" title="Edit Job Card">‚úèÔ∏è Edit</button>
                                        ${!hasAssignment ? 
                                            `<button class="btn-assign" onclick="openAssignModal(${job.id}, '${job.job_number}', '${job.customer_name}')">Assign</button>` :
                                            `<button class="btn-reassign" onclick="openReassignModal(${assignmentId}, ${job.id}, '${job.job_number}', '${job.customer_name}', '${currentTechnicianId}')">Reassign</button>`
                                        }
                                        <button class="btn" style="background: #17a2b8; color: white; padding: 5px 10px; font-size: 0.85em;" onclick="viewJobHistory(${job.id}, '${job.job_number}')" title="View Job History">üìã History</button>
                                        <button class="btn" style="background: #6f42c1; color: white; padding: 5px 10px; font-size: 0.85em;" onclick="viewWorkOrderParts(${job.id}, '${job.job_number}')" title="View/Manage Parts">üîß Parts</button>
                                        ${job.asset_id ? `<button class="btn" style="background: #fd7e14; color: white; padding: 5px 10px; font-size: 0.85em;" onclick="viewAssetMovements(${job.asset_id}, '${job.asset_name || 'Asset'}')" title="View Asset Movements">üöö Movements</button>` : ''}
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</table></div>';
                    document.getElementById('jobCardsList').innerHTML = html;
                } else {
                    document.getElementById('totalJobCards').textContent = '0';
                    document.getElementById('jobCardsList').innerHTML = '<p>No job cards found.</p>';
                }
            } catch (error) {
                console.error('Error loading job cards:', error);
                document.getElementById('totalJobCards').textContent = '0';
                document.getElementById('jobCardsList').innerHTML = '<p style="color: red;">Error loading job cards: ' + error.message + '</p>';
            }
        }

        function safeLower(v) {
            return String(v || '').toLowerCase().trim();
        }

        function formatJobCardDate(job) {
            const raw = job?.created_at || job?.createdAt || job?.created || job?.date_created || job?.updated_at || job?.updatedAt || null;
            if (!raw) return '';
            const d = new Date(raw);
            if (isNaN(d.getTime())) return '';
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function populateJobCardsStatusFilter(allRows, selected) {
            const el = document.getElementById('filterStatus');
            if (!el) return;
            const statuses = Array.from(new Set((allRows || []).map(r => safeLower(r?.status)).filter(Boolean))).sort();
            const keep = String(selected || '');
            const options = ['<option value="">All Statuses</option>']
                .concat(statuses.map(s => `<option value="${s}">${s.replaceAll('_',' ')}</option>`));
            el.innerHTML = options.join('');
            if (keep) el.value = keep;
        }

        function applyAdvisorJobCardsClientFilters(rows, opts) {
            const status = safeLower(opts?.status);
            const assigned = safeLower(opts?.assigned);
            const preset = safeLower(opts?.datePreset);
            const search = safeLower(opts?.search);
            const from = opts?.dateFrom ? new Date(opts.dateFrom + 'T00:00:00') : null;
            const to = opts?.dateTo ? new Date(opts.dateTo + 'T23:59:59') : null;

            const now = new Date();
            let presetFrom = null;
            let presetTo = null;
            if (preset === 'today') {
                presetFrom = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                presetTo = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
            } else if (preset === 'week') {
                const day = now.getDay(); // 0=Sun
                const mondayOffset = (day + 6) % 7;
                presetFrom = new Date(now.getFullYear(), now.getMonth(), now.getDate() - mondayOffset, 0, 0, 0);
                presetTo = new Date(presetFrom.getFullYear(), presetFrom.getMonth(), presetFrom.getDate() + 6, 23, 59, 59);
            } else if (preset === 'month') {
                presetFrom = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
                presetTo = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            } else if (preset === 'custom') {
                presetFrom = from;
                presetTo = to;
            }

            return (rows || []).filter(job => {
                const hasAssign = Array.isArray(job.assignments) && job.assignments.length > 0;
                if (assigned === 'assigned' && !hasAssign) return false;
                if (assigned === 'unassigned' && hasAssign) return false;

                if (status && safeLower(job.status) !== status) return false;

                if (search) {
                    const hay = [
                        job.job_number,
                        job.customer_name,
                        job.asset_name,
                        job.asset_tag,
                        job.location_name,
                        job.job_type,
                        hasAssign ? job.assignments.map(a => a.technician_name).join(' ') : ''
                    ].map(safeLower).join(' | ');
                    if (!hay.includes(search)) return false;
                }

                if (presetFrom && presetTo) {
                    const raw = job?.created_at || job?.createdAt || job?.created || job?.date_created || job?.updated_at || job?.updatedAt || null;
                    if (raw) {
                        const d = new Date(raw);
                        if (!isNaN(d.getTime())) {
                            if (d < presetFrom || d > presetTo) return false;
                        }
                    }
                }

                return true;
            });
        }

        function onJobCardsDatePresetChange() {
            const preset = document.getElementById('filterDatePreset')?.value || '';
            const fromWrap = document.getElementById('filterDateFromWrap');
            const toWrap = document.getElementById('filterDateToWrap');
            const showCustom = preset === 'custom';
            if (fromWrap) fromWrap.style.display = showCustom ? 'flex' : 'none';
            if (toWrap) toWrap.style.display = showCustom ? 'flex' : 'none';
            loadJobCards();
        }

        function resetJobCardFilters() {
            const ids = ['filterStatus','filterAssigned','filterDatePreset','filterDateFrom','filterDateTo','filterAsset','filterLocation','filterJobType'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                if (el.tagName === 'INPUT') el.value = '';
                else el.value = '';
            });
            const fromWrap = document.getElementById('filterDateFromWrap');
            const toWrap = document.getElementById('filterDateToWrap');
            if (fromWrap) fromWrap.style.display = 'none';
            if (toWrap) toWrap.style.display = 'none';
            loadJobCards();
        }

        // Load technicians for assignment dropdown
        async function loadTechnicians() {
            try {
                const url = addBusinessUnitFilter(`${API_BASE_URL}/technicians`);
                console.log('Loading technicians with URL:', url);
                console.log('Current userBusinessUnitId:', userBusinessUnitId);
                const response = await apiFetch(url);
                const data = await response.json();
                console.log('Technicians loaded:', data);
                
                const select = document.getElementById('technicianSelect');
                select.innerHTML = '<option value="">Select a technician...</option>';
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(tech => {
                        const option = document.createElement('option');
                        option.value = tech.user_id;
                        const displayName = tech.user?.display_name || tech.display_name;
                        option.textContent = `${displayName} (${tech.employee_code})${tech.active_assignments > 0 ? ' - ' + tech.active_assignments + ' active' : ''}`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No technicians available</option>';
                }
            } catch (error) {
                console.error('Error loading technicians:', error);
                document.getElementById('technicianSelect').innerHTML = '<option value="">Error loading technicians</option>';
            }
        }

        // Open assign modal
        function openAssignModal(jobCardId, jobNumber, customerName) {
            document.getElementById('assignJobCardId').value = jobCardId;
            document.getElementById('assignJobCardInfo').innerHTML = `
                <strong>${jobNumber}</strong> - ${customerName}
            `;
            document.getElementById('assignNotes').value = '';
            document.getElementById('assignModal').style.display = 'block';
            loadTechnicians();
        }

        // Close assign modal
        function closeAssignModal() {
            document.getElementById('assignModal').style.display = 'none';
            document.getElementById('assignForm').reset();
        }

        // Handle assign form submission
        document.getElementById('assignForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const jobCardId = document.getElementById('assignJobCardId').value;
            const technicianId = document.getElementById('technicianSelect').value;
            const notes = document.getElementById('assignNotes').value;

            if (!technicianId) {
                alert('Please select a technician');
                return;
            }

            const submitBtn = document.querySelector('#assignForm button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Assigning...';

            try {
                const response = await apiFetch(`${API_BASE_URL}/assignments`, {
                    method: 'POST',
                    body: JSON.stringify({
                        job_card_id: parseInt(jobCardId),
                        technician_id: technicianId,
                        notes: notes || null
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Technician assigned successfully!');
                    closeAssignModal();
                    loadJobCards();
                    loadAssignments();
                } else {
                    alert('Error: ' + (data.error?.message || 'Failed to assign technician'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Assign';
            }
        });

        // Open reassign modal
        function openReassignModal(assignmentId, jobCardId, jobNumber, customerName, currentTechnicianId) {
            document.getElementById('reassignAssignmentId').value = assignmentId;
            document.getElementById('reassignJobCardId').value = jobCardId;
            document.getElementById('reassignCurrentTechnicianId').value = currentTechnicianId;
            document.getElementById('reassignJobCardInfo').innerHTML = `
                <strong>${jobNumber}</strong> - ${customerName}
            `;
            
            // Get current technician name
            apiFetch(`${API_BASE_URL}/technicians/${currentTechnicianId}`)
            .then(async res => {
                if (!res.ok) {
                    throw new Error('Failed to load technician');
                }
                return res.json();
            })
            .then(tech => {
                document.getElementById('reassignCurrentTechnician').innerHTML = `
                    ${tech.user?.display_name || 'Unknown'} (${tech.employee_code || 'N/A'})
                `;
            })
            .catch(err => {
                document.getElementById('reassignCurrentTechnician').innerHTML = 'Loading...';
            });
            
            document.getElementById('reassignReason').value = '';
            document.getElementById('reassignNotes').value = '';
            document.getElementById('reassignModal').style.display = 'block';
            loadTechniciansForReassign(currentTechnicianId);
        }

        // Close reassign modal
        function closeReassignModal() {
            document.getElementById('reassignModal').style.display = 'none';
            document.getElementById('reassignForm').reset();
        }

        // Update date range based on period selection
        function updateDateRange() {
            const period = document.getElementById('reportPeriod').value;
            const customRange = document.getElementById('customDateRange');
            const fromInput = document.getElementById('reportFrom');
            const toInput = document.getElementById('reportTo');
            
            if (period === 'custom') {
                customRange.style.display = 'grid';
                fromInput.required = true;
                toInput.required = true;
            } else {
                customRange.style.display = 'none';
                fromInput.required = false;
                toInput.required = false;
                
                const today = new Date();
                let from, to;
                
                if (period === 'day') {
                    from = new Date(today);
                    to = new Date(today);
                } else if (period === 'week') {
                    const dayOfWeek = today.getDay();
                    const diff = today.getDate() - dayOfWeek;
                    from = new Date(today.setDate(diff));
                    to = new Date(today.setDate(diff + 6));
                } else if (period === 'month') {
                    from = new Date(today.getFullYear(), today.getMonth(), 1);
                    to = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                }
                
                fromInput.value = from.toISOString().split('T')[0];
                toInput.value = to.toISOString().split('T')[0];
            }
        }

        // Open report modal
        function openReportModal() {
            document.getElementById('reportModal').style.display = 'block';
            document.getElementById('reportForm').reset();
            document.getElementById('customDateRange').style.display = 'none';
            updateDateRange();
            loadTechniciansForReport();
        }

        // Close report modal
        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
            document.getElementById('reportForm').reset();
        }

        // Load technicians for report dropdown
        async function loadTechniciansForReport() {
            try {
                const response = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/technicians`));
                const data = await response.json();
                
                const select = document.getElementById('reportTechnician');
                select.innerHTML = '<option value="">All Technicians</option>';
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(tech => {
                        const option = document.createElement('option');
                        option.value = tech.user_id;
                        const displayName = tech.user?.display_name || tech.display_name;
                        option.textContent = `${displayName} (${tech.employee_code})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading technicians:', error);
            }
        }

        // Handle report form submission
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const period = document.getElementById('reportPeriod').value;
            const technicianId = document.getElementById('reportTechnician').value;
            const from = document.getElementById('reportFrom').value;
            const to = document.getElementById('reportTo').value;

            if (!from || !to) {
                alert('Please select a date range');
                return;
            }

            const submitBtn = document.querySelector('#reportForm button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generating...';

            try {
                let url = `${API_BASE_URL}/reports/comprehensive?from=${from}&to=${to}&period=${period}`;
                if (technicianId) {
                    url += `&technician_id=${technicianId}`;
                }

                const response = await apiFetch(url);
                const data = await response.json();

                if (response.ok) {
                    displayReport(data);
                    closeReportModal();
                } else {
                    alert('Error: ' + (data.error?.message || 'Failed to generate report'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Report';
            }
        });

        // Store last generated comprehensive report for export
        let lastComprehensiveReportData = null;

        // Display report results
        function displayReport(data) {
            const resultsDiv = document.getElementById('reportResults');
            const summaryDiv = document.getElementById('reportSummary');
            const dataDiv = document.getElementById('reportData');
            
            resultsDiv.style.display = 'block';
            lastComprehensiveReportData = data;

            // Summary
            summaryDiv.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 15px;">
                        <h3 style="margin: 0;">Report Summary</h3>
                        <button class="btn-primary" onclick="exportComprehensiveReportExcel()" style="background: #28a745; padding: 8px 16px;">
                            üì• Export Excel
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Period:</strong><br>
                            ${new Date(data.report.from).toLocaleDateString()} - ${new Date(data.report.to).toLocaleDateString()}
                        </div>
                        <div>
                            <strong>Total Job Cards:</strong><br>
                            ${data.summary.total_job_cards}
                        </div>
                        <div>
                            <strong>Completed:</strong><br>
                            <span style="color: #28a745;">${data.summary.total_completed}</span>
                        </div>
                        <div>
                            <strong>Incomplete:</strong><br>
                            <span style="color: #ffc107;">${data.summary.total_incomplete}</span>
                        </div>
                        <div>
                            <strong>Total Hours:</strong><br>
                            ${data.summary.total_hours ? parseFloat(data.summary.total_hours).toFixed(2) : '0.00'}h
                        </div>
                        <div>
                            <strong>Job Efficiency:</strong><br>
                            ${data.summary.efficiency}%
                            <div style="color:#666; font-size:0.85em;">Actual √∑ Estimated</div>
                        </div>
                    </div>
                </div>
            `;

            // By Technician (include efficiency per technician)
            let technicianHtml = '<h3 style="margin: 20px 0 10px 0;">By Technician</h3><table><tr><th>Technician</th><th>Completed</th><th>Incomplete</th><th>Total Hours</th><th>Estimated Hours</th><th>Job Efficiency %</th></tr>';
            if (data.by_technician && data.by_technician.length > 0) {
                data.by_technician.forEach(tech => {
                    const totalHours = tech.total_hours ? parseFloat(tech.total_hours).toFixed(2) : '0.00';
                    const estHours = (tech.estimated_hours_total !== undefined && tech.estimated_hours_total !== null)
                        ? parseFloat(tech.estimated_hours_total || 0).toFixed(2)
                        : '0.00';
                    let eff = 'Missing Estimate';
                    if (tech.efficiency_percent !== undefined && tech.efficiency_percent !== null) {
                        eff = `${parseFloat(tech.efficiency_percent).toFixed(2)}%`;
                    } else if (tech.estimated_hours_total && parseFloat(tech.estimated_hours_total) > 0) {
                        eff = '0.00%';
                    }
                    technicianHtml += `
                        <tr>
                            <td>${tech.technician_name} (${tech.employee_code})</td>
                            <td><span style="color: #28a745;">${tech.completed_count || 0}</span></td>
                            <td><span style="color: #ffc107;">${tech.incomplete_count || 0}</span></td>
                            <td>${totalHours}h</td>
                            <td>${estHours}h</td>
                            <td><strong>${eff}</strong></td>
                        </tr>
                    `;
                });
            } else {
                technicianHtml += '<tr><td colspan="6">No data available</td></tr>';
            }
            technicianHtml += '</table>';

            // Completed Job Cards
            let completedHtml = '<h3 style="margin: 20px 0 10px 0;">Completed Job Cards</h3><table><tr><th>Period</th><th>Job Number</th><th>Customer</th><th>Technician</th><th>Work Type</th><th>Time Spent</th><th>Status</th></tr>';
            if (data.completed_job_cards && data.completed_job_cards.length > 0) {
                    data.completed_job_cards.forEach(job => {
                        const timeSpent = job.total_hours ? `${parseFloat(job.total_hours).toFixed(2)}h` : '-';
                        const technicians = job.technicians || (job.technician_name ? `${job.technician_name} ${job.employee_code ? `(${job.employee_code})` : ''}` : '-');
                        const statusText = job.status || job.job_card_status || '-';
                        completedHtml += `
                            <tr>
                                <td>${job.period || '-'}</td>
                                <td>${job.job_number}</td>
                                <td>${job.customer_name}</td>
                                <td>${technicians}</td>
                                <td>${job.work_type || '-'}</td>
                                <td><span style="color: #28a745; font-weight: bold;">${timeSpent}</span></td>
                                <td><span class="badge completed">${statusText}</span></td>
                            </tr>
                        `;
                    });
            } else {
                completedHtml += '<tr><td colspan="7">No completed job cards in this period</td></tr>';
            }
            completedHtml += '</table>';

            // Incomplete Job Cards
            let incompleteHtml = '<h3 style="margin: 20px 0 10px 0;">Incomplete Job Cards</h3><table><tr><th>Period</th><th>Job Number</th><th>Customer</th><th>Technician</th><th>Work Type</th><th>Time Spent</th><th>Status</th></tr>';
            if (data.incomplete_job_cards && data.incomplete_job_cards.length > 0) {
                    data.incomplete_job_cards.forEach(job => {
                        const timeSpent = job.total_hours ? `${parseFloat(job.total_hours).toFixed(2)}h` : '-';
                        const technicians = job.technicians || (job.technician_name ? `${job.technician_name} ${job.employee_code ? `(${job.employee_code})` : ''}` : '-');
                        incompleteHtml += `
                            <tr>
                                <td>${job.period || '-'}</td>
                                <td>${job.job_number}</td>
                                <td>${job.customer_name}</td>
                                <td>${technicians}</td>
                                <td>${job.work_type || '-'}</td>
                                <td>${timeSpent}</td>
                                <td><span class="badge ${job.job_card_status}">${job.job_card_status}</span></td>
                            </tr>
                        `;
                    });
            } else {
                incompleteHtml += '<tr><td colspan="7">No incomplete job cards in this period</td></tr>';
            }
            incompleteHtml += '</table>';

            dataDiv.innerHTML = technicianHtml + completedHtml + incompleteHtml;
            
            // Scroll to results
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function exportComprehensiveReportExcel() {
            try {
                if (!lastComprehensiveReportData) {
                    alert('Please generate the report first before exporting.');
                    return;
                }
                if (typeof XLSX === 'undefined') {
                    alert('Excel export library not loaded. Please refresh the page and try again.');
                    return;
                }

                const data = lastComprehensiveReportData;
                const wb = XLSX.utils.book_new();

                // Summary sheet
                const fromStr = data?.report?.from ? new Date(data.report.from).toLocaleDateString() : '';
                const toStr = data?.report?.to ? new Date(data.report.to).toLocaleDateString() : '';
                const summaryRows = [
                    ['Comprehensive Report'],
                    ['Generated At', data?.report?.generated_at || ''],
                    ['Period', `${fromStr} - ${toStr}`],
                    [],
                    ['Total Job Cards', data?.summary?.total_job_cards ?? 0],
                    ['Completed', data?.summary?.total_completed ?? 0],
                    ['Incomplete', data?.summary?.total_incomplete ?? 0],
                    ['Total Hours', data?.summary?.total_hours ?? 0],
                    ['Total Estimated Hours', data?.summary?.total_estimated_hours ?? ''],
                    ['Total Actual Hours', data?.summary?.total_actual_hours ?? ''],
                    ['Efficiency %', data?.summary?.efficiency ?? 0],
                    ['Efficiency Note', data?.summary?.efficiency_note || '']
                ];
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryRows), 'Summary');

                // By Technician
                const byTech = Array.isArray(data.by_technician) ? data.by_technician : [];
                const byTechRows = [
                    ['Technician', 'Employee Code', 'Completed', 'Incomplete', 'Total Hours', 'Estimated Hours', 'Efficiency %']
                ].concat(byTech.map(t => ([
                    t.technician_name || '',
                    t.employee_code || '',
                    Number(t.completed_count || 0),
                    Number(t.incomplete_count || 0),
                    Number(t.total_hours || 0),
                    Number(t.estimated_hours_total || 0),
                    (t.efficiency_percent !== undefined && t.efficiency_percent !== null) ? Number(t.efficiency_percent || 0) : ''
                ])));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(byTechRows), 'By Technician');

                // Completed Job Cards
                const completed = Array.isArray(data.completed_job_cards) ? data.completed_job_cards : [];
                const completedRows = [
                    ['Period', 'Job Number', 'Customer', 'Technicians', 'Work Type', 'Time Spent (Hours)', 'Status']
                ].concat(completed.map(j => ([
                    j.period || '',
                    j.job_number || '',
                    j.customer_name || '',
                    j.technicians || '',
                    j.work_type || '',
                    Number(j.total_hours || 0),
                    j.status || j.job_card_status || ''
                ])));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(completedRows), 'Completed');

                // Incomplete Job Cards
                const incomplete = Array.isArray(data.incomplete_job_cards) ? data.incomplete_job_cards : [];
                const incompleteRows = [
                    ['Period', 'Job Number', 'Customer', 'Technicians', 'Work Type', 'Time Spent (Hours)', 'Status']
                ].concat(incomplete.map(j => ([
                    j.period || '',
                    j.job_number || '',
                    j.customer_name || '',
                    j.technicians || '',
                    j.work_type || '',
                    Number(j.total_hours || 0),
                    j.status || j.job_card_status || ''
                ])));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(incompleteRows), 'Incomplete');

                const fileDate = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Comprehensive_Report_${fileDate}.xlsx`);
            } catch (error) {
                alert('Error exporting to Excel: ' + error.message);
            }
        }

        // Load Asset Utilization Report
        async function loadAssetUtilizationReport() {
            try {
                const response = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/reports/asset-utilization`));
                const data = await response.json();
                
                if (response.ok) {
                    let html = '<h3>Asset Utilization Report</h3>';
                    if (data.summary) {
                        html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <strong>Summary:</strong> ${data.summary.total_assets} assets, ${data.summary.total_work_orders} work orders, ${parseFloat(data.summary.total_hours || 0).toFixed(2)} hours
                        </div>`;
                    }
                    if (data.data && data.data.length > 0) {
                        html += '<table><tr><th>Asset</th><th>Tag</th><th>Location</th><th>Total Work Orders</th><th>Completed</th><th>Total Hours</th></tr>';
                        data.data.forEach(asset => {
                            html += `
                                <tr>
                                    <td>${asset.name}</td>
                                    <td>${asset.asset_tag || '-'}</td>
                                    <td>${asset.location_name || '-'}</td>
                                    <td>${asset.total_work_orders || 0}</td>
                                    <td>${asset.completed_work_orders || 0}</td>
                                    <td>${parseFloat(asset.total_hours_used || 0).toFixed(2)}h</td>
                                </tr>
                            `;
                        });
                        html += '</table>';
                    } else {
                        html += '<p>No asset utilization data found.</p>';
                    }
                    
                    document.getElementById('reportData').innerHTML = html;
                    document.getElementById('reportResults').style.display = 'block';
                    document.getElementById('reportResults').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Error loading asset utilization report: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading asset utilization report:', error);
                alert('Error loading report: ' + error.message);
            }
        }

        // Load Parts Consumption Report
        async function loadPartsConsumptionReport() {
            try {
                const response = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/reports/parts-consumption`));
                const data = await response.json();
                
                if (response.ok) {
                    let html = '<h3>Parts Consumption Report</h3>';
                    if (data.summary) {
                        html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <strong>Summary:</strong> ${data.summary.total_parts_used} parts, ${data.summary.total_quantity} total quantity, $${parseFloat(data.summary.total_cost || 0).toFixed(2)} total cost
                        </div>`;
                    }
                    if (data.data && data.data.length > 0) {
                        html += '<table><tr><th>Part Name</th><th>Part Number</th><th>Parent Asset</th><th>Quantity Used</th><th>Avg Unit Cost</th><th>Total Cost</th><th>Work Orders</th></tr>';
                        data.data.forEach(part => {
                            html += `
                                <tr>
                                    <td>${part.name}</td>
                                    <td>${part.part_number || '-'}</td>
                                    <td>${part.parent_asset_name || '-'}</td>
                                    <td>${part.total_quantity_used || 0}</td>
                                    <td>$${parseFloat(part.avg_unit_cost || 0).toFixed(2)}</td>
                                    <td>$${parseFloat(part.total_cost || 0).toFixed(2)}</td>
                                    <td>${part.work_orders_count || 0}</td>
                                </tr>
                            `;
                        });
                        html += '</table>';
                    } else {
                        html += '<p>No parts consumption data found.</p>';
                    }
                    
                    document.getElementById('reportData').innerHTML = html;
                    document.getElementById('reportResults').style.display = 'block';
                    document.getElementById('reportResults').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Error loading parts consumption report: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading parts consumption report:', error);
                alert('Error loading report: ' + error.message);
            }
        }

        // Store report data for export
        let lastEfficiencyReportData = null;

        // Load Technician KPIs Report (Job Efficiency & Utilization)
        async function loadTechnicianEfficiencyReport() {
            try {
                const response = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/reports/technician-efficiency`));
                const data = await response.json();
                
                if (response.ok && data) {
                    // Save data for export
                    lastEfficiencyReportData = data;
                    
                    // Build professional report HTML
                    let html = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">üìä Technician KPIs Report (Job Efficiency & Utilization)</h3>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn-primary" onclick="exportTechnicianReportExcel()" style="background: #28a745; padding: 8px 16px;">
                                    üì• Export Excel
                                </button>
                                <button class="btn-primary" onclick="exportTechnicianReportPDF()" style="background: #dc3545; padding: 8px 16px;">
                                    üìÑ Export PDF
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Summary cards
                    if (data.summary) {
                        html += `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                                <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
                                    <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Total Technicians</div>
                                    <div style="font-size: 2em; font-weight: bold; color: #28a745;">${data.summary.total_technicians || 0}</div>
                                </div>
                                <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Completed Jobs</div>
                                    <div style="font-size: 2em; font-weight: bold; color: #ff9800;">${data.summary.total_completed_jobs || 0}</div>
                                </div>
                                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3;">
                                    <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Avg Job Efficiency</div>
                                    <div style="font-size: 2em; font-weight: bold; color: #2196f3;">${(data.summary.avg_job_efficiency ?? data.summary.avg_efficiency ?? 0).toFixed(1)}%</div>
                                    <small style="color: #666;">Billed / Worked</small>
                                </div>
                                <div style="background: #f3e5f5; padding: 20px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                                    <div style="color: #666; font-size: 0.9em; margin-bottom: 5px;">Avg Utilization</div>
                                    <div style="font-size: 2em; font-weight: bold; color: #9c27b0;">${(data.summary.avg_utilization ?? data.summary.avg_productivity ?? 0).toFixed(1)}%</div>
                                    <small style="color: #666;">Worked / Clocked</small>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Performance table
                    if (data.data && data.data.length > 0) {
                        html += `
                            <table style="width: 100%; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <thead>
                                    <tr style="background: var(--brand-secondary);">
                                        <th style="color: white; text-align: left;">Technician</th>
                                        <th style="color: white; text-align: left;">Code</th>
                                        <th style="color: white; text-align: center;">Jobs</th>
                                        <th style="color: white; text-align: center;">Completed</th>
                                        <th style="color: white; text-align: right;">Billed</th>
                                        <th style="color: white; text-align: right;">Worked</th>
                                        <th style="color: white; text-align: center;">Job Efficiency</th>
                                        <th style="color: white; text-align: right;">Shift</th>
                                        <th style="color: white; text-align: center;">Utilization</th>
                                        <th style="color: white; text-align: right;">Avg/Job</th>
                                        <th style="color: white; text-align: center;">Comebacks</th>
                                        <th style="color: white; text-align: center;">Rework</th>
                                        <th style="color: white; text-align: center;">Repeat</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.data.forEach(tech => {
                            const efficiency = parseFloat((tech.job_efficiency_percent ?? tech.efficiency_percent) || 0);
                            const productivity = parseFloat((tech.utilization_percent ?? tech.productivity_percent) || 0);
                            
                            // Color code efficiency
                            const efficiencyColor = efficiency >= 100 ? '#28a745' : efficiency >= 80 ? '#ffc107' : '#dc3545';
                            const efficiencyBadge = efficiency >= 100 ? 'success' : efficiency >= 80 ? 'warning' : 'danger';
                            
                            // Color code productivity
                            const productivityColor = productivity >= 75 ? '#28a745' : productivity >= 50 ? '#ffc107' : '#dc3545';
                            const productivityBadge = productivity >= 75 ? 'success' : productivity >= 50 ? 'warning' : 'danger';
                            
                            html += `
                                <tr style="border-bottom: 1px solid #e0e0e0;">
                                    <td style="padding: 12px;"><strong>${tech.technician_name}</strong></td>
                                    <td style="padding: 12px;">${tech.employee_code || '-'}</td>
                                    <td style="padding: 12px; text-align: center;">${tech.total_jobs || 0}</td>
                                    <td style="padding: 12px; text-align: center;">${tech.completed_jobs || 0}</td>
                                    <td style="padding: 12px; text-align: right;">${parseFloat(tech.total_billed_hours || 0).toFixed(2)}h</td>
                                    <td style="padding: 12px; text-align: right;">${parseFloat(tech.total_worked_hours || 0).toFixed(2)}h</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <span class="badge ${efficiencyBadge}" style="font-size: 1.1em; font-weight: bold; padding: 6px 12px;">
                                            ${efficiency.toFixed(1)}%
                                        </span>
                                        ${efficiency >= 100 ? ' üèÜ' : efficiency < 80 ? ' ‚ö†Ô∏è' : ''}
                                    </td>
                                    <td style="padding: 12px; text-align: right;">${parseFloat(tech.total_shift_hours || 0).toFixed(2)}h</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <span class="badge ${productivityBadge}" style="font-size: 1.1em; font-weight: bold; padding: 6px 12px;">
                                            ${productivity.toFixed(1)}%
                                        </span>
                                        ${productivity >= 75 ? ' ‚≠ê' : productivity < 50 ? ' ‚ö†Ô∏è' : ''}
                                    </td>
                                    <td style="padding: 12px; text-align: right;">${parseFloat(tech.avg_hours_per_job || 0).toFixed(2)}h</td>
                                    <td style="padding: 12px; text-align: center;">${tech.comeback_jobs || 0}</td>
                                    <td style="padding: 12px; text-align: center;">${tech.rework_jobs || 0}</td>
                                    <td style="padding: 12px; text-align: center;">${tech.repeat_jobs || 0}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                        
                        // Add metrics explanation
                        html += `
                            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--brand-primary);">
                                <h4 style="margin-bottom: 15px; color: var(--brand-primary);">üìã Metrics Explanation</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <strong style="color: #333;">Efficiency = Billed Hours √∑ Worked Hours √ó 100</strong>
                                        <ul style="margin: 10px 0 0 20px; color: #666; line-height: 1.8;">
                                            <li><span class="badge success" style="padding: 4px 8px;">‚â•100%</span> = Excellent (faster than estimated)</li>
                                            <li><span class="badge warning" style="padding: 4px 8px;">80-99%</span> = Good (close to estimate)</li>
                                            <li><span class="badge danger" style="padding: 4px 8px;">&lt;80%</span> = Needs improvement</li>
                                        </ul>
                                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; font-size: 0.9em;">
                                            <strong>Example:</strong> Job allocated 1 hour, completed in 30 min<br>
                                            Efficiency = 1.0 √∑ 0.5 = <strong>200%</strong> üèÜ
                                        </div>
                                    </div>
                                    <div>
                                        <strong style="color: #333;">Productivity = Worked Hours √∑ Shift Hours √ó 100</strong>
                                        <ul style="margin: 10px 0 0 20px; color: #666; line-height: 1.8;">
                                            <li><span class="badge success" style="padding: 4px 8px;">‚â•75%</span> = Excellent (high utilization)</li>
                                            <li><span class="badge warning" style="padding: 4px 8px;">50-74%</span> = Fair (some idle time)</li>
                                            <li><span class="badge danger" style="padding: 4px 8px;">&lt;50%</span> = Low (too much idle)</li>
                                        </ul>
                                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; font-size: 0.9em;">
                                            <strong>Example:</strong> 8 hour shift, 6 hours worked<br>
                                            Productivity = 6 √∑ 8 = <strong>75%</strong> ‚≠ê
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd; color: #666; font-size: 0.9em;">
                                    <strong>Note:</strong> Productivity calculation requires technicians to clock in/out for shifts. 
                                    If shift hours are 0, productivity will show N/A.
                                </div>
                            </div>
                        `;
                    } else {
                        html += '<p>No technician performance data available.</p>';
                    }
                    
                    document.getElementById('reportSummary').innerHTML = '';
                    document.getElementById('reportData').innerHTML = html;
                    document.getElementById('reportResults').style.display = 'block';
                    document.getElementById('reportResults').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Error loading technician efficiency report: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading technician efficiency report:', error);
                alert('Error loading report: ' + error.message);
            }
        }

        // Export Technician Report to Excel
        function exportTechnicianReportExcel() {
            if (!lastEfficiencyReportData || !lastEfficiencyReportData.data || lastEfficiencyReportData.data.length === 0) {
                alert('Please generate the report first before exporting.');
                return;
            }
            try {
                const wb = XLSX.utils.book_new();
                
                // Main data sheet
                const wsData = [
                    ['Technician KPIs Report (Job Efficiency & Utilization)'],
                    ['Generated:', new Date().toLocaleString()],
                    ['Business Unit:', 'Your Business Unit'],
                    [],
                    ['Technician', 'Employee Code', 'Total Jobs', 'Completed', 'Billed Hours', 'Worked Hours', 'Efficiency %', 'Shift Hours', 'Productivity %', 'Avg Hours/Job']
                ];
                
                lastEfficiencyReportData.data.forEach(tech => {
                    wsData.push([
                        tech.technician_name || '',
                        tech.employee_code || '',
                        tech.total_jobs || 0,
                        tech.completed_jobs || 0,
                        parseFloat(tech.total_billed_hours || 0).toFixed(2),
                        parseFloat(tech.total_worked_hours || 0).toFixed(2),
                        parseFloat(tech.efficiency_percent || 0).toFixed(1) + '%',
                        parseFloat(tech.total_shift_hours || 0).toFixed(2),
                        parseFloat(tech.productivity_percent || 0).toFixed(1) + '%',
                        parseFloat(tech.avg_hours_per_job || 0).toFixed(2)
                    ]);
                });
                
                // Add summary
                wsData.push([]);
                wsData.push(['SUMMARY']);
                wsData.push(['Total Technicians:', lastEfficiencyReportData.summary.total_technicians || 0]);
                wsData.push(['Total Completed Jobs:', lastEfficiencyReportData.summary.total_completed_jobs || 0]);
                wsData.push(['Total Billed Hours:', (lastEfficiencyReportData.summary.total_billed_hours || 0).toFixed(2)]);
                wsData.push(['Total Worked Hours:', (lastEfficiencyReportData.summary.total_worked_hours || 0).toFixed(2)]);
                wsData.push(['Average Efficiency:', (lastEfficiencyReportData.summary.avg_efficiency || 0).toFixed(1) + '%']);
                wsData.push(['Average Productivity:', (lastEfficiencyReportData.summary.avg_productivity || 0).toFixed(1) + '%']);
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 20 }, // Technician
                    { wch: 15 }, // Employee Code
                    { wch: 12 }, // Total Jobs
                    { wch: 12 }, // Completed
                    { wch: 12 }, // Billed
                    { wch: 12 }, // Worked
                    { wch: 12 }, // Efficiency
                    { wch: 12 }, // Shift
                    { wch: 12 }, // Productivity
                    { wch: 12 }  // Avg/Job
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Technician Performance');
                XLSX.writeFile(wb, `Technician_Efficiency_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
                alert('‚úÖ Excel file downloaded successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting to Excel: ' + error.message);
            }
        }

        // Export Technician Report to PDF
        function exportTechnicianReportPDF() {
            if (!lastEfficiencyReportData || !lastEfficiencyReportData.data || lastEfficiencyReportData.data.length === 0) {
                alert('Please generate the report first before exporting.');
                return;
            }
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Title
                doc.setFontSize(18);
                doc.setTextColor(0, 123, 255);
                doc.text('Technician KPIs Report (Job Efficiency & Utilization)', 14, 20);
                
                // Date
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);
                
                // Summary
                doc.setFontSize(12);
                doc.setTextColor(0);
                doc.text('Summary:', 14, 38);
                doc.setFontSize(10);
                doc.text(`Total Technicians: ${lastEfficiencyReportData.summary.total_technicians || 0}`, 20, 45);
                doc.text(`Completed Jobs: ${lastEfficiencyReportData.summary.total_completed_jobs || 0}`, 20, 51);
                doc.text(`Avg Efficiency: ${(lastEfficiencyReportData.summary.avg_efficiency || 0).toFixed(1)}%`, 20, 57);
                doc.text(`Avg Productivity: ${(lastEfficiencyReportData.summary.avg_productivity || 0).toFixed(1)}%`, 20, 63);
                
                // Table data
                const tableData = lastEfficiencyReportData.data.map(tech => [
                    tech.technician_name || '',
                    tech.employee_code || '',
                    tech.total_jobs || 0,
                    tech.completed_jobs || 0,
                    parseFloat(tech.total_billed_hours || 0).toFixed(2) + 'h',
                    parseFloat(tech.total_worked_hours || 0).toFixed(2) + 'h',
                    parseFloat(tech.efficiency_percent || 0).toFixed(1) + '%',
                    parseFloat(tech.total_shift_hours || 0).toFixed(2) + 'h',
                    parseFloat(tech.productivity_percent || 0).toFixed(1) + '%',
                    parseFloat(tech.avg_hours_per_job || 0).toFixed(2) + 'h'
                ]);
                
                doc.autoTable({
                    startY: 70,
                    head: [['Technician', 'Code', 'Jobs', 'Done', 'Billed', 'Worked', 'Efficiency', 'Shift', 'Productivity', 'Avg/Job']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [0, 123, 255], textColor: 255 },
                    styles: { fontSize: 8, cellPadding: 3 },
                    columnStyles: {
                        0: { cellWidth: 30 },
                        1: { cellWidth: 20 },
                        2: { halign: 'center', cellWidth: 15 },
                        3: { halign: 'center', cellWidth: 15 },
                        4: { halign: 'right', cellWidth: 18 },
                        5: { halign: 'right', cellWidth: 18 },
                        6: { halign: 'center', cellWidth: 20 },
                        7: { halign: 'right', cellWidth: 18 },
                        8: { halign: 'center', cellWidth: 20 },
                        9: { halign: 'right', cellWidth: 16 }
                    }
                });
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                }
                
                doc.save(`Technician_Efficiency_Report_${new Date().toISOString().split('T')[0]}.pdf`);
                alert('‚úÖ PDF file downloaded successfully!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting to PDF: ' + error.message);
            }
        }

        // Keep old function name for backward compatibility
        async function loadTechnicianPerformanceReport() {
            await loadTechnicianEfficiencyReport();
        }

        // Load Location Workload Report
        async function loadLocationWorkloadReport() {
            try {
                const response = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/reports/location-workload`));
                const data = await response.json();
                
                if (response.ok) {
                    let html = '<h3>Location Workload Report</h3>';
                    if (data.summary) {
                        html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                            <strong>Summary:</strong> ${data.summary.total_locations} locations, ${data.summary.total_job_cards} job cards, ${data.summary.completed_job_cards} completed, ${data.summary.active_technicians} active technicians
                        </div>`;
                    }
                    if (data.data && data.data.length > 0) {
                        html += '<table><tr><th>Location</th><th>Business Unit</th><th>Total Jobs</th><th>Completed</th><th>In Progress</th><th>Open</th><th>Active Technicians</th><th>Total Hours</th></tr>';
                        data.data.forEach(location => {
                            html += `
                                <tr>
                                    <td>${location.name}</td>
                                    <td>${location.business_unit_name || '-'}</td>
                                    <td>${location.total_job_cards || 0}</td>
                                    <td>${location.completed_job_cards || 0}</td>
                                    <td>${location.in_progress_job_cards || 0}</td>
                                    <td>${location.open_job_cards || 0}</td>
                                    <td>${location.active_technicians || 0}</td>
                                    <td>${parseFloat(location.total_hours || 0).toFixed(2)}h</td>
                                </tr>
                            `;
                        });
                        html += '</table>';
                    } else {
                        html += '<p>No location workload data found.</p>';
                    }
                    
                    document.getElementById('reportData').innerHTML = html;
                    document.getElementById('reportResults').style.display = 'block';
                    document.getElementById('reportResults').scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Error loading location workload report: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading location workload report:', error);
                alert('Error loading report: ' + error.message);
            }
        }

        // Load technicians for reassign dropdown (excluding current technician)
        async function loadTechniciansForReassign(excludeTechnicianId) {
            try {
                const response = await apiFetch(`${API_BASE_URL}/technicians`);
                const data = await response.json();
                
                const select = document.getElementById('reassignTechnicianSelect');
                select.innerHTML = '<option value="">Select a technician...</option>';
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(tech => {
                        if (tech.user_id !== excludeTechnicianId) {
                            const option = document.createElement('option');
                            option.value = tech.user_id;
                            const displayName = tech.user?.display_name || tech.display_name;
                            option.textContent = `${displayName} (${tech.employee_code})${tech.active_assignments > 0 ? ' - ' + tech.active_assignments + ' active' : ''}`;
                            select.appendChild(option);
                        }
                    });
                } else {
                    select.innerHTML = '<option value="">No technicians available</option>';
                }
            } catch (error) {
                console.error('Error loading technicians:', error);
                document.getElementById('reassignTechnicianSelect').innerHTML = '<option value="">Error loading technicians</option>';
            }
        }

        // Handle reassign form submission
        document.getElementById('reassignForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const assignmentId = document.getElementById('reassignAssignmentId').value;
            const newTechnicianId = document.getElementById('reassignTechnicianSelect').value;
            const reason = document.getElementById('reassignReason').value;
            const notes = document.getElementById('reassignNotes').value;

            if (!newTechnicianId) {
                alert('Please select a new technician');
                return;
            }

            if (!reason.trim()) {
                alert('Please provide a reason for reassignment');
                return;
            }

            const submitBtn = document.querySelector('#reassignForm button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Reassigning...';

            try {
                // Update assignment with new technician
                const response = await apiFetch(`${API_BASE_URL}/assignments/${assignmentId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        technician_id: newTechnicianId,
                        notes: notes ? `${reason}\n\nAdditional notes: ${notes}` : reason
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Technician reassigned successfully!');
                    closeReassignModal();
                    loadJobCards();
                    loadAssignments();
                } else {
                    alert('Error: ' + (data.error?.message || 'Failed to reassign technician'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Reassign';
            }
        });


        // Load assignments and calculate stats
        async function loadAssignments() {
            try {
                // Load assignments
                const assignmentsResponse = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/assignments`));
                const assignmentsData = await assignmentsResponse.json();
                
                // Load job cards to count unassigned ones
                const jobCardsResponse = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/jobcards`));
                const jobCardsData = await jobCardsResponse.json();
                
                // Calculate active assignments (in_progress or assigned)
                let active = 0;
                let pending = 0;
                
                if (assignmentsData.data && assignmentsData.data.length > 0) {
                    assignmentsData.data.forEach(assignment => {
                        if (assignment.status === 'in_progress' || assignment.status === 'assigned') {
                            active++;
                        } else if (assignment.status === 'pending') {
                            pending++;
                        }
                    });
                }
                
                // Count unassigned job cards (open status with no assignments) as pending
                if (jobCardsData.data && jobCardsData.data.length > 0) {
                    jobCardsData.data.forEach(job => {
                        if (job.status === 'open' && (!job.assignments || job.assignments.length === 0)) {
                            pending++;
                        }
                    });
                }
                
                document.getElementById('activeAssignments').textContent = active;
                document.getElementById('pendingAssignments').textContent = pending;
                
                // Display assignments list
                if (assignmentsData.data && assignmentsData.data.length > 0) {
                    let html = '<table><tr><th>Job Number</th><th>Customer</th><th>Technician</th><th>Assigned By</th><th>Status</th><th>Time Spent</th><th>Assigned At</th></tr>';
                    assignmentsData.data.forEach(assignment => {
                        const timeSpent = assignment.total_time_formatted || '0m';
                        const timeDisplay = assignment.status === 'completed' && timeSpent !== '0m'
                            ? `<span style="color: #28a745; font-weight: bold;">${timeSpent}</span>`
                            : timeSpent;
                        const assignedBy = assignment.assigned_by_name || '-';
                        html += `
                            <tr>
                                <td>${assignment.job_number}</td>
                                <td>${assignment.customer_name || '-'}</td>
                                <td>${assignment.technician_name} (${assignment.employee_code})</td>
                                <td>${assignedBy}</td>
                                <td><span class="badge ${assignment.status}">${assignment.status}</span></td>
                                <td>${timeDisplay}</td>
                                <td>${new Date(assignment.assigned_at).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    document.getElementById('assignmentsList').innerHTML = html;
                } else {
                    document.getElementById('assignmentsList').innerHTML = '<p>No assignments found.</p>';
                }
            } catch (error) {
                console.error('Error loading assignments:', error);
                document.getElementById('activeAssignments').textContent = '0';
                document.getElementById('pendingAssignments').textContent = '0';
                document.getElementById('assignmentsList').innerHTML = '<p style="color: red;">Error loading assignments: ' + error.message + '</p>';
            }
        }

        // Load locations for dropdown
        async function loadLocations() {
            try {
                const url = addBusinessUnitFilter(`${API_BASE_URL}/locations?is_active=true`);
                console.log('Loading locations with URL:', url);
                console.log('Current userBusinessUnitId:', userBusinessUnitId);
                const response = await apiFetch(url);
                const data = await response.json();
                console.log('Locations loaded:', data);
                
                const select = document.getElementById('location_id');
                const filterSelect = document.getElementById('filterLocation');
                const techSelect = document.getElementById('technicianLocation');
                
                if (select) {
                    select.innerHTML = '<option value="">Select location...</option>';
                    if (data && data.length > 0) {
                        data.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc.id;
                            option.textContent = `${loc.name}${loc.business_unit_name ? ' (' + loc.business_unit_name + ')' : ''}`;
                            select.appendChild(option);
                        });
                    }
                }
                
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="">All Locations</option>';
                    if (data && data.length > 0) {
                        data.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc.id;
                            option.textContent = `${loc.name}${loc.business_unit_name ? ' (' + loc.business_unit_name + ')' : ''}`;
                            filterSelect.appendChild(option);
                        });
                    }
                }

                if (techSelect) {
                    techSelect.innerHTML = '<option value="">Select location...</option>';
                    if (data && data.length > 0) {
                        data.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc.id;
                            option.textContent = `${loc.name}${loc.business_unit_name ? ' (' + loc.business_unit_name + ')' : ''}`;
                            techSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }
        
        // Load assets for dropdown
        async function loadAssets() {
            try {
                // Do not hard-filter by status here; legacy assets may not use "active" exactly,
                // and advisors still need to link them to job cards (e.g., tools already in use).
                const response = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/assets`));
                const data = await response.json();
                
                const select = document.getElementById('asset_id');
                if (select) {
                    select.innerHTML = '<option value="">Select asset or scan barcode...</option>';
                    if (data && data.length > 0) {
                        data.forEach(asset => {
                            const option = document.createElement('option');
                            option.value = asset.id;
                            const statusBadge = asset.status && String(asset.status).toLowerCase() !== 'active'
                                ? ` [${asset.status}]`
                                : '';
                            const displayName = `${asset.name}${asset.asset_tag ? ' (' + asset.asset_tag + ')' : ''}${asset.serial_number ? ' - ' + asset.serial_number : ''}${statusBadge}`;
                            option.textContent = displayName;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading assets:', error);
            }
        }

        // Find asset by identifier (plate / asset tag / serial / barcode)
        async function findAssetByIdentifier() {
            const input = document.getElementById('asset_identifier');
            const statusEl = document.getElementById('assetIdentifierStatus');
            const select = document.getElementById('asset_id');
            if (!input || !statusEl || !select) return;

            const ident = (input.value || '').trim();
            if (!ident) {
                statusEl.textContent = 'Enter an identifier to search.';
                return;
            }

            statusEl.textContent = 'Searching...';
            try {
                const resp = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/assets?identifier=${encodeURIComponent(ident)}`));
                const data = await resp.json();
                if (!resp.ok) {
                    statusEl.innerHTML = `<span style="color:#a00;">${data?.error?.message || 'Search failed'}</span>`;
                    return;
                }

                const assets = Array.isArray(data) ? data : (data.data || []);
                if (!assets || assets.length === 0) {
                    statusEl.innerHTML = `<span style="color:#a00;">No asset found for "${ident}".</span>`;
                    return;
                }

                const asset = assets[0];
                const displayName = `${asset.name}${asset.asset_tag ? ' (' + asset.asset_tag + ')' : ''}${asset.serial_number ? ' - ' + asset.serial_number : ''}`;
                // Ensure option exists in dropdown
                let opt = Array.from(select.options).find(o => String(o.value) === String(asset.id));
                if (!opt) {
                    opt = document.createElement('option');
                    opt.value = asset.id;
                    opt.textContent = displayName;
                    select.appendChild(opt);
                }
                select.value = asset.id;
                statusEl.innerHTML = `<span style="color:#28a745;">Selected:</span> ${displayName}`;
            } catch (err) {
                console.error('Identifier search error:', err);
                statusEl.innerHTML = `<span style="color:#a00;">Error: ${err.message}</span>`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('asset_identifier');
            if (!input) return;
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    findAssetByIdentifier();
                }
            });
        });
        
        // Load parent work orders for dropdown
        async function loadParentWorkOrders() {
            try {
                const response = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/jobcards?status=open,in_progress`));
                const data = await response.json();
                
                const select = document.getElementById('parent_work_order_id');
                if (select) {
                    select.innerHTML = '<option value="">None (Standalone job)</option>';
                    if (data.data && data.data.length > 0) {
                        data.data.forEach(job => {
                            const option = document.createElement('option');
                            option.value = job.id;
                            option.textContent = `${job.job_number} - ${job.customer_name}`;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading parent work orders:', error);
            }
        }

        // Link a previous job card by job number (works even if it is completed and not in the parent dropdown)
        async function linkPreviousJobCard() {
            const input = document.getElementById('previous_job_number');
            const statusEl = document.getElementById('previousJobLinkStatus');
            const hiddenId = document.getElementById('previous_job_card_id');
            const parentSelect = document.getElementById('parent_work_order_id');
            if (!input || !statusEl || !hiddenId) return;

            const jobNumber = (input.value || '').trim();
            if (!jobNumber) {
                hiddenId.value = '';
                statusEl.textContent = '';
                return;
            }

            statusEl.textContent = 'Linking...';
            hiddenId.value = '';
            try {
                const resp = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/jobcards/lookup?job_number=${encodeURIComponent(jobNumber)}`));
                const data = await resp.json();
                if (!resp.ok) {
                    statusEl.innerHTML = `<span style="color:#a00;">${data?.error?.message || 'Job card not found'}</span>`;
                    return;
                }
                const found = data.data;
                if (!found?.id) {
                    statusEl.innerHTML = `<span style="color:#a00;">Job card not found</span>`;
                    return;
                }
                hiddenId.value = found.id;

                // Ensure it appears in the parent dropdown (so backend uses existing parent_work_order_id linkage)
                if (parentSelect) {
                    let opt = Array.from(parentSelect.options).find(o => String(o.value) === String(found.id));
                    if (!opt) {
                        opt = document.createElement('option');
                        opt.value = found.id;
                        opt.textContent = `${found.job_number}${found.customer_name ? ' - ' + found.customer_name : ''}`;
                        parentSelect.appendChild(opt);
                    }
                    parentSelect.value = String(found.id);
                }

                statusEl.innerHTML = `<span style="color:#28a745;">Linked:</span> <strong>${found.job_number}</strong>${found.customer_name ? ' - ' + found.customer_name : ''}`;

                // Auto-load previous job details and fill fields (#9)
                await applyPreviousJobDetails(found.id);
            } catch (err) {
                console.error('Link previous job error:', err);
                statusEl.innerHTML = `<span style="color:#a00;">Error linking job: ${err.message}</span>`;
            }
        }

        function safeParseJson(value) {
            if (value == null) return null;
            if (typeof value === 'object') return value;
            if (typeof value !== 'string') return null;
            try { return JSON.parse(value); } catch { return null; }
        }

        async function applyPreviousJobDetails(jobCardId) {
            const box = document.getElementById('previousJobSummaryBox');
            const content = document.getElementById('previousJobSummaryContent');
            if (box && content) {
                box.style.display = 'block';
                content.innerHTML = 'Loading previous job details...';
            }

            try {
                // 1) Fetch previous job card full details (includes assignments)
                const jcResp = await apiFetch(addBusinessUnitFilter(`${API_BASE_URL}/jobcards/${jobCardId}`));
                const jc = await jcResp.json();
                if (!jcResp.ok) {
                    const msg = jc?.error?.message || 'Failed to load previous job card';
                    if (content) content.innerHTML = `<span style="color:#a00;">${msg}</span>`;
                    return;
                }

                const meta = safeParseJson(jc.metadata) || jc.metadata || {};
                const wod = meta?.work_order_details || {};
                const prevComplaint = wod.complaint || wod.problem_description || null;
                const prevCondition = wod.bike_condition_review || null;
                const prevCategory = wod.job_category || null;

                // 2) Auto-fill fields if they are empty (do not overwrite user input)
                const workTypeEl = document.getElementById('work_type');
                if (workTypeEl && !workTypeEl.value && jc.work_type) {
                    // Ensure the option exists (setting a <select> value to a non-existing option will silently fail)
                    const hasOption = Array.from(workTypeEl.options || []).some(o => String(o.value) === String(jc.work_type));
                    if (!hasOption) {
                        const opt = document.createElement('option');
                        opt.value = jc.work_type;
                        opt.textContent = jc.work_type;
                        workTypeEl.appendChild(opt);
                    }
                    workTypeEl.value = jc.work_type;
                }

                const complaintEl = document.getElementById('problem_description');
                if (complaintEl && !complaintEl.value && prevComplaint) {
                    complaintEl.value = prevComplaint;
                }

                const conditionEl = document.getElementById('bike_condition_review');
                if (conditionEl && !conditionEl.value && prevCondition) {
                    conditionEl.value = prevCondition;
                }

                const categoryEl = document.getElementById('job_category');
                if (categoryEl && prevCategory) {
                    // If user hasn't changed the category (still default), we can apply previous category.
                    const current = String(categoryEl.value || '');
                    const isDefault = current === 'service'; // default option
                    const canSet = ['service', 'complaint'].includes(String(prevCategory));
                    if (canSet && isDefault) {
                        categoryEl.value = String(prevCategory);
                    }
                }

                // 3) If previous job has asset_id and current selection is empty, link it
                const assetSelect = document.getElementById('asset_id');
                if (assetSelect && !assetSelect.value && jc.asset_id) {
                    let opt = Array.from(assetSelect.options).find(o => String(o.value) === String(jc.asset_id));
                    if (!opt) {
                        opt = document.createElement('option');
                        opt.value = jc.asset_id;
                        opt.textContent = jc.asset_name
                            ? `${jc.asset_name}${jc.asset_tag ? ' (' + jc.asset_tag + ')' : ''}${jc.asset_serial_number ? ' - ' + jc.asset_serial_number : ''}`
                            : `Asset #${jc.asset_id}`;
                        assetSelect.appendChild(opt);
                    }
                    assetSelect.value = String(jc.asset_id);
                }

                // 4) Fetch parts used on previous job
                let partsRows = [];
                try {
                    const partsResp = await apiFetch(`${API_BASE_URL}/work-orders/${jobCardId}/parts`);
                    const partsData = await partsResp.json().catch(() => ({}));
                    if (partsResp.ok) partsRows = partsData.data || [];
                } catch (_) {
                    partsRows = [];
                }

                // 5) Render summary panel
                const assignedTechs = Array.isArray(jc.assignments) ? jc.assignments.map(a => a.technician_name).filter(Boolean) : [];
                const techLine = assignedTechs.length ? assignedTechs.join(', ') : '-';
                const when = jc.created_at ? new Date(jc.created_at) : null;
                const whenText = when && !isNaN(when.getTime()) ? when.toLocaleString() : (jc.created_at || '');

                let partsHtml = '';
                if (partsRows.length > 0) {
                    partsHtml = '<div style="margin-top:8px;"><strong>Parts Used:</strong><ul style="margin:6px 0 0 18px;">';
                    partsRows.slice(0, 10).forEach(p => {
                        partsHtml += `<li>${p.part_name || p.part_number || 'Part'}${p.part_number ? ' (' + p.part_number + ')' : ''} ‚Äî Qty: ${p.quantity || 1}</li>`;
                    });
                    if (partsRows.length > 10) partsHtml += `<li>‚Ä¶and ${partsRows.length - 10} more</li>`;
                    partsHtml += '</ul></div>';
                } else {
                    partsHtml = '<div style="margin-top:8px; color:#666;">No parts recorded on previous job.</div>';
                }

                if (content) {
                    content.innerHTML = `
                        <div><strong>Job:</strong> ${jc.job_number || ''} <span style="color:#666;">${whenText ? '(' + whenText + ')' : ''}</span></div>
                        <div style="margin-top:6px;"><strong>Work Type:</strong> ${jc.work_type || '-'}</div>
                        <div style="margin-top:6px;"><strong>Technician(s):</strong> ${techLine}</div>
                        ${prevComplaint ? `<div style="margin-top:6px;"><strong>Complaint:</strong> ${prevComplaint}</div>` : ''}
                        ${prevCondition ? `<div style="margin-top:6px;"><strong>Condition:</strong> ${prevCondition}</div>` : ''}
                        ${prevCategory ? `<div style="margin-top:6px;"><strong>Category:</strong> ${prevCategory}</div>` : ''}
                        ${partsHtml}
                        <div style="margin-top:10px; color:#666; font-size:0.85em;">
                            Auto-fill rule: fields are only filled if currently empty (so staff can override).
                        </div>
                    `;
                }
            } catch (err) {
                console.error('applyPreviousJobDetails error:', err);
                if (content) content.innerHTML = `<span style="color:#a00;">Error loading previous job details: ${err.message}</span>`;
            }
        }

        // Create Job Card: accordion helpers (layout-only, no data logic changes)
        function getJobCardSections() {
            return Array.from(document.querySelectorAll('#createJobCardModal .acc-section'));
        }

        function toggleJobCardSection(key) {
            const el = document.querySelector(`#createJobCardModal .acc-section[data-acc="${key}"]`);
            if (!el) return;
            el.classList.toggle('open');
        }

        function expandAllJobCardSections() {
            getJobCardSections().forEach(s => s.classList.add('open'));
        }

        function collapseAllJobCardSections() {
            // Collapse everything (user requested this as the default view)
            getJobCardSections().forEach(s => s.classList.remove('open'));
            const scrollEl = document.getElementById('createJobCardScroll');
            if (scrollEl) scrollEl.scrollTop = 0;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('previous_job_number');
            if (!input) return;
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    linkPreviousJobCard();
                }
            });
        });
        
        // Barcode scanner modal
        function openBarcodeScanner(entityType) {
            const modal = document.createElement('div');
            modal.id = 'barcodeScannerModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>Scan Barcode/QR Code</h2>
                        <span class="close" onclick="closeBarcodeScanner()">&times;</span>
                    </div>
                    <div class="form-group">
                        <label>Enter or Scan Barcode/QR Code:</label>
                        <input type="text" id="barcodeInput" placeholder="Scan or type barcode/QR code..." style="width: 100%; padding: 10px; font-size: 16px;" autofocus>
                        <button type="button" class="btn-primary" onclick="scanBarcode('${entityType}')" style="margin-top: 10px; width: 100%;">Scan</button>
                    </div>
                    <div id="barcodeResult" style="margin-top: 20px;"></div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Auto-focus and allow Enter key
            setTimeout(() => {
                const input = document.getElementById('barcodeInput');
                if (input) {
                    input.focus();
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            scanBarcode(entityType);
                        }
                    });
                }
            }, 100);
        }
        
        function closeBarcodeScanner() {
            const modal = document.getElementById('barcodeScannerModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Scan barcode and link to form
        async function scanBarcode(entityType) {
            const barcodeInput = document.getElementById('barcodeInput');
            const resultDiv = document.getElementById('barcodeResult');
            const barcode = barcodeInput.value.trim();
            
            if (!barcode) {
                resultDiv.innerHTML = '<p style="color: red;">Please enter a barcode/QR code</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p>Scanning...</p>';
            
            try {
                const response = await apiFetch(`${API_BASE_URL}/barcode/scan`, {
                    method: 'POST',
                    body: JSON.stringify({
                        barcode: barcode,
                        qr_code: barcode
                    })
                });
                
                const data = await response.json();
                
                if (data.found && data.entity_type === entityType) {
                    // Found matching entity
                    if (entityType === 'asset') {
                        const assetSelect = document.getElementById('asset_id');
                        if (assetSelect) {
                            assetSelect.value = data.entity.id;
                            resultDiv.innerHTML = `<p style="color: green;">‚úì Asset found: ${data.entity.name}</p>`;
                            setTimeout(() => {
                                closeBarcodeScanner();
                            }, 1500);
                        }
                    } else {
                        resultDiv.innerHTML = `<p style="color: green;">‚úì Found: ${data.entity.name || data.entity.job_number}</p>`;
                    }
                } else if (data.found) {
                    resultDiv.innerHTML = `<p style="color: orange;">Found ${data.entity_type}, but expected ${entityType}</p>`;
                } else {
                    resultDiv.innerHTML = '<p style="color: red;">No entity found with this barcode/QR code</p>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }
        
        let fieldVisibilitySettings = null;

        // Load field visibility settings for current user's Business Unit
        async function loadFieldVisibilitySettings() {
            try {
                const response = await apiFetch(`${API_BASE_URL}/field-visibility/my-bu`);
                const data = await response.json();
                
                if (response.ok && data.data) {
                    fieldVisibilitySettings = data.data;
                    userBusinessUnitId = data.data.business_unit_id;
                    applyFieldVisibility();
                } else {
                    console.warn('Could not load field visibility settings, using defaults');
                    fieldVisibilitySettings = null;
                }
            } catch (error) {
                console.error('Error loading field visibility:', error);
                fieldVisibilitySettings = null;
            }
        }

        // Apply field visibility rules to the form
        function applyFieldVisibility() {
            if (!fieldVisibilitySettings || !fieldVisibilitySettings.sections) {
                return;
            }

            const form = document.getElementById('createJobCardForm');
            if (!form) return;

            const fieldMap = {
                'customer_name': 'customer_info.customer_name',
                'customer_email': 'customer_info.customer_email',
                'customer_phone': 'customer_info.customer_phone',
                'customer_address': 'customer_info.customer_address',
                'vehicle_make': 'vehicle_info.make',
                'vehicle_model': 'vehicle_info.model',
                'vehicle_year': 'vehicle_info.year',
                'vehicle_vin': 'vehicle_info.vin',
                'vehicle_license': 'vehicle_info.license_plate',
                'vehicle_odometer': 'vehicle_info.odometer',
                'work_type': 'work_order_details.work_type',
                'problem_description': 'work_order_details.problem_description',
                'bike_condition_review': 'work_order_details.bike_condition_review',
                'job_category': 'work_order_details.job_category',
                'previous_job_number': 'work_order_details.previous_job_number',
                'estimated_hours': 'work_order_details.estimated_hours',
                'priority': 'work_order_details.priority',
                'notes': 'work_order_details.notes',
                'location_id': 'location_assignment.location_id'
            };

            fieldVisibilitySettings.sections.forEach(section => {
                section.fields.forEach(field => {
                    const fieldKey = `${section.section_name}.${field.field_name}`;
                    const fieldId = Object.keys(fieldMap).find(id => fieldMap[id] === fieldKey);
                    
                    if (fieldId) {
                        const fieldElement = document.getElementById(fieldId);
                        const formGroup = fieldElement?.closest('.form-group');
                        
                        if (formGroup) {
                            if (!field.is_visible) {
                                formGroup.style.display = 'none';
                                fieldElement.removeAttribute('required');
                            } else {
                                formGroup.style.display = '';
                                const label = formGroup.querySelector('label');
                                if (label && field.custom_label) {
                                    label.textContent = field.custom_label + (field.is_required ? ' *' : '');
                                } else if (label && field.is_required) {
                                    if (!label.textContent.includes('*')) {
                                        label.textContent += ' *';
                                    }
                                }
                                if (field.is_required) {
                                    fieldElement.setAttribute('required', 'required');
                                } else {
                                    fieldElement.removeAttribute('required');
                                }
                                if (field.custom_help_text) {
                                    let helpText = formGroup.querySelector('small');
                                    if (!helpText) {
                                        helpText = document.createElement('small');
                                        helpText.style.cssText = 'color: #666; display: block; margin-top: 5px;';
                                        formGroup.appendChild(helpText);
                                    }
                                    helpText.textContent = field.custom_help_text;
                                }
                            }
                        }
                    }
                });
            });
        }

        // Load job types from user's Business Unit
        async function loadBusinessUnitJobTypes() {
            try {
                const response = await apiFetch(`${API_BASE_URL}/business-unit-job-types/my-bu`);
                const data = await response.json();
                
                const jobTypeSelect = document.getElementById('job_type');
                const workTypeSelect = document.getElementById('work_type');
                
                const jobTypes = (response.ok && data.data && data.data.length > 0) 
                    ? data.data.filter(jt => jt.is_active)
                    : null;
                
                const defaultTypes = ['Mechanical', 'Electrical', 'Body Shop', 'Diagnostics', 'Maintenance', 'Other'];
                
                // Populate job_type dropdown if it exists
                if (jobTypeSelect) {
                    jobTypeSelect.innerHTML = '<option value="">Select job type...</option>';
                    
                    if (jobTypes) {
                        jobTypes.forEach(jobType => {
                            const option = document.createElement('option');
                            option.value = jobType.job_type_code;
                            option.textContent = jobType.job_type_name;
                            jobTypeSelect.appendChild(option);
                        });
                    } else {
                        defaultTypes.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type;
                            jobTypeSelect.appendChild(option);
                        });
                    }
                }
                
                // Populate work_type dropdown if it exists
                if (workTypeSelect) {
                    workTypeSelect.innerHTML = '<option value="">Select work type...</option>';
                    
                    if (jobTypes) {
                        jobTypes.forEach(jobType => {
                            const option = document.createElement('option');
                            option.value = jobType.job_type_name;
                            option.textContent = jobType.job_type_name;
                            workTypeSelect.appendChild(option);
                        });
                    } else {
                        defaultTypes.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type;
                            workTypeSelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading job types:', error);
                // Fallback to default types on error
                const workTypeSelect = document.getElementById('work_type');
                if (workTypeSelect && workTypeSelect.options.length <= 1) {
                    const defaultTypes = ['Mechanical', 'Electrical', 'Body Shop', 'Diagnostics', 'Maintenance', 'Other'];
                    defaultTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        workTypeSelect.appendChild(option);
                    });
                }
            }
        }

        // Open create job card modal
        function openCreateJobCardModal() {
            document.getElementById('createJobCardModal').style.display = 'block';
            document.getElementById('createJobCardForm').reset();
            document.getElementById('job_number_error').style.display = 'none';
            document.getElementById('edit_job_card_id').value = '';
            const titleEl = document.getElementById('createJobCardModalTitle');
            if (titleEl) titleEl.textContent = 'Create New Job Card';
            const jobNumberEl = document.getElementById('job_number');
            if (jobNumberEl) jobNumberEl.disabled = false;
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.disabled = false; // reset in case it was left disabled from a prior submit
                submitBtn.textContent = 'Create Job Card';
            }
            const partsBtn = document.getElementById('createJobCardPartsBtn');
            if (partsBtn) {
                partsBtn.classList.add('btn-pseudo-disabled');
                partsBtn.title = 'Save the job card first to add parts';
                partsBtn.dataset.jobNumber = '';
            }
            // Always start in the collapsed "section list" view (default UX)
            collapseAllJobCardSections();
            loadLocations();
            loadAssets();
            loadParentWorkOrders();
            loadBusinessUnitJobTypes();
            loadFieldVisibilitySettings().then(() => {
                applyFieldVisibility();
            });
        }

        // Open edit job card modal (Service Advisor)
        async function openEditJobCardModal(jobCardId) {
            try {
                document.getElementById('createJobCardModal').style.display = 'block';
                document.getElementById('createJobCardForm').reset();
                document.getElementById('job_number_error').style.display = 'none';
                document.getElementById('edit_job_card_id').value = String(jobCardId);

                const titleEl = document.getElementById('createJobCardModalTitle');
                if (titleEl) titleEl.textContent = 'Edit Job Card';
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.disabled = false; // reset in case it was left disabled from a prior submit
                    submitBtn.textContent = 'Save Changes';
                }
                const partsBtn = document.getElementById('createJobCardPartsBtn');
                if (partsBtn) {
                    partsBtn.classList.remove('btn-pseudo-disabled');
                    partsBtn.title = 'Manage parts used on this job card';
                }

                // Collapsed by default
                collapseAllJobCardSections();

                // Load dropdown data first (so we can set selected values)
                await loadLocations();
                await loadAssets();
                await loadParentWorkOrders();
                await loadBusinessUnitJobTypes();
                await loadFieldVisibilitySettings();
                applyFieldVisibility();

                const resp = await apiFetch(`${API_BASE_URL}/jobcards/${jobCardId}`);
                const job = await resp.json();
                if (!resp.ok) {
                    alert(job?.error?.message || 'Failed to load job card');
                    return;
                }

                // Core fields
                const jobNumberEl = document.getElementById('job_number');
                if (jobNumberEl) {
                    jobNumberEl.value = job.job_number || '';
                    jobNumberEl.disabled = true; // job number should not be edited
                }
                if (partsBtn) partsBtn.dataset.jobNumber = job.job_number || '';
                const custEl = document.getElementById('customer_name');
                if (custEl) custEl.value = job.customer_name || '';

                // Vehicle info
                let vehicleInfo = job.vehicle_info;
                if (typeof vehicleInfo === 'string') {
                    try { vehicleInfo = JSON.parse(vehicleInfo); } catch { vehicleInfo = {}; }
                }
                vehicleInfo = vehicleInfo && typeof vehicleInfo === 'object' ? vehicleInfo : {};
                if (document.getElementById('vehicle_make')) document.getElementById('vehicle_make').value = vehicleInfo.make || '';
                if (document.getElementById('vehicle_model')) document.getElementById('vehicle_model').value = vehicleInfo.model || '';
                if (document.getElementById('vehicle_year')) document.getElementById('vehicle_year').value = vehicleInfo.year || '';
                if (document.getElementById('vehicle_vin')) document.getElementById('vehicle_vin').value = vehicleInfo.vin || '';
                if (document.getElementById('vehicle_license')) document.getElementById('vehicle_license').value = vehicleInfo.license_plate || '';
                if (document.getElementById('vehicle_odometer')) document.getElementById('vehicle_odometer').value = vehicleInfo.odometer || '';

                // Work type (ensure option exists)
                const workTypeEl = document.getElementById('work_type');
                if (workTypeEl && job.work_type) {
                    const hasOpt = Array.from(workTypeEl.options || []).some(o => String(o.value) === String(job.work_type));
                    if (!hasOpt) {
                        const opt = document.createElement('option');
                        opt.value = job.work_type;
                        opt.textContent = job.work_type;
                        workTypeEl.appendChild(opt);
                    }
                    workTypeEl.value = job.work_type;
                }

                // Priority / estimate
                if (document.getElementById('priority') && job.priority) document.getElementById('priority').value = String(job.priority);
                if (document.getElementById('estimated_hours')) document.getElementById('estimated_hours').value = job.estimated_hours != null ? String(job.estimated_hours) : '';

                // Location / asset / job_type / parent link
                if (document.getElementById('location_id')) document.getElementById('location_id').value = job.location_id || '';
                if (document.getElementById('asset_id')) document.getElementById('asset_id').value = job.asset_id || '';
                if (document.getElementById('job_type')) document.getElementById('job_type').value = job.job_type || '';
                if (document.getElementById('parent_work_order_id')) document.getElementById('parent_work_order_id').value = job.parent_work_order_id || '';

                // Metadata fields
                let meta = job.metadata;
                if (typeof meta === 'string') {
                    try { meta = JSON.parse(meta); } catch { meta = {}; }
                }
                meta = meta && typeof meta === 'object' ? meta : {};
                const wod = meta.work_order_details && typeof meta.work_order_details === 'object' ? meta.work_order_details : {};

                const complaintVal = wod.complaint || wod.problem_description || '';
                const conditionVal = wod.bike_condition_review || '';
                const categoryVal = wod.job_category || '';
                const prevJobNumVal = wod.previous_job_number || '';

                if (document.getElementById('problem_description')) document.getElementById('problem_description').value = complaintVal || '';
                if (document.getElementById('bike_condition_review')) document.getElementById('bike_condition_review').value = conditionVal || '';
                if (document.getElementById('job_category') && categoryVal) document.getElementById('job_category').value = String(categoryVal);
                if (document.getElementById('previous_job_number')) document.getElementById('previous_job_number').value = prevJobNumVal || '';
                if (document.getElementById('previous_job_card_id')) document.getElementById('previous_job_card_id').value = '';

                // Keep notes as-is (job notes are separate objects; we don't edit here)
            } catch (err) {
                alert('Error opening edit: ' + err.message);
            }
        }

        function openPartsForCurrentJobCard() {
            const jobCardId = document.getElementById('edit_job_card_id')?.value;
            const jobNumber = document.getElementById('createJobCardPartsBtn')?.dataset?.jobNumber || '';
            if (!jobCardId) {
                alert('Please create/save the job card first. After saving, you can add parts to it.');
                return;
            }
            viewWorkOrderParts(jobCardId, jobNumber || ('Job #' + jobCardId));
        }

        // Close create job card modal
        function closeCreateJobCardModal() {
            document.getElementById('createJobCardModal').style.display = 'none';
            document.getElementById('createJobCardForm').reset();
        }

        // Handle create job card form submission
        document.getElementById('createJobCardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const editId = document.getElementById('edit_job_card_id')?.value;

            // Always re-enable the button if an exception happens before our existing try/catch.
            try {
                // Custom validation (because required fields can be dynamically shown/hidden)
                try {
                    const formEl = document.getElementById('createJobCardForm');

                    function isVisible(el) {
                        if (!el) return false;
                        const fg = el.closest('.form-group') || el;
                        if (fg && fg.style && fg.style.display === 'none') return false;
                        return !!(el.offsetParent || el.getClientRects().length);
                    }

                    function openAccSectionForField(fieldId) {
                        const map = {
                            job_number: 'job',
                            customer_name: 'job',
                            customer_email: 'job',
                            customer_phone: 'job',
                            customer_address: 'job',
                            vehicle_make: 'vehicle',
                            vehicle_model: 'vehicle',
                            vehicle_year: 'vehicle',
                            vehicle_vin: 'vehicle',
                            vehicle_license: 'vehicle',
                            vehicle_odometer: 'vehicle',
                            work_type: 'work',
                            problem_description: 'work',
                            bike_condition_review: 'work',
                            estimated_hours: 'work',
                            priority: 'work',
                            location_id: 'assignment',
                            job_type: 'assignment',
                            asset_id: 'assignment',
                            parent_work_order_id: 'assignment',
                            job_category: 'assignment',
                            previous_job_number: 'assignment'
                        };
                        const sectionKey = map[fieldId];
                        if (!sectionKey) return;
                        const section = document.querySelector(`.acc-section[data-acc="${sectionKey}"]`);
                        if (section && !section.classList.contains('open')) {
                            section.classList.add('open');
                        }
                    }

                    const requiredEls = Array.from(formEl.querySelectorAll('[required]'));
                    const missing = [];
                    for (const el of requiredEls) {
                        if (!isVisible(el)) continue;
                        const v = (el.value ?? '').toString().trim();
                        if (!v) missing.push(el);
                    }

                    if (missing.length > 0) {
                        const first = missing[0];
                        openAccSectionForField(first.id);
                        setTimeout(() => {
                            try {
                                first.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                first.focus({ preventScroll: true });
                            } catch {}
                        }, 30);

                        const names = missing.slice(0, 6).map(el => {
                            const label = formEl.querySelector(`label[for="${el.id}"]`);
                            return (label?.textContent || el.name || el.id || 'Field').replace(/\*/g, '').trim();
                        });
                        const more = missing.length > 6 ? ` (+${missing.length - 6} more)` : '';
                        alert(`Please fill the required fields before saving: ${names.join(', ')}${more}`);
                        return;
                    }
                } catch (validationErr) {
                    console.warn('Custom validation error (non-fatal):', validationErr);
                }

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = editId ? 'Saving...' : 'Creating...';
                }

                const getVal = (id) => document.getElementById(id)?.value;
                const getTrim = (id) => (getVal(id) || '').toString().trim();
                const isGroupVisible = (id) => {
                    const el = document.getElementById(id);
                    const fg = el?.closest('.form-group');
                    if (!el || !fg) return false;
                    if (fg.style && fg.style.display === 'none') return false;
                    return true;
                };

                // Build form data based on visible fields
                const formData = {
                    job_number: getTrim('job_number'),
                    customer_name: getTrim('customer_name'),
                    vehicle_info: {},
                    work_type: getTrim('work_type') || null,
                    job_category: (document.getElementById('job_category') && isGroupVisible('job_category'))
                        ? (getVal('job_category') || 'service')
                        : undefined,
                    priority: parseInt(getVal('priority') || '3', 10),
                    estimated_hours: getVal('estimated_hours') ? parseFloat(getVal('estimated_hours')) : null,
                    location_id: getVal('location_id') || null,
                    job_type: getVal('job_type') || null,
                    asset_id: getVal('asset_id') || null,
                    parent_work_order_id: getVal('previous_job_card_id') || getVal('parent_work_order_id') || null,
                    previous_job_number: (document.getElementById('previous_job_number') && isGroupVisible('previous_job_number'))
                        ? (getTrim('previous_job_number') || null)
                        : undefined,
                    notes: getTrim('notes') || null
                };

                // Add customer fields if visible
                if (document.getElementById('customer_email') && isGroupVisible('customer_email')) formData.customer_email = getTrim('customer_email') || null;
                if (document.getElementById('customer_phone') && isGroupVisible('customer_phone')) formData.customer_phone = getTrim('customer_phone') || null;
                if (document.getElementById('customer_address') && isGroupVisible('customer_address')) formData.customer_address = getTrim('customer_address') || null;

                // Add vehicle fields if visible
                if (document.getElementById('vehicle_make') && isGroupVisible('vehicle_make')) formData.vehicle_info.make = getTrim('vehicle_make') || null;
                if (document.getElementById('vehicle_model') && isGroupVisible('vehicle_model')) formData.vehicle_info.model = getTrim('vehicle_model') || null;
                if (document.getElementById('vehicle_year') && isGroupVisible('vehicle_year')) formData.vehicle_info.year = getVal('vehicle_year') ? parseInt(getVal('vehicle_year'), 10) : null;
                if (document.getElementById('vehicle_vin') && isGroupVisible('vehicle_vin')) formData.vehicle_info.vin = getTrim('vehicle_vin') || null;
                if (document.getElementById('vehicle_license') && isGroupVisible('vehicle_license')) formData.vehicle_info.license_plate = getTrim('vehicle_license') || null;
                if (document.getElementById('vehicle_odometer') && isGroupVisible('vehicle_odometer')) formData.vehicle_info.odometer = getVal('vehicle_odometer') ? parseInt(getVal('vehicle_odometer'), 10) : null;

                // Add problem description if visible
                if (document.getElementById('problem_description') && isGroupVisible('problem_description')) formData.problem_description = getTrim('problem_description') || null;
                // Add bike condition review if visible
                if (document.getElementById('bike_condition_review') && isGroupVisible('bike_condition_review')) formData.bike_condition_review = getTrim('bike_condition_review') || null;

                // Remove null values from vehicle_info
                Object.keys(formData.vehicle_info).forEach(key => {
                    if (formData.vehicle_info[key] === null || formData.vehicle_info[key] === '') delete formData.vehicle_info[key];
                });

                const url = editId ? `${API_BASE_URL}/jobcards/${encodeURIComponent(editId)}` : `${API_BASE_URL}/jobcards`;
                const method = editId ? 'PATCH' : 'POST';

                // For PATCH, do not send job_number (immutable)
                if (editId) {
                    delete formData.job_number;
                    delete formData.notes; // notes are a separate entity; keep for create-only UI
                    // If vehicle_info ended up empty, omit it to avoid wiping
                    if (!formData.vehicle_info || Object.keys(formData.vehicle_info).length === 0) delete formData.vehicle_info;
                }

                const response = await apiFetch(url, {
                    method,
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    // Success - close modal and refresh job cards
                    console.log(editId ? 'Job card updated successfully:' : 'Job card created successfully:', data);
                    // Force reload job cards
                    setTimeout(() => { loadJobCards(); }, 300);

                    if (!editId && data?.id) {
                        // Switch into "Edit" mode so parts can be managed immediately from the same modal
                        document.getElementById('edit_job_card_id').value = String(data.id);
                        const titleEl = document.getElementById('createJobCardModalTitle');
                        if (titleEl) titleEl.textContent = 'Edit Job Card';
                        const jobNumberEl = document.getElementById('job_number');
                        if (jobNumberEl) jobNumberEl.disabled = true;
                        const partsBtn = document.getElementById('createJobCardPartsBtn');
                        if (partsBtn) {
                            partsBtn.classList.remove('btn-pseudo-disabled');
                            partsBtn.title = 'Manage parts used on this job card';
                            partsBtn.dataset.jobNumber = data.job_number || '';
                        }
                        const submitBtnEl = document.getElementById('submitBtn');
                        if (submitBtnEl) {
                            submitBtnEl.disabled = false; // allow immediate edits after create
                            submitBtnEl.textContent = 'Save Changes';
                        }

                        // Now open parts modal (after user dismisses the success alert)
                        alert('Job card created successfully! Now add parts if needed.');
                        setTimeout(() => {
                            viewWorkOrderParts(data.id, data.job_number || '');
                        }, 50);
                    } else {
                        alert(editId ? 'Job card updated successfully!' : ('Job card created successfully! Job Number: ' + data.job_number));
                        closeCreateJobCardModal();
                    }
                } else {
                    // Show error
                    if (data.error?.code === 'RESOURCE_CONFLICT' && data.error?.message?.includes('already exists')) {
                        document.getElementById('job_number_error').textContent = 'Job number already exists. Please use a different number.';
                        document.getElementById('job_number_error').style.display = 'block';
                    } else {
                        alert('Error: ' + (data.error?.message || 'Failed to create job card'));
                    }
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = editId ? 'Save Changes' : 'Create Job Card';
                    }
                }
            } catch (error) {
                alert((editId ? 'Error updating job card: ' : 'Error creating job card: ') + error.message);
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = editId ? 'Save Changes' : 'Create Job Card';
                }
            } finally {
                // Safety net: never leave the button stuck disabled due to a JS error.
                if (submitBtn && submitBtn.disabled) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = editId ? 'Save Changes' : 'Create Job Card';
                }
            }
        });

        // Plate history (previous complaints / bike condition reviews)
        let plateHistoryTimer = null;
        async function loadPlateHistory() {
            const plateInput = document.getElementById('vehicle_license');
            const box = document.getElementById('plateHistoryBox');
            const content = document.getElementById('plateHistoryContent');
            if (!plateInput || !box || !content) return;

            const plate = (plateInput.value || '').trim();
            if (!plate) {
                box.style.display = 'none';
                content.innerHTML = '';
                return;
            }

            box.style.display = 'block';
            content.innerHTML = 'Loading history...';
            try {
                const resp = await apiFetch(`${API_BASE_URL}/jobcards/plate-history?license_plate=${encodeURIComponent(plate)}&limit=5`);
                const data = await resp.json();
                if (!resp.ok) {
                    const msg = data?.error?.message || 'Failed to load plate history';
                    const details = data?.error?.details ? `<div style="margin-top:6px; color:#a00; font-size:0.85em; white-space:pre-wrap;">${String(data.error.details)}</div>` : '';
                    content.innerHTML = `<span style="color:#a00;">${msg}</span>${details}`;
                    return;
                }
                const rows = data.data || [];
                if (rows.length === 0) {
                    content.innerHTML = 'No previous history found for this plate.';
                    return;
                }
                let html = '<div style="display:flex; flex-direction:column; gap:10px;">';
                rows.forEach(r => {
                    const dt = r.created_at ? new Date(r.created_at) : null;
                    const when = dt && !isNaN(dt.getTime()) ? dt.toLocaleString() : (r.created_at || '');
                    html += `
                        <div style="padding:10px; background:#fff; border:1px solid #eee; border-radius:8px;">
                            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                                <div style="font-weight:800; color:#333;">${r.job_number}</div>
                                <div style="color:#666; font-size:0.85em;">${when}</div>
                            </div>
                            ${r.complaint ? `<div style="margin-top:6px;"><strong>Complaint:</strong> <span style="color:#444;">${r.complaint}</span></div>` : ''}
                            ${r.bike_condition_review ? `<div style="margin-top:6px;"><strong>Condition:</strong> <span style="color:#444;">${r.bike_condition_review}</span></div>` : ''}
                            ${(!r.complaint && !r.bike_condition_review) ? `<div style="margin-top:6px; color:#666;">No complaint/condition recorded on this job.</div>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
                content.innerHTML = html;
            } catch (err) {
                content.innerHTML = `<span style="color:#a00;">Error loading plate history: ${err.message}</span>`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const plateInput = document.getElementById('vehicle_license');
            if (!plateInput) return;
            plateInput.addEventListener('input', () => {
                if (plateHistoryTimer) clearTimeout(plateHistoryTimer);
                plateHistoryTimer = setTimeout(loadPlateHistory, 350);
            });
            plateInput.addEventListener('change', () => {
                if (plateHistoryTimer) clearTimeout(plateHistoryTimer);
                plateHistoryTimer = setTimeout(loadPlateHistory, 50);
            });
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['createJobCardModal', 'assignModal', 'reassignModal', 'reportModal', 
                           'jobHistoryModal', 'workOrderPartsModal', 'assetMovementsModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    if (modalId === 'createJobCardModal') closeCreateJobCardModal();
                    else if (modalId === 'assignModal') closeAssignModal();
                    else if (modalId === 'reassignModal') closeReassignModal();
                    else if (modalId === 'reportModal') closeReportModal();
                    else if (modalId === 'jobHistoryModal') closeJobHistoryModal();
                    else if (modalId === 'workOrderPartsModal') closeWorkOrderPartsModal();
                    else if (modalId === 'assetMovementsModal') closeAssetMovementsModal();
                }
            });
        }

        // Update part cost when part is selected
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const partSelect = document.getElementById('partSelect');
                const unitCostInput = document.getElementById('partUnitCost');
                if (partSelect && unitCostInput) {
                    partSelect.addEventListener('change', function() {
                        if (this.selectedOptions[0] && this.selectedOptions[0].dataset.cost) {
                            unitCostInput.value = parseFloat(this.selectedOptions[0].dataset.cost).toFixed(2);
                        }
                    });
                }
            }, 1000);
        });

        // Logout
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
        }

        // View Job History
        async function viewJobHistory(workOrderId, jobNumber) {
            try {
                const response = await apiFetch(`${API_BASE_URL}/job-history/work-order/${workOrderId}`);
                const data = await response.json();
                
                if (response.ok) {
                    let historyHtml = `<h3>Job History: ${jobNumber}</h3>`;
                    if (data.data && data.data.length > 0) {
                        historyHtml += '<table><tr><th>Date</th><th>Action</th><th>Technician</th><th>Status</th><th>Notes</th></tr>';
                        data.data.forEach(entry => {
                            const date = new Date(entry.created_at).toLocaleString();
                            historyHtml += `
                                <tr>
                                    <td>${date}</td>
                                    <td><span class="badge">${entry.action_type || '-'}</span></td>
                                    <td>${entry.technician_name || '-'}</td>
                                    <td><span class="badge ${entry.status || ''}">${entry.status || '-'}</span></td>
                                    <td>${entry.notes || '-'}</td>
                                </tr>
                            `;
                        });
                        historyHtml += '</table>';
                    } else {
                        historyHtml += '<p>No history found for this work order.</p>';
                    }
                    
                    document.getElementById('jobHistoryContent').innerHTML = historyHtml;
                    document.getElementById('jobHistoryModal').style.display = 'block';
                } else {
                    alert('Error loading job history: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading job history:', error);
                alert('Error loading job history: ' + error.message);
            }
        }

        // View/Manage Work Order Parts
        async function viewWorkOrderParts(workOrderId, jobNumber) {
            try {
                const response = await apiFetch(`${API_BASE_URL}/work-orders/${workOrderId}/parts`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('workOrderPartsJobNumber').textContent = jobNumber;
                    document.getElementById('workOrderPartsId').value = workOrderId;
                    
                    let partsHtml = '';
                    if (data.data && data.data.length > 0) {
                        partsHtml = '<table><tr><th>Part Name</th><th>Part Number</th><th>Quantity</th><th>Unit Cost</th><th>Total Cost</th><th>Installed By</th><th>Installed At</th><th>Actions</th></tr>';
                        data.data.forEach(part => {
                            const installedAt = part.installed_at ? new Date(part.installed_at).toLocaleString() : '-';
                            partsHtml += `
                                <tr>
                                    <td>${part.part_name || '-'}</td>
                                    <td>${part.part_number || '-'}</td>
                                    <td>${part.quantity || 0}</td>
                                    <td>${formatMoney(part.unit_cost || 0, part.currency_code || 'AED')}</td>
                                    <td>${formatMoney(part.total_cost || 0, part.currency_code || 'AED')}</td>
                                    <td>${part.installed_by_name || '-'}</td>
                                    <td>${installedAt}</td>
                                    <td>
                                        <button class="btn" style="background: #dc3545; color: white; padding: 3px 8px; font-size: 0.8em;" onclick="removePart(${part.id}, ${workOrderId})">Remove</button>
                                    </td>
                                </tr>
                            `;
                        });
                        partsHtml += '</table>';
                    } else {
                        partsHtml = '<p>No parts added to this work order yet.</p>';
                    }
                    
                    document.getElementById('workOrderPartsList').innerHTML = partsHtml;
                    await loadPartsForSelection();
                    document.getElementById('workOrderPartsModal').style.display = 'block';
                } else {
                    alert('Error loading work order parts: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading work order parts:', error);
                alert('Error loading work order parts: ' + error.message);
            }
        }

        // Load parts for selection dropdown
        async function loadPartsForSelection() {
            try {
                const response = await apiFetch(`${API_BASE_URL}/parts`);
                const data = await response.json();
                
                const select = document.getElementById('partSelect');
                select.innerHTML = '<option value="">Select a part...</option>';
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(part => {
                        const option = document.createElement('option');
                        option.value = part.id;
                        option.textContent = `${part.name}${part.part_number ? ' (' + part.part_number + ')' : ''}`;
                        option.dataset.cost = part.cost || 0;
                        option.dataset.currency = (part.currency_code || 'AED');
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading parts:', error);
            }
        }

        // Add part to work order
        async function addPartToWorkOrder() {
            const workOrderId = document.getElementById('workOrderPartsId').value;
            const partId = document.getElementById('partSelect').value;
            const quantity = parseInt(document.getElementById('partQuantity').value) || 1;
            const unitCost = parseFloat(document.getElementById('partUnitCost').value) || 0;
            const currencyCode = normalizeCurrencyCode(document.getElementById('partUnitCurrency')?.value || 'AED');
            const notes = document.getElementById('partNotes').value;

            if (!partId) {
                alert('Please select a part');
                return;
            }

            try {
                const response = await apiFetch(`${API_BASE_URL}/work-orders/${workOrderId}/parts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        part_id: parseInt(partId),
                        quantity: quantity,
                        unit_cost: unitCost,
                        currency_code: currencyCode,
                        notes: notes
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    alert('Part added successfully!');
                    document.getElementById('addPartForm').reset();
                    viewWorkOrderParts(workOrderId, document.getElementById('workOrderPartsJobNumber').textContent);
                    // Refresh inventory list so stock updates immediately
                    loadPartsInventory();
                } else {
                    alert('Error adding part: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding part:', error);
                alert('Error adding part: ' + error.message);
            }
        }

        // Remove part from work order
        async function removePart(partId, workOrderId) {
            if (!confirm('Are you sure you want to remove this part from the work order?')) {
                return;
            }

            try {
                const response = await apiFetch(`${API_BASE_URL}/work-orders/${workOrderId}/parts/${partId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    alert('Part removed successfully!');
                    viewWorkOrderParts(workOrderId, document.getElementById('workOrderPartsJobNumber').textContent);
                    // Refresh inventory list so stock updates immediately
                    loadPartsInventory();
                } else {
                    const data = await response.json();
                    alert('Error removing part: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error removing part:', error);
                alert('Error removing part: ' + error.message);
            }
        }

        // View Asset Movements
        async function viewAssetMovements(assetId, assetName) {
            try {
                const response = await apiFetch(`${API_BASE_URL}/assets/${assetId}/movements`);
                const data = await response.json();
                
                if (response.ok) {
                    let movementsHtml = `<h3>Asset Movements: ${assetName}</h3>`;
                    if (data.data && data.data.length > 0) {
                        movementsHtml += '<table><tr><th>Date</th><th>From Location</th><th>To Location</th><th>Movement Type</th><th>Moved By</th><th>Reason</th></tr>';
                        data.data.forEach(movement => {
                            const movedAt = new Date(movement.moved_at).toLocaleString();
                            movementsHtml += `
                                <tr>
                                    <td>${movedAt}</td>
                                    <td>${movement.from_location_name || 'N/A'}</td>
                                    <td>${movement.to_location_name || '-'}</td>
                                    <td><span class="badge">${movement.movement_type || '-'}</span></td>
                                    <td>${movement.moved_by_name || '-'}</td>
                                    <td>${movement.reason || '-'}</td>
                                </tr>
                            `;
                        });
                        movementsHtml += '</table>';
                    } else {
                        movementsHtml += '<p>No movement history found for this asset.</p>';
                    }
                    
                    document.getElementById('assetMovementsContent').innerHTML = movementsHtml;
                    document.getElementById('assetMovementsModal').style.display = 'block';
                } else {
                    alert('Error loading asset movements: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading asset movements:', error);
                alert('Error loading asset movements: ' + error.message);
            }
        }

        // Close modals
        function closeJobHistoryModal() {
            document.getElementById('jobHistoryModal').style.display = 'none';
        }

        function closeWorkOrderPartsModal() {
            document.getElementById('workOrderPartsModal').style.display = 'none';
        }

        function closeAssetMovementsModal() {
            document.getElementById('assetMovementsModal').style.display = 'none';
        }

        // ============================================================================
        // PARTS INVENTORY MANAGEMENT FUNCTIONS
        // ============================================================================

        // Load parts inventory
        async function loadPartsInventory() {
            try {
                const search = document.getElementById('searchParts')?.value || '';
                let url = addBusinessUnitFilter(`${API_BASE_URL}/parts`);
                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                }
                
                const response = await apiFetch(url);
                const data = await response.json();
                
                const container = document.getElementById('partsInventoryList');
                
                if (data.data && data.data.length > 0) {
                    let html = '<table style="width: 100%;"><thead><tr><th>Part Name</th><th>Part Number</th><th>Category</th><th>Cost</th><th>Stock</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                    
                    data.data.forEach(part => {
                        // Align with BU Admin semantics: status may be 'in_stock'/'out_of_stock' (inventory) OR 'active'/'inactive' (legacy).
                        const normalizedStatus = String(part.status || '').toLowerCase();
                        const isActive = (normalizedStatus === 'active' || normalizedStatus === 'in_stock' || normalizedStatus === 'available');
                        const statusBadge = isActive
                            ? '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.9em;">In Stock</span>'
                            : '<span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.9em;">Out of Stock</span>';
                        
                        html += `
                            <tr>
                                <td><strong>${part.name}</strong></td>
                                <td><code>${part.part_number || 'N/A'}</code></td>
                                <td>${part.category || '-'}</td>
                                <td>${formatMoney(part.cost || 0, part.currency_code || 'AED')}</td>
                                <td>${part.quantity_in_stock || 0}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    <button class="btn-edit" onclick="editPart(${part.id})">Edit</button>
                                    <button class="btn-danger" onclick="deletePart(${part.id}, '${part.name.replace(/'/g, "\\'")}')">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p>No parts found. Click "Add New Part" to create one.</p>';
                }
            } catch (error) {
                console.error('Error loading parts inventory:', error);
                document.getElementById('partsInventoryList').innerHTML = '<p style="color: red;">Error loading parts</p>';
            }
        }

        // Open add part modal
        function openAddPartModal() {
            document.getElementById('partModalTitle').textContent = 'Add New Part';
            document.getElementById('partId').value = '';
            document.getElementById('partForm').reset();
            document.getElementById('partActive').checked = true;
            document.getElementById('partModal').style.display = 'block';
        }

        // Edit part
        async function editPart(partId) {
            try {
                const response = await apiFetch(`${API_BASE_URL}/parts/${partId}`);
                const part = await response.json();
                
                document.getElementById('partModalTitle').textContent = 'Edit Part';
                document.getElementById('partId').value = partId;
                document.getElementById('partName').value = part.name;
                document.getElementById('partNumber').value = part.part_number || '';
                document.getElementById('partDescription').value = part.description || '';
                document.getElementById('partCost').value = part.cost || '';
                document.getElementById('partCurrency').value = (part.currency_code || part.metadata?.currency_code || 'AED');
                document.getElementById('partQuantity').value = part.quantity_in_stock || 0;
                document.getElementById('partCategory').value = part.category || '';
                document.getElementById('partBarcode').value = part.barcode || '';
                {
                    const s = String(part.status || '').toLowerCase();
                    document.getElementById('partActive').checked = (s === 'active' || s === 'in_stock' || s === 'available');
                }
                
                document.getElementById('partModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading part:', error);
                alert('Error loading part: ' + error.message);
            }
        }

        // Close part modal
        function closePartModal() {
            document.getElementById('partModal').style.display = 'none';
            document.getElementById('partForm').reset();
        }

        // Delete part
        async function deletePart(partId, partName) {
            if (!confirm(`Are you sure you want to delete part "${partName}"?`)) {
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE_URL}/parts/${partId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Part deleted successfully!');
                    loadPartsInventory();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error?.message || 'Failed to delete part'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Handle part form submission
        document.addEventListener('DOMContentLoaded', function() {
            const partForm = document.getElementById('partForm');
            if (partForm) {
                partForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const partId = document.getElementById('partId').value;
                    const isEdit = !!partId;
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = isEdit ? 'Updating...' : 'Creating...';
                    
                    try {
                        const partData = {
                            name: document.getElementById('partName').value.trim(),
                            part_number: document.getElementById('partNumber').value.trim(),
                            description: document.getElementById('partDescription').value.trim() || null,
                            cost: parseFloat(document.getElementById('partCost').value) || 0,
                            currency_code: normalizeCurrencyCode(document.getElementById('partCurrency')?.value || 'AED'),
                            quantity_in_stock: parseInt(document.getElementById('partQuantity').value) || 0,
                            category: document.getElementById('partCategory').value.trim() || null,
                            barcode: document.getElementById('partBarcode').value.trim() || null,
                            // Use inventory semantics for BU consistency
                            status: document.getElementById('partActive').checked ? 'in_stock' : 'out_of_stock'
                        };
                        
                        let response;
                        if (isEdit) {
                            response = await apiFetch(`${API_BASE_URL}/parts/${partId}`, {
                                method: 'PATCH',
                                body: JSON.stringify(partData)
                            });
                        } else {
                            response = await apiFetch(`${API_BASE_URL}/parts`, {
                                method: 'POST',
                                body: JSON.stringify(partData)
                            });
                        }
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            alert(isEdit ? 'Part updated successfully!' : 'Part added successfully!');
                            closePartModal();
                            loadPartsInventory();
                            loadPartsForSelection(); // Refresh dropdown for work orders
                        } else {
                            alert('Error: ' + (result.error?.message || 'Failed to save part'));
                        }
                    } catch (error) {
                        console.error('Error saving part:', error);
                        alert('Error: ' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = isEdit ? 'Update Part' : 'Save Part';
                    }
                });
            }
        });

        // ============================================================================
        // TECHNICIAN MANAGEMENT FUNCTIONS
        // ============================================================================

        const WEEKDAYS = [
            { id: 0, name: 'Sun' },
            { id: 1, name: 'Mon' },
            { id: 2, name: 'Tue' },
            { id: 3, name: 'Wed' },
            { id: 4, name: 'Thu' },
            { id: 5, name: 'Fri' },
            { id: 6, name: 'Sat' },
        ];

        function renderTechScheduleGrid(defaults) {
            const grid = document.getElementById('techScheduleGrid');
            if (!grid) return;
            const tz = document.getElementById('techScheduleTimezone');
            if (tz && defaults?.timezone) tz.value = defaults.timezone;

            const byDay = new Map();
            (defaults?.schedule || []).forEach(s => byDay.set(Number(s.weekday), s));

            let html = `
                <div style="font-weight:700; color:#666;">Day</div>
                <div style="font-weight:700; color:#666;">Start</div>
                <div style="font-weight:700; color:#666;">End</div>
            `;

            WEEKDAYS.forEach(d => {
                const row = byDay.get(d.id);
                const isWorking = !!row;
                const start = row?.start_time ? String(row.start_time).slice(0, 5) : '09:00';
                const end = row?.end_time ? String(row.end_time).slice(0, 5) : '18:00';
                const checked = (d.id === 0) ? '' : (isWorking ? 'checked' : 'checked'); // default: Sun off, others on
                const disabled = (d.id === 0) ? '' : '';
                const workChecked = row ? 'checked' : (d.id === 0 ? '' : 'checked');
                html += `
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" class="techSchedEnabled" data-weekday="${d.id}" ${workChecked} style="width:auto;">
                        <span>${d.name}</span>
                    </label>
                    <input type="time" class="techSchedStart" data-weekday="${d.id}" value="${start}" ${row || d.id !== 0 ? '' : 'disabled'} style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                    <input type="time" class="techSchedEnd" data-weekday="${d.id}" value="${end}" ${row || d.id !== 0 ? '' : 'disabled'} style="padding:8px; border:1px solid #ddd; border-radius:6px;">
                `;
            });

            grid.innerHTML = html;

            grid.querySelectorAll('.techSchedEnabled').forEach(cb => {
                cb.addEventListener('change', () => {
                    const wd = cb.dataset.weekday;
                    const startEl = grid.querySelector(`.techSchedStart[data-weekday="${wd}"]`);
                    const endEl = grid.querySelector(`.techSchedEnd[data-weekday="${wd}"]`);
                    const enabled = cb.checked;
                    if (startEl) startEl.disabled = !enabled;
                    if (endEl) endEl.disabled = !enabled;
                });
            });
        }

        function collectTechSchedule() {
            const grid = document.getElementById('techScheduleGrid');
            const tz = document.getElementById('techScheduleTimezone')?.value || 'Asia/Dubai';
            if (!grid) return { timezone: tz, schedule: [] };

            const schedule = [];
            WEEKDAYS.forEach(d => {
                const enabled = grid.querySelector(`.techSchedEnabled[data-weekday="${d.id}"]`)?.checked;
                if (!enabled) return;
                const start = grid.querySelector(`.techSchedStart[data-weekday="${d.id}"]`)?.value;
                const end = grid.querySelector(`.techSchedEnd[data-weekday="${d.id}"]`)?.value;
                if (!start || !end) return;
                schedule.push({ weekday: d.id, start_time: start, end_time: end, timezone: tz });
            });
            return { timezone: tz, schedule };
        }

        // Load technicians list for management
        async function loadTechniciansList() {
            try {
                const url = addBusinessUnitFilter(`${API_BASE_URL}/technicians`);
                const response = await apiFetch(url);
                const data = await response.json();
                
                const container = document.getElementById('techniciansList');
                
                if (data.data && data.data.length > 0) {
                    let html = '<table style="width: 100%;"><thead><tr><th>Name</th><th>Employee Code</th><th>Trade</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                    
                    data.data.forEach(tech => {
                        const displayName = tech.user?.display_name || tech.display_name || 'Unknown';
                        const isActive = tech.user?.is_active !== false;
                        const statusBadge = isActive 
                            ? '<span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.9em;">Active</span>'
                            : '<span style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 3px; font-size: 0.9em;">Inactive</span>';
                        
                        html += `
                            <tr>
                                <td><strong>${displayName}</strong></td>
                                <td>${tech.employee_code || 'N/A'}</td>
                                <td>${tech.trade || '-'}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    <button class="btn-edit" onclick="editTechnician('${tech.user_id}')">Edit</button>
                                    <button class="btn ${isActive ? 'btn-danger' : ''}" onclick="toggleTechnicianStatus('${tech.user_id}', ${!isActive})">${isActive ? 'Deactivate' : 'Activate'}</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p>No technicians found. Click "Add New Technician" to create one.</p>';
                }
            } catch (error) {
                console.error('Error loading technicians:', error);
                document.getElementById('techniciansList').innerHTML = '<p style="color: red;">Error loading technicians</p>';
            }
        }

        // Open add technician modal
        function openAddTechnicianModal() {
            document.getElementById('technicianModalTitle').textContent = 'Add New Technician';
            document.getElementById('technicianUserId').value = '';
            document.getElementById('technicianForm').reset();
            document.getElementById('technicianPassword').required = true;
            document.getElementById('technicianActive').checked = true;
            document.getElementById('technicianMaxJobs').value = 3;
            // Ensure locations are loaded for home location dropdown
            loadLocations().catch(() => {});
            // Default home location to advisor's own location if present
            if (document.getElementById('technicianLocation') && user?.location_id) {
                document.getElementById('technicianLocation').value = String(user.location_id);
            }
            renderTechScheduleGrid({ timezone: 'Asia/Dubai', schedule: [
                { weekday: 1, start_time: '09:00', end_time: '18:00' },
                { weekday: 2, start_time: '09:00', end_time: '18:00' },
                { weekday: 3, start_time: '09:00', end_time: '18:00' },
                { weekday: 4, start_time: '09:00', end_time: '18:00' },
                { weekday: 5, start_time: '09:00', end_time: '18:00' },
                { weekday: 6, start_time: '09:00', end_time: '18:00' },
            ]});
            document.getElementById('technicianModal').style.display = 'block';
        }

        // Edit technician
        async function editTechnician(userId) {
            try {
                // Get technician details
                const techResponse = await apiFetch(`${API_BASE_URL}/technicians/${userId}`);
                const techData = await techResponse.json();

                // Fetch user details (Service Advisor is permitted for technicians in same BU, but handle non-OK safely)
                let userData = null;
                const response = await apiFetch(`${API_BASE_URL}/users/${userId}`);
                if (response.ok) {
                    userData = await response.json();
                }
                
                document.getElementById('technicianModalTitle').textContent = 'Edit Technician';
                document.getElementById('technicianUserId').value = userId;
                const displayName = userData?.display_name || techData?.user?.display_name || techData?.display_name || '';
                const email = userData?.email || techData?.user?.email || techData?.email || '';
                document.getElementById('technicianName').value = displayName;
                document.getElementById('technicianEmail').value = email;
                document.getElementById('technicianEmail').readOnly = true;
                document.getElementById('technicianPassword').required = false;
                document.getElementById('technicianPassword').value = '';
                document.getElementById('technicianEmployeeCode').value = techData.employee_code || '';
                document.getElementById('technicianTrade').value = techData.trade || '';
                document.getElementById('technicianHourlyRate').value = techData.hourly_rate || '';
                document.getElementById('technicianMaxJobs').value = techData.max_concurrent_jobs || 3;
                document.getElementById('technicianActive').checked = userData?.is_active ?? techData?.is_active ?? true;
                // Ensure locations loaded and set home location
                await loadLocations();
                if (document.getElementById('technicianLocation')) {
                    document.getElementById('technicianLocation').value = (userData?.location_id || '') ? String(userData.location_id) : '';
                }

                // Load schedule into the grid (if scheduling is enabled in this DB)
                const tz = (techData.schedule && techData.schedule[0]?.timezone) ? techData.schedule[0].timezone : 'Asia/Dubai';
                renderTechScheduleGrid({ timezone: tz, schedule: (techData.schedule || []).map(s => ({
                    weekday: Number(s.weekday),
                    start_time: String(s.start_time).slice(0, 5),
                    end_time: String(s.end_time).slice(0, 5),
                    timezone: s.timezone || tz
                }))});
                
                document.getElementById('technicianModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading technician:', error);
                alert('Error loading technician details: ' + error.message);
            }
        }

        // Close technician modal
        function closeTechnicianModal() {
            document.getElementById('technicianModal').style.display = 'none';
            document.getElementById('technicianForm').reset();
            document.getElementById('technicianEmail').readOnly = false;
        }

        // Toggle technician active status
        async function toggleTechnicianStatus(userId, activate) {
            const action = activate ? 'activate' : 'deactivate';
            if (!confirm(`Are you sure you want to ${action} this technician?`)) {
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: activate })
                });
                
                if (response.ok) {
                    alert(`Technician ${activate ? 'activated' : 'deactivated'} successfully!`);
                    loadTechniciansList();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error?.message || 'Failed to update status'));
                }
            } catch (error) {
                console.error('Error toggling status:', error);
                alert('Error: ' + error.message);
            }
        }

        // Handle technician form submission
        document.addEventListener('DOMContentLoaded', function() {
            const techForm = document.getElementById('technicianForm');
            if (techForm) {
                techForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const userId = document.getElementById('technicianUserId').value;
                    const isEdit = !!userId;
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = isEdit ? 'Updating...' : 'Creating...';
                    
                    try {
                        // Get Technician role ID
                        const rolesResponse = await apiFetch(`${API_BASE_URL}/roles`);
                        const rolesData = await rolesResponse.json();
                        
                        if (!rolesResponse.ok || !rolesData.data) {
                            alert('Error loading roles: ' + (rolesData.error?.message || 'Failed to fetch roles'));
                            return;
                        }
                        
                        const techRole = rolesData.data.find(r => r.name === 'Technician');
                        
                        if (!techRole) {
                            alert('Error: Technician role not found in system');
                            return;
                        }
                        
                        const userData = {
                            display_name: document.getElementById('technicianName').value.trim(),
                            email: document.getElementById('technicianEmail').value.trim(),
                            role_id: techRole.id,
                            is_active: document.getElementById('technicianActive').checked,
                            employee_number: document.getElementById('technicianEmployeeCode').value.trim(),
                            location_id: document.getElementById('technicianLocation')?.value
                                ? parseInt(document.getElementById('technicianLocation').value, 10)
                                : null
                        };
                        
                        const password = document.getElementById('technicianPassword').value;
                        if (password) {
                            userData.password = password;
                        }
                        
                        let userResponse;
                        if (isEdit) {
                            // Update user
                            userResponse = await apiFetch(`${API_BASE_URL}/users/${userId}`, {
                                method: 'PATCH',
                                body: JSON.stringify(userData)
                            });
                        } else {
                            // Create user (technician profile will be auto-created)
                            userResponse = await apiFetch(`${API_BASE_URL}/users`, {
                                method: 'POST',
                                body: JSON.stringify(userData)
                            });
                        }
                        
                        const userResult = await userResponse.json();
                        
                        if (!userResponse.ok) {
                            alert('Error: ' + (userResult.error?.message || 'Failed to save user'));
                            return;
                        }
                        
                        // Update or create technician details
                        const techData = {
                            employee_code: document.getElementById('technicianEmployeeCode').value.trim(),
                            trade: document.getElementById('technicianTrade').value.trim() || null,
                            hourly_rate: document.getElementById('technicianHourlyRate').value ? parseFloat(document.getElementById('technicianHourlyRate').value) : null,
                            max_concurrent_jobs: parseInt(document.getElementById('technicianMaxJobs').value) || 3
                        };

                        // Persist technician profile fields for both create and edit
                        const effectiveUserId = isEdit ? userId : (userResult.id || userResult.user_id);
                        if (effectiveUserId) {
                            const techResponse = await apiFetch(`${API_BASE_URL}/technicians/${effectiveUserId}`, {
                                method: 'PATCH',
                                body: JSON.stringify(techData)
                            });

                            if (!techResponse.ok) {
                                // Fallback: if profile doesn't exist yet, create it (safe for some DB states)
                                await apiFetch(`${API_BASE_URL}/technicians`, {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        user_id: effectiveUserId,
                                        employee_code: techData.employee_code,
                                        trade: techData.trade,
                                        hourly_rate: techData.hourly_rate,
                                        max_concurrent_jobs: techData.max_concurrent_jobs
                                    })
                                });
                            }

                            // Save weekly schedule (if scheduling is enabled)
                            const sched = collectTechSchedule();
                            if (sched.schedule && sched.schedule.length > 0) {
                                const schedResp = await apiFetch(`${API_BASE_URL}/technicians/${effectiveUserId}/schedule`, {
                                    method: 'PUT',
                                    body: JSON.stringify({ schedule: sched.schedule })
                                });
                                if (!schedResp.ok) {
                                    const err = await schedResp.json().catch(() => ({}));
                                    console.warn('Schedule save failed:', err);
                                    // Non-blocking: technician can still be created even if schedule tables aren't installed yet
                                }
                            }
                        }
                        
                        closeTechnicianModal();
                        loadTechniciansList();
                        loadTechnicians(); // Refresh dropdowns
                    } catch (error) {
                        console.error('Error saving technician:', error);
                        alert('Error: ' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = isEdit ? 'Update Technician' : 'Save Technician';
                    }
                });
            }
        });

        // Update part cost when part is selected
        document.addEventListener('DOMContentLoaded', function() {
            const partSelect = document.getElementById('partSelect');
            const unitCostInput = document.getElementById('partUnitCost');
            const unitCurrencyInput = document.getElementById('partUnitCurrency');
            if (partSelect) {
                partSelect.addEventListener('change', function() {
                    if (this.selectedOptions[0] && this.selectedOptions[0].dataset.cost) {
                        unitCostInput.value = parseFloat(this.selectedOptions[0].dataset.cost).toFixed(2);
                    }
                    if (unitCurrencyInput && this.selectedOptions[0] && this.selectedOptions[0].dataset.currency) {
                        unitCurrencyInput.value = this.selectedOptions[0].dataset.currency;
                    }
                });
            }
        });

        // Load data on page load
        // IMPORTANT: Load business unit ID FIRST, then load data
        (async function initializeDashboard() {
            try {
                // Load business unit ID first
                await loadBusinessUnitId();
                console.log('Business unit ID loaded:', userBusinessUnitId);
                
                // Now load all data with proper filtering
        loadFieldVisibilitySettings();
        loadLocations();
        loadJobCards();
        loadAssignments();
        loadTechniciansList();
        loadPartsInventory();
        initAdvisorTabs();
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                // Load data anyway even if business unit fails
                loadFieldVisibilitySettings();
                loadLocations();
                loadJobCards();
                loadAssignments();
                loadTechniciansList();
                loadPartsInventory();
                initAdvisorTabs();
            }
        })();
    </script>
</body>
</html>

