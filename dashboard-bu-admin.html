<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WTTT - Business Unit Admin Dashboard</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, var(--brand-secondary) 0%, var(--brand-primary) 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .btn-primary {
            background: var(--brand-accent);
            border: none;
            padding: 10px 20px;
            margin: 10px 0;
        }
        .btn-primary:hover {
            filter: brightness(0.92);
        }
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h3 {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 2.5em;
            color: var(--brand-primary);
            font-weight: bold;
        }
        .section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #666;
            font-size: 1em;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab.active {
            color: #17a2b8;
            border-bottom-color: #17a2b8;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .report-section {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-top: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        .checkbox-group label {
            flex: 1;
            margin: 0;
            font-weight: normal;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        .section-header {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #333;
        }
        .field-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        .field-row:hover {
            background: #f9f9f9;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 500;
        }
        .badge.success { background: #d4edda; color: #155724; }
        .badge.warning { background: #fff3cd; color: #856404; }
        .badge.danger { background: #f8d7da; color: #721c24; }
        .badge.info { background: #d1ecf1; color: #0c5460; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .modal-header h2 {
            color: #333;
            margin: 0;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .btn-submit {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        .btn-submit:hover {
            background: #218838;
        }
        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
    <link rel="stylesheet" href="theme.css">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="brand" style="display:flex; align-items:center; gap:12px;">
                <img class="brand-logo" data-brand="logo" alt="System Logo" style="height:34px; width:auto; display:none;">
                <h1 style="margin:0;"><span data-brand="system-name">WTTT</span> <span style="font-weight:700;">‚Äî BU Admin</span></h1>
            </div>
            <div class="user-info">
                <div id="userDisplay"></div>
                <a href="index.html" class="btn" onclick="logout()">Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Summary Stats -->
        <div class="dashboard-grid">
            <div class="card">
                <h3>My Business Unit</h3>
                <div class="stat-value" id="businessUnitName" style="font-size: 1.5em;">-</div>
            </div>
            <div class="card">
                <h3>Service Advisors</h3>
                <div class="stat-value" id="totalServiceAdvisors">-</div>
            </div>
            <div class="card">
                <h3>Technicians</h3>
                <div class="stat-value" id="totalTechnicians">-</div>
            </div>
            <div class="card">
                <h3>Job Cards</h3>
                <div class="stat-value" id="totalJobCards">-</div>
            </div>
            <div class="card">
                <h3>Locations</h3>
                <div class="stat-value" id="totalLocations">-</div>
            </div>
            <div class="card">
                <h3>Job Types</h3>
                <div class="stat-value" id="totalJobTypes">-</div>
            </div>
            <div class="card">
                <h3>Avg Job Efficiency</h3>
                <div class="stat-value" id="avgEfficiency" style="font-size: 2em;">-</div>
                <small style="color: #666;">Billed / Worked</small>
            </div>
            <div class="card">
                <h3>Avg Utilization</h3>
                <div class="stat-value" id="avgProductivity" style="font-size: 2em;">-</div>
                <small style="color: #666;">Worked / Clocked</small>
            </div>
        </div>

        <!-- Technician Performance Section -->
        <div class="section" id="technicianPerformanceSection" style="margin-bottom: 20px;">
            <h2>üë§ Technician Performance Metrics</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px;">
                    <select id="technicianFilter" onchange="loadTechnicianEfficiency()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">All Technicians</option>
                    </select>
                    <input type="date" id="efficiencyStartDate" onchange="loadTechnicianEfficiency()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                    <input type="date" id="efficiencyEndDate" onchange="loadTechnicianEfficiency()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                    <button class="btn-primary" onclick="loadTechnicianEfficiency()">üìä Refresh</button>
                    <button class="btn" style="background: #6c757d; color: white;" onclick="loadShiftAdjustments()">üïí Manage Shifts</button>
                </div>
            </div>
            <div id="technicianEfficiencyData">Loading...</div>

            <div style="margin-top: 16px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                    <div>
                        <h3 style="margin: 0;">üïí Shift Adjustments</h3>
                        <p style="margin: 6px 0 0; color: #666; font-size: 0.9em;">
                            BU Admin can adjust clock-in/out and break time for the selected technician. All adjustments require a reason and are audited.
                        </p>
                    </div>
                </div>
                <div id="shiftAdjustmentsList" style="margin-top: 12px;">Select a technician and click ‚ÄúManage Shifts‚Äù.</div>
            </div>
        </div>

        <!-- Shift Adjustment Modal -->
        <div id="shiftAdjustmentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit Shift</h2>
                    <span class="close" onclick="closeShiftAdjustmentModal()">&times;</span>
                </div>
                <form id="shiftAdjustmentForm">
                    <input type="hidden" id="shiftAdjustId">
                    <div class="form-group">
                        <label>Technician</label>
                        <input type="text" id="shiftAdjustTechnician" disabled>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="shiftAdjustClockIn">Clock In</label>
                            <input type="datetime-local" id="shiftAdjustClockIn" required>
                        </div>
                        <div class="form-group">
                            <label for="shiftAdjustClockOut">Clock Out (optional)</label>
                            <input type="datetime-local" id="shiftAdjustClockOut">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="shiftAdjustBreakMinutes">Break Minutes</label>
                            <input type="number" id="shiftAdjustBreakMinutes" min="0" step="1" value="0">
                        </div>
                        <div class="form-group">
                            <label for="shiftAdjustReason">Reason (required)</label>
                            <input type="text" id="shiftAdjustReason" placeholder="e.g., Technician forgot to clock out" required>
                        </div>
                    </div>
                    <div style="color:#666; font-size:0.85em; margin-top:6px;">
                        Note: Saving clears any ‚Äúactive break‚Äù state for this shift (prevents stuck break timers).
                    </div>
                    <div style="margin-top: 15px; display:flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" onclick="closeShiftAdjustmentModal()">Cancel</button>
                        <button type="submit" class="btn-submit">Save Adjustment</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Assignment Details Modal -->
        <div id="assignmentDetailsModal" class="modal">
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>Assignment Details</h2>
                    <span class="close" onclick="closeAssignmentDetailsModal()">&times;</span>
                </div>
                <div id="assignmentDetailsBody" style="padding: 10px 0;">
                    Loading...
                </div>
                <div style="margin-top: 15px; display:flex; justify-content:flex-end;">
                    <button type="button" class="btn" onclick="closeAssignmentDetailsModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="section">
            <div class="tabs" style="flex-wrap: wrap;">
                <button class="tab active" onclick="showTab('fieldVisibility', this)">Field Visibility</button>
                <button class="tab" onclick="showTab('jobTypes', this)">Job Types</button>
                <button class="tab" onclick="showTab('assetTypes', this)">Asset Types</button>
                <button class="tab" onclick="showTab('priorities', this)">Priorities</button>
                <button class="tab" onclick="showTab('jobStatuses', this)">Job Statuses</button>
                <button class="tab" onclick="showTab('assetStatuses', this)">Asset Statuses</button>
                <button class="tab" onclick="showTab('partStatuses', this)">Part Statuses</button>
                <button class="tab" onclick="showTab('partCategories', this)">Part Categories</button>
                <button class="tab" onclick="showTab('locations', this)">Locations</button>
                <button class="tab" onclick="showTab('users', this)">Users</button>
                <button class="tab" onclick="showTab('assets', this)">üè≠ Assets</button>
                <button class="tab" onclick="showTab('parts', this)">üîß Parts</button>
                <button class="tab" onclick="showTab('jobCards', this)">Job Cards</button>
                <button class="tab" onclick="showTab('assignments', this)">Assignments</button>
                <button class="tab" onclick="showTab('reports', this)">üìà Reports</button>
            </div>

            <!-- Field Visibility Tab -->
            <div id="fieldVisibilityTab" class="tab-content active">
                <h2>Field Visibility Configuration</h2>
                <p style="color: #666; margin-bottom: 20px;">Configure which fields are visible and required for Service Advisors in your Business Unit.</p>
                <button class="btn-primary" onclick="resetFieldVisibility()" style="margin-bottom: 20px;">Reset to Defaults</button>
                <div id="fieldVisibilityConfig">Loading...</div>
            </div>

            <!-- Job Types Tab -->
            <div id="jobTypesTab" class="tab-content">
                <h2>Job Types Management</h2>
                <button class="btn-primary" onclick="openCreateJobTypeModal()" style="margin-bottom: 20px;">+ Create New Job Type</button>
                <div id="jobTypesList">Loading...</div>
            </div>

            <!-- Asset Types Tab -->
            <div id="assetTypesTab" class="tab-content">
                <h2>Asset Types Management</h2>
                <p style="margin-bottom: 15px; color: #666;">Define custom asset categories for your business unit (e.g., Diagnostic Equipment, Hand Tools, Power Tools).</p>
                <button class="btn-primary" onclick="openCreateAssetTypeModal()" style="margin-bottom: 20px;">+ Create New Asset Type</button>
                <div id="assetTypesList">Loading...</div>
            </div>

            <!-- Priorities Tab -->
            <div id="prioritiesTab" class="tab-content">
                <h2>Priority Levels Management</h2>
                <p style="margin-bottom: 15px; color: #666;">Define priority levels for job cards (e.g., Critical, High, Medium, Low).</p>
                <button class="btn-primary" onclick="openCreatePriorityModal()" style="margin-bottom: 20px;">+ Create New Priority</button>
                <div id="prioritiesList">Loading...</div>
            </div>

            <!-- Job Statuses Tab -->
            <div id="jobStatusesTab" class="tab-content">
                <h2>Job Card Statuses Management</h2>
                <p style="margin-bottom: 15px; color: #666;">Define workflow statuses for job cards (e.g., Open, In Progress, Completed).</p>
                <button class="btn-primary" onclick="openCreateJobStatusModal()" style="margin-bottom: 20px;">+ Create New Status</button>
                <div id="jobStatusesList">Loading...</div>
            </div>

            <!-- Asset Statuses Tab -->
            <div id="assetStatusesTab" class="tab-content">
                <h2>Asset Statuses Management</h2>
                <p style="margin-bottom: 15px; color: #666;">Define status options for assets (e.g., Active, In Maintenance, Broken).</p>
                <button class="btn-primary" onclick="openCreateAssetStatusModal()" style="margin-bottom: 20px;">+ Create New Status</button>
                <div id="assetStatusesList">Loading...</div>
            </div>

            <!-- Part Statuses Tab -->
            <div id="partStatusesTab" class="tab-content">
                <h2>Part Statuses Management</h2>
                <p style="margin-bottom: 15px; color: #666;">Define status options for parts inventory (e.g., In Stock, Out of Stock, Ordered).</p>
                <button class="btn-primary" onclick="openCreatePartStatusModal()" style="margin-bottom: 20px;">+ Create New Status</button>
                <div id="partStatusesList">Loading...</div>
            </div>

            <!-- Part Categories Tab -->
            <div id="partCategoriesTab" class="tab-content">
                <h2>Part Categories Management</h2>
                <p style="margin-bottom: 15px; color: #666;">Define categories for organizing parts (e.g., Engine, Brake, Electrical).</p>
                <button class="btn-primary" onclick="openCreatePartCategoryModal()" style="margin-bottom: 20px;">+ Create New Category</button>
                <div id="partCategoriesList">Loading...</div>
            </div>

            <!-- Locations Tab -->
            <div id="locationsTab" class="tab-content">
                <h2>Locations Management</h2>
                <button class="btn-primary" onclick="openCreateLocationModal()" style="margin-bottom: 20px;">+ Create New Location</button>
                <div id="locationsList">Loading...</div>
            </div>

            <!-- Users Tab -->
            <div id="usersTab" class="tab-content">
                <h2>Users Management</h2>
                <button class="btn-primary" onclick="openCreateUserModal()" style="margin-bottom: 20px;">+ Create New User</button>
                <div id="usersList">Loading...</div>
            </div>

            <!-- Assets Tab -->
            <div id="assetsTab" class="tab-content">
                <h2>üè≠ Assets Management</h2>
                <p style="margin-bottom: 15px; color: #666;">Manage service tools, equipment, and vehicles for your business unit.</p>
                <button class="btn-primary" onclick="openCreateAssetModal()" style="margin-bottom: 20px;">+ Add New Asset</button>
                <div class="filter-bar" style="margin-bottom: 20px;">
                    <select id="filterAssetType" onchange="loadAssets()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">All Asset Types</option>
                    </select>
                    <select id="filterAssetStatus" onchange="loadAssets()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">All Statuses</option>
                    </select>
                    <input type="text" id="searchAsset" placeholder="Search assets..." onkeyup="loadAssets()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; flex: 1; min-width: 200px;">
                </div>
                <div id="assetsList">Loading...</div>
            </div>

            <!-- Parts Tab -->
            <div id="partsTab" class="tab-content">
                <h2>üîß Parts Inventory</h2>
                <p style="margin-bottom: 15px; color: #666;">Manage spare parts and components for your business unit.</p>
                <button class="btn-primary" onclick="openCreatePartModal()" style="margin-bottom: 20px;">+ Add New Part</button>
                <div class="filter-bar" style="margin-bottom: 20px;">
                    <select id="filterPartLocation" onchange="loadParts()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">All Locations</option>
                    </select>
                    <select id="filterPartStatus" onchange="loadParts()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">All Statuses</option>
                        <option value="active">In Stock</option>
                        <option value="installed">Installed</option>
                        <option value="ordered">Ordered</option>
                        <option value="out_of_stock">Out of Stock</option>
                    </select>
                    <input type="text" id="searchPart" placeholder="Search parts..." onkeyup="loadParts()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; flex: 1; min-width: 200px;">
                </div>
                <div id="partsList">Loading...</div>
            </div>

            <!-- Job Cards Tab -->
            <div id="jobCardsTab" class="tab-content">
                <h2>Job Cards</h2>
                <div class="filter-bar" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <select id="filterJobCardStatus" onchange="loadJobCards()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">All Statuses</option>
                    </select>
                    <select id="filterJobCardPriority" onchange="loadJobCards()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">All Priorities</option>
                        <option value="1">Priority 1</option>
                        <option value="2">Priority 2</option>
                        <option value="3">Priority 3</option>
                    </select>
                    <select id="filterJobCardPeriod" onchange="updateJobCardDateRange()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">All Dates</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="custom">Custom</option>
                    </select>
                    <input type="date" id="filterJobCardFrom" onchange="loadJobCards()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                    <input type="date" id="filterJobCardTo" onchange="loadJobCards()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                    <input type="text" id="searchJobCard" placeholder="Search job cards..." onkeyup="loadJobCards()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; flex: 1; min-width: 220px;">
                    <button class="btn-primary" onclick="loadJobCards()">üîç Apply</button>
                </div>
                <div id="jobCardsList">Loading...</div>
            </div>

            <!-- Assignments Tab -->
            <div id="assignmentsTab" class="tab-content">
                <h2>Assignments Management</h2>
                <p style="margin-bottom: 15px; color: #666;">View and manage all technician assignments in your business unit.</p>
                <div class="filter-bar" style="margin-bottom: 20px;">
                    <select id="filterAssignmentStatus" onchange="loadAssignments()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">All Statuses</option>
                        <option value="assigned">Assigned</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <select id="filterAssignmentTechnician" onchange="loadAssignments()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">All Technicians</option>
                    </select>
                </div>
                <div id="assignmentsList">Loading...</div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content">
                <h2>üìà Reports</h2>
                <p style="color:#666; margin-bottom: 12px;">Reports are scoped to your Business Unit.</p>

                <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom: 15px;">
                    <button class="btn-primary" onclick="showBUReportSection('assetsInv')" style="background:var(--brand-primary); color:#fff;">üè≠ Assets Inventory</button>
                    <button class="btn-primary" onclick="showBUReportSection('partsInv')" style="background:var(--brand-secondary); color:#fff;">üîß Parts Inventory</button>
                    <button class="btn-primary" onclick="showBUReportSection('partsCons')" style="background:var(--brand-accent); color:#111;">üìâ Parts Consumption</button>
                    <button class="btn-primary" onclick="showBUReportSection('techPerf')" style="background:var(--brand-primary); color:#fff;">üë∑ Technician Performance</button>
                </div>

                <div id="buAssetsInvSection" class="report-section" style="display:none;">
                    <h3>üè≠ Assets Inventory</h3>
                    <div class="filter-bar" style="background:#f8f9fa; padding:16px; border-radius:10px;">
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.9em; color:#666; margin-bottom:5px;">Location</label>
                                <select id="buAssetsInvLocation" style="padding:8px; border-radius:6px; border:1px solid #ddd;">
                                    <option value="all">All Locations</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.9em; color:#666; margin-bottom:5px;">Asset Type</label>
                                <select id="buAssetsInvType" style="padding:8px; border-radius:6px; border:1px solid #ddd;">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.9em; color:#666; margin-bottom:5px;">Status</label>
                                <select id="buAssetsInvStatus" style="padding:8px; border-radius:6px; border:1px solid #ddd;">
                                    <option value="">All Statuses</option>
                                    <option value="active">Active</option>
                                    <option value="in_maintenance">In Maintenance</option>
                                    <option value="broken">Broken</option>
                                    <option value="retired">Retired</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn-primary" onclick="loadBUAssetsInventoryReport()">üìä Generate Report</button>
                            <button class="btn-primary" onclick="exportBUAssetsInventoryReport()" style="background:var(--brand-secondary); color:#fff;">üì• Export to Excel</button>
                        </div>
                    </div>
                    <div id="buAssetsInvResults" style="margin-top:15px;"></div>
                </div>

                <div id="buPartsInvSection" class="report-section" style="display:none;">
                    <h3>üîß Parts Inventory</h3>
                    <div class="filter-bar" style="background:#f8f9fa; padding:16px; border-radius:10px;">
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.9em; color:#666; margin-bottom:5px;">Location</label>
                                <select id="buPartsInvLocation" style="padding:8px; border-radius:6px; border:1px solid #ddd;">
                                    <option value="all">All Locations</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.9em; color:#666; margin-bottom:5px;">Status</label>
                                <select id="buPartsInvStatus" style="padding:8px; border-radius:6px; border:1px solid #ddd;">
                                    <option value="">All Statuses</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="in_stock">In Stock</option>
                                    <option value="out_of_stock">Out of Stock</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.9em; color:#666; margin-bottom:5px;">Low stock only</label>
                                <select id="buPartsInvLowStock" style="padding:8px; border-radius:6px; border:1px solid #ddd;">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn-primary" onclick="loadBUPartsInventoryReport()">üìä Generate Report</button>
                            <button class="btn-primary" onclick="exportBUPartsInventoryReport()" style="background:var(--brand-secondary); color:#fff;">üì• Export to Excel</button>
                        </div>
                    </div>
                    <div id="buPartsInvResults" style="margin-top:15px;"></div>
                </div>

                <div id="buPartsConsSection" class="report-section" style="display:none;">
                    <h3>üìâ Parts Consumption</h3>
                    <div class="filter-bar" style="background:#f8f9fa; padding:16px; border-radius:10px;">
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.9em; color:#666; margin-bottom:5px;">Start Date</label>
                                <input type="date" id="buPartsConsStart" style="padding:8px; border-radius:6px; border:1px solid #ddd; width:100%;">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.9em; color:#666; margin-bottom:5px;">End Date</label>
                                <input type="date" id="buPartsConsEnd" style="padding:8px; border-radius:6px; border:1px solid #ddd; width:100%;">
                            </div>
                        </div>
                        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn-primary" onclick="loadBUPartsConsumptionReport()">üìä Generate Report</button>
                            <button class="btn-primary" onclick="exportBUPartsConsumptionReport()" style="background:var(--brand-secondary); color:#fff;">üì• Export to Excel</button>
                        </div>
                    </div>
                    <div id="buPartsConsResults" style="margin-top:15px;"></div>
                </div>

                <div id="buTechPerfSection" class="report-section" style="display:none;">
                    <h3>üë∑ Technician Performance</h3>
                    <div class="filter-bar" style="background:#f8f9fa; padding:16px; border-radius:10px;">
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px;">
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.9em; color:#666; margin-bottom:5px;">Location</label>
                                <select id="buTechPerfLocation" style="padding:8px; border-radius:6px; border:1px solid #ddd;">
                                    <option value="all">All Locations</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.9em; color:#666; margin-bottom:5px;">Start Date</label>
                                <input type="date" id="buTechPerfStart" style="padding:8px; border-radius:6px; border:1px solid #ddd; width:100%;">
                            </div>
                            <div class="form-group" style="margin:0;">
                                <label style="font-size:0.9em; color:#666; margin-bottom:5px;">End Date</label>
                                <input type="date" id="buTechPerfEnd" style="padding:8px; border-radius:6px; border:1px solid #ddd; width:100%;">
                            </div>
                        </div>
                        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn-primary" onclick="loadBUTechnicianPerformanceReport()">üìä Generate Report</button>
                            <button class="btn-primary" onclick="exportBUTechnicianPerformanceReport()" style="background:var(--brand-secondary); color:#fff;">üì• Export to Excel</button>
                        </div>
                    </div>
                    <div id="buTechPerfResults" style="margin-top:15px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Job Type Modal -->
    <div id="createJobTypeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Job Type</h2>
                <span class="close" onclick="closeCreateJobTypeModal()">&times;</span>
            </div>
            <form id="createJobTypeForm">
                <div class="form-group">
                    <label for="jobTypeCode">Job Type Code *</label>
                    <input type="text" id="jobTypeCode" required placeholder="e.g., MECH001" pattern="[A-Z0-9_]+">
                    <small style="color: #666;">Alphanumeric with underscores only</small>
                </div>
                <div class="form-group">
                    <label for="jobTypeName">Job Type Name *</label>
                    <input type="text" id="jobTypeName" required placeholder="e.g., Mechanical Repair">
                </div>
                <div class="form-group">
                    <label for="jobTypeDescription">Description</label>
                    <textarea id="jobTypeDescription" rows="3" placeholder="Description of this job type..."></textarea>
                </div>
                <div class="form-group">
                    <label for="jobTypeEstimatedHours">Default Estimated Hours</label>
                    <input type="number" id="jobTypeEstimatedHours" step="0.5" min="0" placeholder="e.g., 2.5">
                </div>
                <div class="form-group">
                    <label for="jobTypeDisplayOrder">Display Order</label>
                    <input type="number" id="jobTypeDisplayOrder" min="0" value="0">
                </div>
                <button type="submit" class="btn-submit" id="submitJobTypeBtn">Create Job Type</button>
            </form>
        </div>
    </div>

    <!-- Create Asset Type Modal -->
    <div id="createAssetTypeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="assetTypeModalTitle">Create New Asset Type</h2>
                <span class="close" onclick="closeCreateAssetTypeModal()">&times;</span>
            </div>
            <form id="createAssetTypeForm">
                <input type="hidden" id="assetTypeId">
                <div class="form-group">
                    <label for="assetTypeCode">Type Code *</label>
                    <input type="text" id="assetTypeCode" required placeholder="e.g., DIAG_EQUIP" pattern="[A-Z0-9_]+">
                    <small style="color: #666;">Uppercase letters, numbers, and underscores only</small>
                </div>
                <div class="form-group">
                    <label for="assetTypeName">Type Name *</label>
                    <input type="text" id="assetTypeName" required placeholder="e.g., Diagnostic Equipment">
                </div>
                <div class="form-group">
                    <label for="assetTypeDescription">Description</label>
                    <textarea id="assetTypeDescription" rows="3" placeholder="Description of this asset type..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="assetTypeIcon">Icon</label>
                        <select id="assetTypeIcon" style="font-size: 1.5em;">
                            <option value="üîß">üîß Wrench</option>
                            <option value="üöó">üöó Car</option>
                            <option value="üè≠">üè≠ Factory</option>
                            <option value="üìä">üìä Diagnostic</option>
                            <option value="‚öôÔ∏è">‚öôÔ∏è Gear</option>
                            <option value="‚ö°">‚ö° Electric</option>
                            <option value="üî®">üî® Hammer</option>
                            <option value="üõ†Ô∏è">üõ†Ô∏è Tools</option>
                            <option value="üî©">üî© Bolt</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assetTypeColor">Color</label>
                        <input type="color" id="assetTypeColor" value="#17a2b8">
                    </div>
                    <div class="form-group">
                        <label for="assetTypeDisplayOrder">Display Order</label>
                        <input type="number" id="assetTypeDisplayOrder" min="0" value="0">
                    </div>
                </div>
                <button type="submit" class="btn-submit" id="submitAssetTypeBtn">Create Asset Type</button>
            </form>
        </div>
    </div>

    <!-- Create/Edit Asset Modal -->
    <div id="assetModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="assetModalTitle">Add New Asset</h2>
                <span class="close" onclick="closeAssetModal()">&times;</span>
            </div>
            <form id="assetForm">
                <input type="hidden" id="assetId">
                <div class="form-group">
                    <label for="assetName">Asset Name *</label>
                    <input type="text" id="assetName" required placeholder="e.g., Bosch Diagnostic Scanner">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="assetType">Asset Type *</label>
                        <select id="assetType" required>
                            <option value="">Select type...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assetStatus">Status *</label>
                        <select id="assetStatus" required>
                            <option value="">Select status...</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="assetTag">Asset Tag *</label>
                        <input type="text" id="assetTag" required placeholder="e.g., TOOL-001">
                        <small style="color: #666;">Internal tracking code</small>
                    </div>
                    <div class="form-group">
                        <label for="assetSerial">Serial Number</label>
                        <input type="text" id="assetSerial" placeholder="Manufacturer serial number">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="assetBarcode">Barcode</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="text" id="assetBarcode" placeholder="Barcode number" style="flex:1;">
                            <button type="button" class="btn" style="background:var(--brand-primary); color:white; border:none; padding:10px 12px;" onclick="openCodeScannerToFill('assetBarcode','barcode','asset')">Scan</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="assetQRCode">QR Code</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="text" id="assetQRCode" placeholder="QR code identifier" style="flex:1;">
                            <button type="button" class="btn" style="background:var(--brand-primary); color:white; border:none; padding:10px 12px;" onclick="openCodeScannerToFill('assetQRCode','qr','asset')">Scan</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="assetLocation">Location *</label>
                    <select id="assetLocation" required>
                        <option value="">Select location...</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Cost</label>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <input type="text" id="assetCurrency" list="currencyCodes" value="AED" placeholder="AED" style="width: 90px;">
                            <input type="number" id="assetCost" step="0.01" min="0" placeholder="Purchase cost" style="flex:1; min-width: 160px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="assetPurchaseDate">Purchase Date</label>
                        <input type="date" id="assetPurchaseDate">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="assetManufacturer">Manufacturer</label>
                        <input type="text" id="assetManufacturer" placeholder="e.g., Bosch">
                    </div>
                    <div class="form-group">
                        <label for="assetModel">Model</label>
                        <input type="text" id="assetModel" placeholder="Model number">
                    </div>
                    <div class="form-group">
                        <label for="assetYear">Year</label>
                        <input type="number" id="assetYear" min="1900" max="2100" placeholder="2024">
                    </div>
                </div>
                <div class="form-group">
                    <label for="assetWarranty">Warranty Expiry</label>
                    <input type="date" id="assetWarranty">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn-submit" style="background: var(--brand-primary); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">Save Asset</button>
                    <button type="button" onclick="closeAssetModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create/Edit Part Modal -->
    <div id="partModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="partModalTitle">Add New Part</h2>
                <span class="close" onclick="closePartModal()">&times;</span>
            </div>
            <form id="partForm">
                <input type="hidden" id="partId">
                <div class="form-group">
                    <label for="partName">Part Name *</label>
                    <input type="text" id="partName" required placeholder="e.g., Bosch Oil Filter">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="partNumber">Part Number</label>
                        <input type="text" id="partNumber" placeholder="Manufacturer part number">
                    </div>
                    <div class="form-group">
                        <label for="partSerial">Serial Number</label>
                        <input type="text" id="partSerial" placeholder="Serial number (if applicable)">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="partBarcode">Barcode</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="text" id="partBarcode" placeholder="Barcode number" style="flex:1;">
                            <button type="button" class="btn" style="background:var(--brand-primary); color:white; border:none; padding:10px 12px;" onclick="openCodeScannerToFill('partBarcode','barcode','part')">Scan</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="partQRCode">QR Code</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="text" id="partQRCode" placeholder="QR code identifier" style="flex:1;">
                            <button type="button" class="btn" style="background:var(--brand-primary); color:white; border:none; padding:10px 12px;" onclick="openCodeScannerToFill('partQRCode','qr','part')">Scan</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="partParentAsset">Parent Asset (Optional)</label>
                    <select id="partParentAsset">
                        <option value="">None (Inventory part)</option>
                    </select>
                    <small style="color: #666;">Optional: link this part to a specific asset; leave empty for general inventory.</small>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="partLocation">Storage Location</label>
                        <select id="partLocation">
                            <option value="">Select location...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="partStatus">Status *</label>
                        <select id="partStatus" required>
                            <option value="">Select status...</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Unit Cost</label>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <input type="text" id="partCurrency" list="currencyCodes" value="AED" placeholder="AED" style="width: 90px;">
                            <input type="number" id="partCost" step="0.01" min="0" placeholder="Cost per unit" style="flex:1; min-width: 160px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="partManufacturer">Manufacturer</label>
                        <input type="text" id="partManufacturer" placeholder="e.g., Bosch, OEM">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="partStockQty">Stock Quantity</label>
                        <input type="number" id="partStockQty" min="0" value="0" placeholder="0">
                        <small style="color:#666;">Inventory on hand. Used parts from job cards will reduce this automatically.</small>
                    </div>
                    <div class="form-group"></div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn-submit" style="background: var(--brand-primary); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">Save Part</button>
                    <button type="button" onclick="closePartModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Currency codes (extend anytime) -->
    <datalist id="currencyCodes">
        <option value="AED"></option>
        <option value="USD"></option>
        <option value="SAR"></option>
        <option value="QAR"></option>
        <option value="KWD"></option>
        <option value="BHD"></option>
        <option value="OMR"></option>
        <option value="EUR"></option>
        <option value="GBP"></option>
        <option value="INR"></option>
        <option value="PKR"></option>
    </datalist>

    <!-- Create Priority Modal -->
    <div id="createPriorityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="priorityModalTitle">Create New Priority Level</h2>
                <span class="close" onclick="closeCreatePriorityModal()">&times;</span>
            </div>
            <form id="createPriorityForm">
                <input type="hidden" id="priorityId">
                <div class="form-group">
                    <label for="priorityValue">Priority Value *</label>
                    <input type="number" id="priorityValue" required min="1" placeholder="e.g., 1">
                    <small style="color: #666;">Lower numbers = higher priority</small>
                </div>
                <div class="form-group">
                    <label for="priorityName">Priority Name *</label>
                    <input type="text" id="priorityName" required placeholder="e.g., Critical">
                </div>
                <div class="form-group">
                    <label for="priorityDescription">Description</label>
                    <textarea id="priorityDescription" rows="2"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="priorityColor">Color</label>
                        <input type="color" id="priorityColor" value="#ffc107">
                    </div>
                    <div class="form-group">
                        <label for="priorityBadge">Badge Style</label>
                        <select id="priorityBadge">
                            <option value="success">Success (Green)</option>
                            <option value="warning" selected>Warning (Yellow)</option>
                            <option value="danger">Danger (Red)</option>
                            <option value="info">Info (Blue)</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn-submit" id="submitPriorityBtn">Create Priority</button>
            </form>
        </div>
    </div>

    <!-- Create Job Status Modal -->
    <div id="createJobStatusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="jobStatusModalTitle">Create New Job Card Status</h2>
                <span class="close" onclick="closeCreateJobStatusModal()">&times;</span>
            </div>
            <form id="createJobStatusForm">
                <input type="hidden" id="jobStatusId">
                <div class="form-group">
                    <label for="jobStatusCode">Status Code *</label>
                    <input type="text" id="jobStatusCode" required placeholder="e.g., waiting_parts" pattern="[a-z0-9_]+">
                    <small style="color: #666;">Lowercase letters, numbers, and underscores only</small>
                </div>
                <div class="form-group">
                    <label for="jobStatusName">Status Name *</label>
                    <input type="text" id="jobStatusName" required placeholder="e.g., Waiting for Parts">
                </div>
                <div class="form-group">
                    <label for="jobStatusDescription">Description</label>
                    <textarea id="jobStatusDescription" rows="2"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="jobStatusColor">Color</label>
                        <input type="color" id="jobStatusColor" value="#ffc107">
                    </div>
                    <div class="form-group">
                        <label for="jobStatusBadge">Badge Style</label>
                        <select id="jobStatusBadge">
                            <option value="success">Success (Green)</option>
                            <option value="warning" selected>Warning (Yellow)</option>
                            <option value="danger">Danger (Red)</option>
                            <option value="info">Info (Blue)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="jobStatusClosed" style="width: auto;">
                        <span>This is a closed/final status (cannot reopen job)</span>
                    </label>
                </div>
                <button type="submit" class="btn-submit" id="submitJobStatusBtn">Create Status</button>
            </form>
        </div>
    </div>

    <!-- Create Asset Status Modal -->
    <div id="createAssetStatusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="assetStatusModalTitle">Create New Asset Status</h2>
                <span class="close" onclick="closeCreateAssetStatusModal()">&times;</span>
            </div>
            <form id="createAssetStatusForm">
                <input type="hidden" id="assetStatusId">
                <div class="form-group">
                    <label for="assetStatusCode">Status Code *</label>
                    <input type="text" id="assetStatusCode" required placeholder="e.g., on_loan" pattern="[a-z0-9_]+">
                    <small style="color: #666;">Lowercase letters, numbers, and underscores only</small>
                </div>
                <div class="form-group">
                    <label for="assetStatusName">Status Name *</label>
                    <input type="text" id="assetStatusName" required placeholder="e.g., On Loan">
                </div>
                <div class="form-group">
                    <label for="assetStatusDescription">Description</label>
                    <textarea id="assetStatusDescription" rows="2"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="assetStatusColor">Color</label>
                        <input type="color" id="assetStatusColor" value="#28a745">
                    </div>
                    <div class="form-group">
                        <label for="assetStatusBadge">Badge Style</label>
                        <select id="assetStatusBadge">
                            <option value="success" selected>Success (Green)</option>
                            <option value="warning">Warning (Yellow)</option>
                            <option value="danger">Danger (Red)</option>
                            <option value="info">Info (Blue)</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn-submit" id="submitAssetStatusBtn">Create Status</button>
            </form>
        </div>
    </div>

    <!-- Create Part Status Modal -->
    <div id="createPartStatusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="partStatusModalTitle">Create New Part Status</h2>
                <span class="close" onclick="closeCreatePartStatusModal()">&times;</span>
            </div>
            <form id="createPartStatusForm">
                <input type="hidden" id="partStatusId">
                <div class="form-group">
                    <label for="partStatusCode">Status Code *</label>
                    <input type="text" id="partStatusCode" required placeholder="e.g., reserved" pattern="[a-z0-9_]+">
                    <small style="color: #666;">Lowercase letters, numbers, and underscores only</small>
                </div>
                <div class="form-group">
                    <label for="partStatusName">Status Name *</label>
                    <input type="text" id="partStatusName" required placeholder="e.g., Reserved">
                </div>
                <div class="form-group">
                    <label for="partStatusDescription">Description</label>
                    <textarea id="partStatusDescription" rows="2"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="partStatusColor">Color</label>
                        <input type="color" id="partStatusColor" value="#28a745">
                    </div>
                    <div class="form-group">
                        <label for="partStatusBadge">Badge Style</label>
                        <select id="partStatusBadge">
                            <option value="success" selected>Success (Green)</option>
                            <option value="warning">Warning (Yellow)</option>
                            <option value="danger">Danger (Red)</option>
                            <option value="info">Info (Blue)</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn-submit" id="submitPartStatusBtn">Create Status</button>
            </form>
        </div>
    </div>

    <!-- Create Part Category Modal -->
    <div id="createPartCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="partCategoryModalTitle">Create New Part Category</h2>
                <span class="close" onclick="closeCreatePartCategoryModal()">&times;</span>
            </div>
            <form id="createPartCategoryForm">
                <input type="hidden" id="partCategoryId">
                <div class="form-group">
                    <label for="partCategoryCode">Category Code *</label>
                    <input type="text" id="partCategoryCode" required placeholder="e.g., EXHAUST" pattern="[A-Z0-9_]+">
                    <small style="color: #666;">Uppercase letters, numbers, and underscores only</small>
                </div>
                <div class="form-group">
                    <label for="partCategoryName">Category Name *</label>
                    <input type="text" id="partCategoryName" required placeholder="e.g., Exhaust System">
                </div>
                <div class="form-group">
                    <label for="partCategoryDescription">Description</label>
                    <textarea id="partCategoryDescription" rows="2"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="partCategoryIcon">Icon</label>
                        <select id="partCategoryIcon" style="font-size: 1.5em;">
                            <option value="‚öôÔ∏è">‚öôÔ∏è Gear</option>
                            <option value="üõë">üõë Stop Sign</option>
                            <option value="‚ö°">‚ö° Electric</option>
                            <option value="üîó">üîó Chain</option>
                            <option value="üõ¢Ô∏è">üõ¢Ô∏è Oil</option>
                            <option value="üõû">üõû Tire</option>
                            <option value="üö™">üö™ Door</option>
                            <option value="üîß">üîß Wrench</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="partCategoryOrder">Display Order</label>
                        <input type="number" id="partCategoryOrder" min="0" value="0">
                    </div>
                </div>
                <button type="submit" class="btn-submit" id="submitPartCategoryBtn">Create Category</button>
            </form>
        </div>
    </div>

    <!-- Create/Edit Location Modal -->
    <div id="locationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="locationModalTitle">Create Location</h2>
                <span class="close" onclick="closeLocationModal()">&times;</span>
            </div>
            <form id="locationForm">
                <input type="hidden" id="locationId">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="locationName" required>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="locationAddress">
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="locationCity">
                </div>
                <div class="form-group">
                    <label>State</label>
                    <input type="text" id="locationState">
                </div>
                <div class="form-group">
                    <label>Country</label>
                    <input type="text" id="locationCountry" value="UAE">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="locationPhone">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="locationEmail">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="locationIsActive" checked style="width: auto;">
                        <span>Active</span>
                    </label>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn-submit" style="background: var(--brand-primary); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">Save</button>
                    <button type="button" onclick="closeLocationModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="userModalTitle">Create User</h2>
                <span class="close" onclick="closeUserModal()">&times;</span>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label>Display Name *</label>
                    <input type="text" id="userDisplayName" required>
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="userRole" required>
                        <option value="">Select role...</option>
                    </select>
                    <small style="color: #666;">Can only create Service Advisors and Technicians for your business unit</small>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <select id="userLocation">
                        <option value="">Select location...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Employee Number</label>
                    <input type="text" id="userEmployeeNumber">
                </div>
                <div id="passwordFields">
                    <div class="form-group">
                        <label>Password <span id="passwordRequired">*</span></label>
                        <input type="password" id="userPassword" minlength="12">
                        <small style="color: #666; display: block; margin-top: 5px;" id="passwordHelp">Minimum 12 characters. Leave blank when editing to keep current password.</small>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="userIsActive" checked style="width: auto;">
                        <span>Active</span>
                    </label>
                </div>
                <div id="technicianFields" style="display: none;">
                    <h3 style="margin-top: 20px; margin-bottom: 15px;">Technician Details</h3>
                    <div class="form-group">
                        <label>Employee Code *</label>
                        <input type="text" id="techEmployeeCode">
                    </div>
                    <div class="form-group">
                        <label>Trade</label>
                        <input type="text" id="techTrade">
                    </div>
                    <div class="form-group">
                        <label>Hourly Rate</label>
                        <input type="number" id="techHourlyRate" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Max Concurrent Jobs</label>
                        <input type="number" id="techMaxJobs" min="1" value="3">
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label><strong>Weekly Shift Schedule (Planned Hours)</strong></label>
                        <small style="color:#666; display:block; margin-top:4px;">
                            Set expected working hours per day. Used for planning and performance analysis when clock-in/out data is missing.
                        </small>
                        <div id="buTechScheduleGrid" style="margin-top: 10px; display: grid; grid-template-columns: 110px 1fr 1fr; gap: 10px; align-items: center;">
                            <!-- populated by JS -->
                        </div>
                        <div style="margin-top: 8px; color:#666; font-size:0.85em;">
                            Timezone:
                            <select id="buTechScheduleTimezone" style="padding:6px; border:1px solid #ddd; border-radius:6px;">
                                <option value="Asia/Dubai">Asia/Dubai</option>
                                <option value="Asia/Riyadh">Asia/Riyadh</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn-submit" style="background: var(--brand-primary); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">Save</button>
                    <button type="button" onclick="closeUserModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Field Label/Help Text Modal (no browser prompts; consistent enterprise UX) -->
    <div id="fieldLabelModal" class="modal">
        <div class="modal-content" style="max-width: 640px;">
            <div class="modal-header">
                <h2>Edit Field Label</h2>
                <span class="close" onclick="closeFieldLabelModal()">&times;</span>
            </div>
            <div class="form-group">
                <label>Section</label>
                <input type="text" id="fieldLabelSectionDisplay" disabled>
            </div>
            <div class="form-group">
                <label>Field</label>
                <input type="text" id="fieldLabelFieldDisplay" disabled>
            </div>
            <div class="form-group">
                <label>Custom Label (optional)</label>
                <input type="text" id="fieldLabelCustomLabel" placeholder="Leave empty to use the default label">
            </div>
            <div class="form-group">
                <label>Custom Help Text (optional)</label>
                <textarea id="fieldLabelCustomHelp" rows="3" placeholder="Leave empty to use the default help text"></textarea>
            </div>
            <input type="hidden" id="fieldLabelSectionName">
            <input type="hidden" id="fieldLabelFieldName">
            <div style="display:flex; gap:10px; margin-top: 18px;">
                <button type="button" class="btn-submit" style="background: var(--brand-primary); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;" onclick="saveFieldLabelModal()">Save</button>
                <button type="button" onclick="closeFieldLabelModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">Cancel</button>
            </div>
        </div>
    </div>

    <script src="branding.js"></script>
    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000/api/v1'
            : `http://${window.location.hostname}:3000/api/v1`;
        let accessToken = localStorage.getItem('access_token');
        let refreshToken = localStorage.getItem('refresh_token');
        let user = JSON.parse(localStorage.getItem('user') || '{}');
        let userBusinessUnitId = null;
        let fieldVisibilityData = null;

        // Check if user is logged in and is BU Admin
        if (!accessToken || !user.id) {
            window.location.href = 'index.html';
        }
        if (user.role?.name !== 'Business Unit Admin') {
            alert('Access denied. Business Unit Admin privileges required.');
            window.location.href = 'index.html';
        }

        // Display user info
        document.getElementById('userDisplay').innerHTML = `
            <span>${user.display_name} (<span class="badge" style="background: var(--brand-primary); color: white;">BU Admin</span>)</span>
        `;

        // Function to refresh access token
        async function refreshAccessToken() {
            try {
                if (!refreshToken) {
                    throw new Error('No refresh token available');
                }

                const response = await fetch(`${API_BASE_URL}/auth/refresh`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh_token: refreshToken
                    })
                });

                const data = await response.json();

                if (response.ok && data.access_token) {
                    accessToken = data.access_token;
                    localStorage.setItem('access_token', accessToken);
                    return accessToken;
                } else {
                    throw new Error(data.error?.message || 'Token refresh failed');
                }
            } catch (error) {
                console.error('Token refresh error:', error);
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user');
                window.location.href = 'index.html';
                throw error;
            }
        }

        // ------------------------
        // Currency helpers (ISO 4217 codes like AED, USD; extensible)
        // ------------------------
        const DEFAULT_CURRENCY_NEW = 'AED';
        const DEFAULT_CURRENCY_LEGACY = 'USD';

        function normalizeCurrencyCode(code) {
            const v = String(code || '').trim().toUpperCase();
            if (!v) return DEFAULT_CURRENCY_NEW;
            return v.slice(0, 3);
        }

        function formatMoney(amount, currencyCode) {
            const code = normalizeCurrencyCode(currencyCode || DEFAULT_CURRENCY_LEGACY);
            const num = Number(amount || 0);
            try {
                return new Intl.NumberFormat(undefined, { style: 'currency', currency: code }).format(num);
            } catch {
                return `${code} ${num.toFixed(2)}`;
            }
        }

        // ------------------------
        // Barcode / QR helpers (manual entry + scan-to-fill)
        // ------------------------
        function openCodeScannerToFill(targetInputId, codeType = 'barcode', expectedEntityType = null) {
            const modal = document.createElement('div');
            modal.id = 'codeScannerModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 520px;">
                    <div class="modal-header">
                        <h2>Scan / Enter ${codeType === 'qr' ? 'QR Code' : 'Barcode'}</h2>
                        <span class="close" onclick="closeCodeScanner()">&times;</span>
                    </div>
                    <div class="form-group">
                        <label>${codeType === 'qr' ? 'QR Code' : 'Barcode'}:</label>
                        <input type="text" id="codeScannerInput" placeholder="Scan with your handheld scanner or type manually..." style="width:100%; padding:10px; font-size:16px;" autofocus>
                        <small style="color:#666;">Tip: most handheld scanners act like a keyboard and will paste the value here automatically.</small>
                        <button type="button" class="btn-submit" style="margin-top: 10px; width: 100%;" onclick="applyScannedCode('${targetInputId}', '${codeType}', '${expectedEntityType || ''}')">Use This Code</button>
                    </div>
                    <div id="codeScannerResult" style="margin-top: 12px; color:#666;"></div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => {
                const input = document.getElementById('codeScannerInput');
                if (input) {
                    input.focus();
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            applyScannedCode(targetInputId, codeType, expectedEntityType || '');
                        }
                    });
                }
            }, 50);
        }

        function closeCodeScanner() {
            const modal = document.getElementById('codeScannerModal');
            if (modal) modal.remove();
        }

        async function applyScannedCode(targetInputId, codeType, expectedEntityType) {
            const input = document.getElementById('codeScannerInput');
            const result = document.getElementById('codeScannerResult');
            const target = document.getElementById(targetInputId);
            if (!input || !target || !result) return;

            const code = String(input.value || '').trim();
            if (!code) {
                result.innerHTML = `<span style="color:#a00;">Please scan or type a value first.</span>`;
                return;
            }

            // Validate uniqueness / show info by checking scan endpoint
            result.textContent = 'Checking code...';
            try {
                const payload = codeType === 'qr' ? { qr_code: code } : { barcode: code };
                const resp = await apiFetch(`${API_BASE_URL}/barcode/scan`, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const data = await resp.json().catch(() => ({}));

                if (resp.ok && data && data.found) {
                    // If it already exists, warn (enterprise behavior)
                    const sameType = !expectedEntityType || String(data.entity_type) === String(expectedEntityType);
                    const name = data.entity?.name || data.entity?.job_number || 'existing record';
                    const msg = sameType
                        ? `This code is already assigned to a ${data.entity_type}: ${name}.`
                        : `This code is already assigned to a different entity (${data.entity_type}): ${name}.`;
                    result.innerHTML = `<span style="color:#a00;">‚ö† ${msg}</span><div style="margin-top:6px; color:#666;">If you continue, saving will likely fail due to duplicate protection.</div>`;
                } else {
                    result.innerHTML = `<span style="color:#28a745;">‚úì Code is available.</span>`;
                }
            } catch (e) {
                result.innerHTML = `<span style="color:#a00;">Could not validate code right now: ${e.message}</span>`;
            }

            // Always fill the field (manual workflows still allowed)
            target.value = code;
            closeCodeScanner();
        }

        // API fetch wrapper with automatic token refresh
        async function apiFetch(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                }
            };

            const mergedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...(options.headers || {})
                }
            };

            let response = await fetch(url, mergedOptions);

            if (response.status === 401) {
                const errorData = await response.json().catch(() => ({}));
                if (errorData.error?.code === 'TOKEN_EXPIRED' || errorData.error?.message?.includes('expired')) {
                    try {
                        await refreshAccessToken();
                        mergedOptions.headers['Authorization'] = `Bearer ${accessToken}`;
                        response = await fetch(url, mergedOptions);
                    } catch (refreshError) {
                        throw refreshError;
                    }
                }
            }

            return response;
        }

        // Tab switching
        function showTab(tabName, element) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'fieldVisibility') loadFieldVisibilityConfig();
            else if (tabName === 'jobTypes') loadJobTypes();
            else if (tabName === 'assetTypes') loadAssetTypes();
            else if (tabName === 'priorities') loadPriorities();
            else if (tabName === 'jobStatuses') loadJobStatuses();
            else if (tabName === 'assetStatuses') loadAssetStatuses();
            else if (tabName === 'partStatuses') loadPartStatuses();
            else if (tabName === 'partCategories') loadPartCategories();
            else if (tabName === 'locations') loadLocations();
            else if (tabName === 'users') loadUsers();
            else if (tabName === 'assets') {
                loadAssets();
                loadLocationsForAssets();
            }
            else if (tabName === 'parts') {
                loadParts();
                loadLocationsForParts();
                loadAssetsForParts();
            }
            else if (tabName === 'jobCards') loadJobCards();
            else if (tabName === 'assignments') {
                loadAssignments();
                loadTechniciansForFilter();
            }
            else if (tabName === 'reports') {
                loadBUReportFilters();
                showBUReportSection('assetsInv');
            }
        }

        // ------------------------------------------------------------------------
        // BU Admin Reports
        // ------------------------------------------------------------------------
        let lastBUAssetsInv = null;
        let lastBUPartsInv = null;
        let lastBUPartsCons = null;
        let lastBUTechPerf = null;

        function showBUReportSection(section) {
            const sections = ['buAssetsInvSection', 'buPartsInvSection', 'buPartsConsSection', 'buTechPerfSection'];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            if (section === 'assetsInv') document.getElementById('buAssetsInvSection').style.display = 'block';
            if (section === 'partsInv') document.getElementById('buPartsInvSection').style.display = 'block';
            if (section === 'partsCons') document.getElementById('buPartsConsSection').style.display = 'block';
            if (section === 'techPerf') document.getElementById('buTechPerfSection').style.display = 'block';
        }

        async function loadBUReportFilters() {
            try {
                if (!userBusinessUnitId) {
                    await loadBusinessUnitInfo();
                }
                // Locations scoped to BU
                const resp = await apiFetch(`${API_BASE_URL}/locations?business_unit_id=${userBusinessUnitId}`);
                const data = await resp.json();
                const locations = Array.isArray(data) ? data : (data.data || []);

                const locationSelectIds = ['buAssetsInvLocation', 'buPartsInvLocation', 'buTechPerfLocation'];
                locationSelectIds.forEach(id => {
                    const sel = document.getElementById(id);
                    if (!sel) return;
                    sel.innerHTML = '<option value="all">All Locations</option>';
                    locations.forEach(l => {
                        const opt = document.createElement('option');
                        opt.value = l.id;
                        opt.textContent = l.name;
                        sel.appendChild(opt);
                    });
                });

                // Asset Types (scoped to BU) - ensure report dropdown includes all configured types
                try {
                    const typesResp = await apiFetch(`${API_BASE_URL}/asset-types/${userBusinessUnitId}`);
                    const typesData = await typesResp.json();
                    const types = Array.isArray(typesData) ? typesData : (typesData.data || []);
                    const typeSel = document.getElementById('buAssetsInvType');
                    if (typeSel) {
                        typeSel.innerHTML = '<option value="">All Types</option>';
                        (types || [])
                            .filter(t => t && (t.is_active === undefined || t.is_active === true || t.is_active === 1))
                            .sort((a, b) => (Number(a.display_order || 0) - Number(b.display_order || 0)) || String(a.type_name || '').localeCompare(String(b.type_name || '')))
                            .forEach(t => {
                                const opt = document.createElement('option');
                                // assets.asset_type stores a string; use type_name to match existing stored values
                                opt.value = t.type_name;
                                opt.textContent = t.type_name;
                                typeSel.appendChild(opt);
                            });
                    }
                } catch (e) {
                    console.warn('Could not load asset types for report filter:', e);
                }

                // Default dates
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                if (document.getElementById('buPartsConsStart')) document.getElementById('buPartsConsStart').value = firstDay.toISOString().split('T')[0];
                if (document.getElementById('buPartsConsEnd')) document.getElementById('buPartsConsEnd').value = today.toISOString().split('T')[0];
                if (document.getElementById('buTechPerfStart')) document.getElementById('buTechPerfStart').value = firstDay.toISOString().split('T')[0];
                if (document.getElementById('buTechPerfEnd')) document.getElementById('buTechPerfEnd').value = today.toISOString().split('T')[0];
            } catch (e) {
                console.error('Failed to load BU report filters:', e);
            }
        }

        async function loadBUAssetsInventoryReport() {
            try {
                const loc = document.getElementById('buAssetsInvLocation')?.value || 'all';
                const type = document.getElementById('buAssetsInvType')?.value || '';
                const status = document.getElementById('buAssetsInvStatus')?.value || '';

                const params = new URLSearchParams();
                params.append('business_unit_ids', String(userBusinessUnitId || 'all'));
                params.append('location_ids', loc === 'all' ? 'all' : String(loc));
                if (type) params.append('asset_type', type);
                if (status) params.append('status', status);

                const resp = await apiFetch(`${API_BASE_URL}/reports/assets-inventory?${params.toString()}`);
                const data = await resp.json();
                if (!resp.ok) return alert('Error: ' + (data.error?.message || 'Failed'));
                lastBUAssetsInv = data;
                const rows = data.data || [];
                if (!rows.length) {
                    document.getElementById('buAssetsInvResults').innerHTML = '<p>No assets found.</p>';
                    return;
                }
                let html = '<div style="overflow-x:auto;"><table><tr><th>Asset</th><th>Type</th><th>Status</th><th>Tag</th><th>Serial</th><th>Location</th></tr>';
                rows.forEach(a => {
                    html += `<tr>
                        <td>${a.name || ''}</td>
                        <td>${a.asset_type || ''}</td>
                        <td>${a.status || ''}</td>
                        <td>${a.asset_tag || ''}</td>
                        <td>${a.serial_number || ''}</td>
                        <td>${a.location_name || ''}</td>
                    </tr>`;
                });
                html += '</table></div>';
                document.getElementById('buAssetsInvResults').innerHTML = html;
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function exportBUAssetsInventoryReport() {
            if (!lastBUAssetsInv?.data?.length) return alert('Generate the report first.');
            const wb = XLSX.utils.book_new();
            const wsData = [['Asset', 'Type', 'Status', 'Asset Tag', 'Serial', 'Location']];
            lastBUAssetsInv.data.forEach(a => {
                wsData.push([a.name || '', a.asset_type || '', a.status || '', a.asset_tag || '', a.serial_number || '', a.location_name || '']);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Assets');
            XLSX.writeFile(wb, `BU_Assets_Inventory_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        async function loadBUPartsInventoryReport() {
            try {
                const loc = document.getElementById('buPartsInvLocation')?.value || 'all';
                const status = document.getElementById('buPartsInvStatus')?.value || '';
                const lowStock = document.getElementById('buPartsInvLowStock')?.value || 'false';

                const params = new URLSearchParams();
                params.append('business_unit_ids', String(userBusinessUnitId || 'all'));
                params.append('location_ids', loc === 'all' ? 'all' : String(loc));
                if (status) params.append('status', status);
                if (lowStock) params.append('low_stock_only', lowStock);

                const resp = await apiFetch(`${API_BASE_URL}/reports/parts-inventory?${params.toString()}`);
                const data = await resp.json();
                if (!resp.ok) return alert('Error: ' + (data.error?.message || 'Failed'));
                lastBUPartsInv = data;
                const rows = data.data || [];
                if (!rows.length) {
                    document.getElementById('buPartsInvResults').innerHTML = '<p>No parts found.</p>';
                    return;
                }
                const getStock = (row) => {
                    try {
                        const meta = (typeof row.metadata === 'string') ? JSON.parse(row.metadata) : (row.metadata || {});
                        const q = meta?.quantity_in_stock;
                        return (q !== undefined && q !== null) ? parseInt(q, 10) : null;
                    } catch {
                        return null;
                    }
                };
                let html = '<div style="overflow-x:auto;"><table><tr><th>Part</th><th>Part #</th><th>Status</th><th>Location</th><th>In Stock</th><th>Used Qty</th></tr>';
                rows.forEach(p => {
                    const stock = getStock(p);
                    html += `<tr>
                        <td>${p.name || ''}</td>
                        <td>${p.part_number || ''}</td>
                        <td>${p.status || ''}</td>
                        <td>${p.location_name || ''}</td>
                        <td>${Number.isFinite(stock) ? stock : '-'}</td>
                        <td>${p.total_used || 0}</td>
                    </tr>`;
                });
                html += '</table></div>';
                document.getElementById('buPartsInvResults').innerHTML = html;
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function exportBUPartsInventoryReport() {
            if (!lastBUPartsInv?.data?.length) return alert('Generate the report first.');
            const wb = XLSX.utils.book_new();
            const wsData = [['Part', 'Part #', 'Status', 'Location', 'In Stock', 'Used Qty']];
            lastBUPartsInv.data.forEach(p => {
                let stock = null;
                try {
                    const meta = (typeof p.metadata === 'string') ? JSON.parse(p.metadata) : (p.metadata || {});
                    const q = meta?.quantity_in_stock;
                    stock = (q !== undefined && q !== null) ? parseInt(q, 10) : null;
                } catch { stock = null; }
                wsData.push([p.name || '', p.part_number || '', p.status || '', p.location_name || '', Number.isFinite(stock) ? stock : '', p.total_used || 0]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Parts');
            XLSX.writeFile(wb, `BU_Parts_Inventory_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        async function loadBUPartsConsumptionReport() {
            try {
                const start = document.getElementById('buPartsConsStart')?.value || '';
                const end = document.getElementById('buPartsConsEnd')?.value || '';
                const params = new URLSearchParams();
                params.append('business_unit_id', String(userBusinessUnitId));
                if (start) params.append('start_date', start);
                if (end) params.append('end_date', end);
                const resp = await apiFetch(`${API_BASE_URL}/reports/parts-consumption?${params.toString()}`);
                const data = await resp.json();
                if (!resp.ok) return alert('Error: ' + (data.error?.message || 'Failed'));
                lastBUPartsCons = data;
                const rows = data.data || [];
                if (!rows.length) {
                    document.getElementById('buPartsConsResults').innerHTML = '<p>No consumption data found.</p>';
                    return;
                }
                const getStock = (row) => {
                    try {
                        const meta = (typeof row.metadata === 'string') ? JSON.parse(row.metadata) : (row.metadata || {});
                        const q = meta?.quantity_in_stock;
                        return (q !== undefined && q !== null) ? parseInt(q, 10) : null;
                    } catch {
                        return null;
                    }
                };
                let html = '<div style="overflow-x:auto;"><table><tr><th>Part</th><th>Part #</th><th>Location</th><th>In Stock</th><th>Qty Used</th><th>Total Cost</th><th>Work Orders</th></tr>';
                rows.forEach(r => {
                    const stock = getStock(r);
                    html += `<tr>
                        <td>${r.name || ''}</td>
                        <td>${r.part_number || ''}</td>
                        <td>${r.location_name || ''}</td>
                        <td>${Number.isFinite(stock) ? stock : '-'}</td>
                        <td>${r.total_quantity_used || 0}</td>
                        <td>${(parseFloat(r.total_cost) || 0).toFixed(2)}</td>
                        <td>${r.work_orders_count || 0}</td>
                    </tr>`;
                });
                html += '</table></div>';
                document.getElementById('buPartsConsResults').innerHTML = html;
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function exportBUPartsConsumptionReport() {
            if (!lastBUPartsCons?.data?.length) return alert('Generate the report first.');
            const wb = XLSX.utils.book_new();
            const wsData = [['Part', 'Part #', 'Location', 'In Stock', 'Qty Used', 'Total Cost', 'Work Orders']];
            lastBUPartsCons.data.forEach(r => {
                let stock = null;
                try {
                    const meta = (typeof r.metadata === 'string') ? JSON.parse(r.metadata) : (r.metadata || {});
                    const q = meta?.quantity_in_stock;
                    stock = (q !== undefined && q !== null) ? parseInt(q, 10) : null;
                } catch { stock = null; }
                wsData.push([r.name || '', r.part_number || '', r.location_name || '', Number.isFinite(stock) ? stock : '', r.total_quantity_used || 0, parseFloat(r.total_cost || 0), r.work_orders_count || 0]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Consumption');
            XLSX.writeFile(wb, `BU_Parts_Consumption_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        async function loadBUTechnicianPerformanceReport() {
            try {
                const loc = document.getElementById('buTechPerfLocation')?.value || 'all';
                const start = document.getElementById('buTechPerfStart')?.value || '';
                const end = document.getElementById('buTechPerfEnd')?.value || '';
                const params = new URLSearchParams();
                params.append('business_unit_id', String(userBusinessUnitId));
                if (loc && loc !== 'all') params.append('location_id', loc);
                if (start) params.append('start_date', start);
                if (end) params.append('end_date', end);
                const resp = await apiFetch(`${API_BASE_URL}/reports/technician-performance?${params.toString()}`);
                const data = await resp.json();
                if (!resp.ok) return alert('Error: ' + (data.error?.message || 'Failed'));
                lastBUTechPerf = data;
                const rows = data.data || [];
                if (!rows.length) {
                    document.getElementById('buTechPerfResults').innerHTML = '<p>No technician data found.</p>';
                    return;
                }
                let html = '<div style="overflow-x:auto;"><table><tr><th>Location</th><th>Technician</th><th>Employee Code</th><th>Total Jobs</th><th>Completed</th><th>Total Hours</th><th>Avg Hours/Job</th></tr>';
                rows.forEach(r => {
                    html += `<tr>
                        <td>${r.location_name || '-'}</td>
                        <td>${r.technician_name || '-'}</td>
                        <td>${r.employee_code || '-'}</td>
                        <td>${r.total_job_cards || 0}</td>
                        <td>${r.completed_job_cards || 0}</td>
                        <td>${(parseFloat(r.total_hours) || 0).toFixed(2)}</td>
                        <td>${(parseFloat(r.avg_hours_per_job) || 0).toFixed(2)}</td>
                    </tr>`;
                });
                html += '</table></div>';
                document.getElementById('buTechPerfResults').innerHTML = html;
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function exportBUTechnicianPerformanceReport() {
            if (!lastBUTechPerf?.data?.length) return alert('Generate the report first.');
            const wb = XLSX.utils.book_new();
            const wsData = [['Location', 'Technician', 'Employee Code', 'Total Jobs', 'Completed', 'Total Hours', 'Avg Hours/Job']];
            lastBUTechPerf.data.forEach(r => {
                wsData.push([r.location_name || '', r.technician_name || '', r.employee_code || '', r.total_job_cards || 0, r.completed_job_cards || 0, parseFloat(r.total_hours || 0), parseFloat(r.avg_hours_per_job || 0)]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Tech Performance');
            XLSX.writeFile(wb, `BU_Technician_Performance_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Load user's Business Unit info
        async function loadBusinessUnitInfo() {
            try {
                const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                const userData = await userResponse.json();
                
                if (userResponse.ok && userData.business_unit_id) {
                    userBusinessUnitId = userData.business_unit_id;
                    
                    const buResponse = await apiFetch(`${API_BASE_URL}/business-units/${userBusinessUnitId}`);
                    const buData = await buResponse.json();
                    
                    if (buResponse.ok && buData.name) {
                        document.getElementById('businessUnitName').textContent = buData.name;
                    }
                }
            } catch (error) {
                console.error('Error loading business unit info:', error);
            }
        }

        // Load summary stats
        async function loadSummaryStats() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                // Load users
                const usersResponse = await apiFetch(`${API_BASE_URL}/users?business_unit_id=${userBusinessUnitId}`);
                const usersData = await usersResponse.json();
                if (usersResponse.ok && usersData.data) {
                    const serviceAdvisors = usersData.data.filter(u => 
                        (u.role_name === 'Service Advisor' || u.role_name === 'ServiceAdvisor') && u.is_active
                    ).length;
                    const technicians = usersData.data.filter(u => 
                        u.role_name === 'Technician' && u.is_active
                    ).length;
                    document.getElementById('totalServiceAdvisors').textContent = serviceAdvisors;
                    document.getElementById('totalTechnicians').textContent = technicians;
                }

                // Load locations
                const locResponse = await apiFetch(`${API_BASE_URL}/locations?business_unit_id=${userBusinessUnitId}`);
                const locData = await locResponse.json();
                const locations = Array.isArray(locData) ? locData : (locData.data || []);
                document.getElementById('totalLocations').textContent = locations.length;

                // Load job types
                const jtResponse = await apiFetch(`${API_BASE_URL}/business-unit-job-types/${userBusinessUnitId}`);
                const jtData = await jtResponse.json();
                if (jtResponse.ok && jtData.data) {
                    document.getElementById('totalJobTypes').textContent = jtData.data.filter(jt => jt.is_active).length;
                }

                // Load job cards
                const jcResponse = await apiFetch(`${API_BASE_URL}/jobcards?business_unit_id=${userBusinessUnitId}`);
                const jcData = await jcResponse.json();
                if (jcResponse.ok && jcData.data) {
                    document.getElementById('totalJobCards').textContent = jcData.data.length;
                }
            } catch (error) {
                console.error('Error loading summary stats:', error);
            }
        }

        // Load Field Visibility Configuration
        async function loadFieldVisibilityConfig() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/field-visibility/${userBusinessUnitId}`);
                const data = await response.json();
                
                if (response.ok && data.data && data.data.sections) {
                    fieldVisibilityData = data.data;
                    
                    let html = '';
                    data.data.sections.forEach(section => {
                        html += `<div class="section-header">${section.section_display_name}</div>`;
                        html += '<div class="field-row" style="grid-template-columns: 2fr 1fr 1fr 1fr; font-weight: 600; background: #f8f9fa;">';
                        html += '<div>Field Name</div><div>Visible</div><div>Required</div><div>Actions</div>';
                        html += '</div>';
                        
                        section.fields.forEach(field => {
                            html += `
                                <div class="field-row">
                                    <div>
                                        <strong>${field.field_display_name}</strong>
                                        <br><small style="color: #666;">${field.field_type}</small>
                                    </div>
                                    <div>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" 
                                                   id="visible_${section.section_name}_${field.field_name}"
                                                   ${field.is_visible ? 'checked' : ''}
                                                   onchange="updateFieldVisibility('${section.section_name}', '${field.field_name}', 'is_visible', this.checked)">
                                            <span>Visible</span>
                                        </label>
                                    </div>
                                    <div>
                                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                            <input type="checkbox" 
                                                   id="required_${section.section_name}_${field.field_name}"
                                                   ${field.is_required ? 'checked' : ''}
                                                   ${!field.is_visible ? 'disabled' : ''}
                                                   onchange="updateFieldVisibility('${section.section_name}', '${field.field_name}', 'is_required', this.checked)">
                                            <span>Required</span>
                                        </label>
                                    </div>
                                    <div>
                                        <button onclick="editFieldLabel('${section.section_name}', '${field.field_name}', '${field.field_display_name}', '${(field.custom_help_text || '').replace(/'/g, "\\'")}')" 
                                                style="background: var(--brand-primary); color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 0.9em;">
                                            Edit Label
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    });
                    
                    html += '<div style="margin-top: 20px;"><button class="btn-primary" onclick="saveFieldVisibility()">Save All Changes</button></div>';
                    
                    document.getElementById('fieldVisibilityConfig').innerHTML = html;
                } else {
                    document.getElementById('fieldVisibilityConfig').innerHTML = '<p>Error loading field visibility configuration.</p>';
                }
            } catch (error) {
                console.error('Error loading field visibility:', error);
                document.getElementById('fieldVisibilityConfig').innerHTML = '<p style="color: red;">Error: ' + error.message + '</p>';
            }
        }

        // Update field visibility (local state)
        let pendingVisibilityUpdates = {};

        function updateFieldVisibility(sectionName, fieldName, property, value) {
            if (!pendingVisibilityUpdates[sectionName]) {
                pendingVisibilityUpdates[sectionName] = {};
            }
            if (!pendingVisibilityUpdates[sectionName][fieldName]) {
                pendingVisibilityUpdates[sectionName][fieldName] = {};
            }
            pendingVisibilityUpdates[sectionName][fieldName][property] = value;

            // If disabling visibility, also disable required
            if (property === 'is_visible' && !value) {
                const requiredCheckbox = document.getElementById(`required_${sectionName}_${fieldName}`);
                if (requiredCheckbox) {
                    requiredCheckbox.checked = false;
                    requiredCheckbox.disabled = true;
                    pendingVisibilityUpdates[sectionName][fieldName]['is_required'] = false;
                }
            } else if (property === 'is_visible' && value) {
                const requiredCheckbox = document.getElementById(`required_${sectionName}_${fieldName}`);
                if (requiredCheckbox) {
                    requiredCheckbox.disabled = false;
                }
            }
        }

        // Save field visibility changes
        async function saveFieldVisibility() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const settings = [];
                for (const sectionName in pendingVisibilityUpdates) {
                    for (const fieldName in pendingVisibilityUpdates[sectionName]) {
                        const updates = pendingVisibilityUpdates[sectionName][fieldName];
                        const row = {
                            section_name: sectionName,
                            field_name: fieldName,
                            is_visible: updates.is_visible !== undefined ? updates.is_visible : 
                                       document.getElementById(`visible_${sectionName}_${fieldName}`)?.checked,
                            is_required: updates.is_required !== undefined ? updates.is_required : 
                                        document.getElementById(`required_${sectionName}_${fieldName}`)?.checked
                        };
                        if (updates.custom_label !== undefined) row.custom_label = updates.custom_label;
                        if (updates.custom_help_text !== undefined) row.custom_help_text = updates.custom_help_text;
                        settings.push(row);
                    }
                }

                if (settings.length === 0) {
                    alert('No changes to save.');
                    return;
                }

                const response = await apiFetch(`${API_BASE_URL}/field-visibility/${userBusinessUnitId}`, {
                    method: 'POST',
                    body: JSON.stringify({ settings })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('Field visibility settings saved successfully!');
                    pendingVisibilityUpdates = {};
                    loadFieldVisibilityConfig();
                } else {
                    alert('Error: ' + (data.error?.message || 'Failed to save settings'));
                }
            } catch (error) {
                alert('Error saving settings: ' + error.message);
            }
        }

        // Reset field visibility to defaults
        async function resetFieldVisibility() {
            if (!confirm('Are you sure you want to reset all field visibility settings to defaults?')) {
                return;
            }

            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/field-visibility/${userBusinessUnitId}/reset`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Field visibility settings reset to defaults.');
                    pendingVisibilityUpdates = {};
                    loadFieldVisibilityConfig();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error?.message || 'Failed to reset settings'));
                }
            } catch (error) {
                alert('Error resetting settings: ' + error.message);
            }
        }

        // Edit field label/help text (enterprise modal; persists via Field Visibility API)
        function editFieldLabel(sectionName, fieldName, currentLabel, currentHelpText) {
            const sectionDisplay = (fieldVisibilityData?.sections || []).find(s => s.section_name === sectionName)?.section_display_name || sectionName;
            document.getElementById('fieldLabelSectionDisplay').value = sectionDisplay;
            document.getElementById('fieldLabelFieldDisplay').value = currentLabel || fieldName;
            document.getElementById('fieldLabelCustomLabel').value = '';
            document.getElementById('fieldLabelCustomHelp').value = currentHelpText || '';
            document.getElementById('fieldLabelSectionName').value = sectionName;
            document.getElementById('fieldLabelFieldName').value = fieldName;
            document.getElementById('fieldLabelModal').style.display = 'block';
        }

        function closeFieldLabelModal() {
            const modal = document.getElementById('fieldLabelModal');
            if (modal) modal.style.display = 'none';
        }

        async function saveFieldLabelModal() {
            try {
                const sectionName = document.getElementById('fieldLabelSectionName').value;
                const fieldName = document.getElementById('fieldLabelFieldName').value;
                const customLabel = (document.getElementById('fieldLabelCustomLabel').value || '').trim();
                const customHelp = (document.getElementById('fieldLabelCustomHelp').value || '').trim();

                // Store only changed properties; keep existing values intact if not set.
                updateFieldVisibility(sectionName, fieldName, 'custom_label', customLabel ? customLabel : null);
                updateFieldVisibility(sectionName, fieldName, 'custom_help_text', customHelp ? customHelp : null);

                closeFieldLabelModal();
                alert('Label settings staged. Click "Save All Changes" to apply.');
            } catch (error) {
                alert('Error saving label settings: ' + error.message);
            }
        }

        // Load Job Types
        async function loadJobTypes() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/business-unit-job-types/${userBusinessUnitId}`);
                const data = await response.json();
                
                if (response.ok && data.data) {
                    let html = '<table><tr><th>Code</th><th>Name</th><th>Description</th><th>Default Hours</th><th>Status</th><th>Actions</th></tr>';
                    data.data.forEach(jt => {
                        html += `
                            <tr>
                                <td>${jt.job_type_code}</td>
                                <td>${jt.job_type_name}</td>
                                <td>${jt.description || '-'}</td>
                                <td>${jt.default_estimated_hours || '-'}</td>
                                <td><span class="badge ${jt.is_active ? 'success' : 'danger'}">${jt.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <button onclick="editJobType(${jt.id})" style="background: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">Edit</button>
                                    <button onclick="deleteJobType(${jt.id})" style="background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    document.getElementById('jobTypesList').innerHTML = html;
                } else {
                    document.getElementById('jobTypesList').innerHTML = '<p>No job types found.</p>';
                }
            } catch (error) {
                console.error('Error loading job types:', error);
                document.getElementById('jobTypesList').innerHTML = '<p style="color: red;">Error loading job types</p>';
            }
        }

        // Load Locations
        async function loadLocations() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const url = `${API_BASE_URL}/locations?business_unit_id=${userBusinessUnitId}`;
                console.log('[BU ADMIN] Loading locations with filter:', url);
                console.log('[BU ADMIN] My business_unit_id:', userBusinessUnitId);
                
                const response = await apiFetch(url);
                const data = await response.json();
                const locations = Array.isArray(data) ? data : (data.data || []);
                
                console.log('[BU ADMIN] Locations loaded:', locations.length, 'locations');
                console.log('[BU ADMIN] Locations:', locations.map(l => ({ name: l.name, bu_id: l.business_unit_id })));
                
                if (locations.length > 0) {
                    let html = '<table><tr><th>Name</th><th>Address</th><th>Status</th><th>Actions</th></tr>';
                    locations.forEach(loc => {
                        html += `
                            <tr>
                                <td>${loc.name}</td>
                                <td>${loc.address || '-'}</td>
                                <td><span class="badge ${loc.is_active ? 'success' : 'danger'}">${loc.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <button onclick="editLocation(${loc.id})" style="background: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">Edit</button>
                                    <button onclick="deleteLocation(${loc.id})" style="background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    document.getElementById('locationsList').innerHTML = html;
                } else {
                    document.getElementById('locationsList').innerHTML = '<p>No locations found.</p>';
                }
            } catch (error) {
                console.error('Error loading locations:', error);
                document.getElementById('locationsList').innerHTML = '<p style="color: red;">Error loading locations</p>';
            }
        }

        // Load Users
        async function loadUsers() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                // Get ALL users in this Business Unit (BU Admin manages the entire BU)
                const url = `${API_BASE_URL}/users?business_unit_id=${userBusinessUnitId}`;
                console.log('[BU ADMIN] Loading ALL users in my Business Unit:', url);
                console.log('[BU ADMIN] My ID:', user.id);
                console.log('[BU ADMIN] My business_unit_id:', userBusinessUnitId);
                
                const response = await apiFetch(url);
                const data = await response.json();
                
                console.log('[BU ADMIN] Users loaded:', data.data?.length, 'users in BU');
                console.log('[BU ADMIN] Users:', data.data?.map(u => ({ email: u.email, role: u.role_name })));
                
                if (response.ok && data.data) {
                    // Filter to show Service Advisors (Workshop Managers) and Technicians
                    // Exclude other BU Admins from the list (they manage, not managed)
                    const filteredUsers = data.data.filter(u => {
                        const role = (u.role_name || '').toLowerCase();
                        // Include Service Advisors and Technicians, exclude admins
                        return role.includes('advisor') || 
                               role.includes('technician') ||
                               role === 'serviceadvisor' || 
                               role === 'technician';
                    });
                    
                    console.log('[BU ADMIN] Team members (Service Advisors + Technicians):', filteredUsers.length, 'users');
                    
                    let html = '<table><tr><th>Email</th><th>Name</th><th>Role</th><th>Location</th><th>Status</th><th>Actions</th></tr>';
                    filteredUsers.forEach(u => {
                        html += `
                            <tr>
                                <td>${u.email}</td>
                                <td>${u.display_name}</td>
                                <td><span class="badge info">${u.role_name}</span></td>
                                <td>${u.location_name || '<span style="color: #999;">Unassigned</span>'}</td>
                                <td><span class="badge ${u.is_active ? 'success' : 'danger'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <button onclick="editUser('${u.id}')" style="background: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">Edit</button>
                                    <button onclick="deleteUser('${u.id}', '${u.email}')" style="background: #dc3545; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer;">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    document.getElementById('usersList').innerHTML = html;
                } else {
                    document.getElementById('usersList').innerHTML = '<p>No users found.</p>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersList').innerHTML = '<p style="color: red;">Error loading users</p>';
            }
        }

        // Load Job Cards
        async function loadJobCards() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                await loadJobCardStatusFilterOptions();

                const statusFilter = document.getElementById('filterJobCardStatus')?.value || '';
                const priorityFilter = document.getElementById('filterJobCardPriority')?.value || '';
                const fromDate = document.getElementById('filterJobCardFrom')?.value || '';
                const toDate = document.getElementById('filterJobCardTo')?.value || '';
                const search = document.getElementById('searchJobCard')?.value?.trim() || '';

                let url = `${API_BASE_URL}/jobcards?business_unit_id=${userBusinessUnitId}`;
                if (statusFilter) url += `&status=${encodeURIComponent(statusFilter)}`;
                if (priorityFilter) url += `&priority=${encodeURIComponent(priorityFilter)}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;

                // Date range filter (created_at)
                if (fromDate) {
                    const d = new Date(fromDate);
                    d.setHours(0, 0, 0, 0);
                    url += `&created_after=${encodeURIComponent(d.toISOString())}`;
                }
                if (toDate) {
                    const d = new Date(toDate);
                    d.setHours(23, 59, 59, 999);
                    url += `&created_before=${encodeURIComponent(d.toISOString())}`;
                }

                const response = await apiFetch(url);
                const data = await response.json();
                
                if (response.ok && data.data) {
                    let html = '<table><tr><th>Job Number</th><th>Customer</th><th>Status</th><th>Priority</th><th>Created</th></tr>';
                    data.data.forEach(jc => {
                        html += `
                            <tr>
                                <td>${jc.job_number}</td>
                                <td>${jc.customer_name || '-'}</td>
                                <td><span class="badge ${jc.status === 'completed' ? 'success' : jc.status === 'in_progress' ? 'warning' : 'info'}">${jc.status}</span></td>
                                <td>${jc.priority || '-'}</td>
                                <td>${new Date(jc.created_at).toLocaleDateString()}</td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    document.getElementById('jobCardsList').innerHTML = html;
                } else {
                    document.getElementById('jobCardsList').innerHTML = '<p>No job cards found.</p>';
                }
            } catch (error) {
                console.error('Error loading job cards:', error);
                document.getElementById('jobCardsList').innerHTML = '<p style="color: red;">Error loading job cards</p>';
            }
        }

        let jobCardStatusFilterLoaded = false;
        async function loadJobCardStatusFilterOptions() {
            if (jobCardStatusFilterLoaded) return;
            const select = document.getElementById('filterJobCardStatus');
            if (!select || !userBusinessUnitId) return;

            const previous = select.value;
            try {
                const response = await apiFetch(`${API_BASE_URL}/job-card-statuses/${userBusinessUnitId}`, { method: 'GET' });
                const data = await response.json();

                if (!response.ok || !Array.isArray(data.data)) {
                    jobCardStatusFilterLoaded = true; // avoid retry loops
                    return;
                }

                // Reset options
                select.innerHTML = '';
                const allOpt = document.createElement('option');
                allOpt.value = '';
                allOpt.textContent = 'All Statuses';
                select.appendChild(allOpt);

                data.data.forEach(s => {
                    const code = s.status_code || s.code || s.value;
                    const name = s.status_name || s.name || code;
                    if (!code) return;
                    const opt = document.createElement('option');
                    opt.value = code;
                    opt.textContent = name;
                    select.appendChild(opt);
                });

                // restore selection if still present
                select.value = previous;
            } catch (e) {
                // If schema isn't available or endpoint fails, keep just "All Statuses"
            } finally {
                jobCardStatusFilterLoaded = true;
            }
        }

        function updateJobCardDateRange() {
            const period = document.getElementById('filterJobCardPeriod')?.value || '';
            const fromEl = document.getElementById('filterJobCardFrom');
            const toEl = document.getElementById('filterJobCardTo');
            if (!fromEl || !toEl) return;

            const now = new Date();
            const set = (from, to) => {
                fromEl.value = from || '';
                toEl.value = to || '';
            };

            if (!period) {
                set('', '');
                loadJobCards();
                return;
            }

            if (period === 'today') {
                const d = new Date(now);
                const iso = d.toISOString().slice(0, 10);
                set(iso, iso);
                loadJobCards();
                return;
            }

            if (period === 'week') {
                const d = new Date(now);
                const day = d.getDay(); // 0 Sun..6 Sat
                const diffToMonday = (day + 6) % 7; // Monday=0
                const monday = new Date(d);
                monday.setDate(d.getDate() - diffToMonday);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                set(monday.toISOString().slice(0, 10), sunday.toISOString().slice(0, 10));
                loadJobCards();
                return;
            }

            if (period === 'month') {
                const first = new Date(now.getFullYear(), now.getMonth(), 1);
                const last = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                set(first.toISOString().slice(0, 10), last.toISOString().slice(0, 10));
                loadJobCards();
                return;
            }

            // custom: don't auto-change dates; user sets from/to manually
            loadJobCards();
        }

        // Job Type Management
        function openCreateJobTypeModal() {
            document.getElementById('createJobTypeModal').style.display = 'block';
            document.getElementById('createJobTypeForm').reset();
            document.getElementById('jobTypeCode').readOnly = false;
            document.getElementById('submitJobTypeBtn').textContent = 'Create Job Type';
            delete document.getElementById('createJobTypeForm').dataset.editId;
        }

        function closeCreateJobTypeModal() {
            document.getElementById('createJobTypeModal').style.display = 'none';
            document.getElementById('createJobTypeForm').reset();
            document.getElementById('jobTypeCode').readOnly = false;
            delete document.getElementById('createJobTypeForm').dataset.editId;
        }

        document.getElementById('createJobTypeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userBusinessUnitId) {
                const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                const userData = await userResponse.json();
                userBusinessUnitId = userData.business_unit_id;
            }

            const editId = e.target.dataset.editId;
            const isEdit = !!editId;
            const submitBtn = document.getElementById('submitJobTypeBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = isEdit ? 'Updating...' : 'Creating...';

            try {
                const formData = {
                    job_type_name: document.getElementById('jobTypeName').value.trim(),
                    description: document.getElementById('jobTypeDescription').value.trim() || null,
                    default_estimated_hours: document.getElementById('jobTypeEstimatedHours').value ? parseFloat(document.getElementById('jobTypeEstimatedHours').value) : null,
                    display_order: parseInt(document.getElementById('jobTypeDisplayOrder').value) || 0
                };
                
                if (!isEdit) {
                    formData.job_type_code = document.getElementById('jobTypeCode').value.trim();
                }

                // Backend update route is PATCH /business-unit-job-types/:id
                const url = isEdit 
                    ? `${API_BASE_URL}/business-unit-job-types/${editId}`
                    : `${API_BASE_URL}/business-unit-job-types/${userBusinessUnitId}`;

                const response = await apiFetch(url, {
                    method: isEdit ? 'PATCH' : 'POST',
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert(isEdit ? 'Job type updated successfully!' : 'Job type created successfully!');
                    closeCreateJobTypeModal();
                    loadJobTypes();
                    loadSummaryStats();
                } else {
                    alert('Error: ' + (data.error?.message || 'Failed to save job type'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isEdit ? 'Update Job Type' : 'Create Job Type';
                document.getElementById('jobTypeCode').readOnly = false;
                delete e.target.dataset.editId;
            }
        });

        async function editJobType(id) {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/business-unit-job-types/${userBusinessUnitId}`);
                const data = await response.json();
                const jobType = (data.data || []).find(jt => jt.id === id);
                
                if (jobType) {
                    document.getElementById('jobTypeCode').value = jobType.job_type_code;
                    document.getElementById('jobTypeCode').readOnly = true;
                    document.getElementById('jobTypeName').value = jobType.job_type_name;
                    document.getElementById('jobTypeDescription').value = jobType.description || '';
                    document.getElementById('jobTypeEstimatedHours').value = jobType.default_estimated_hours || '';
                    document.getElementById('jobTypeDisplayOrder').value = jobType.display_order || 0;
                    document.getElementById('createJobTypeForm').dataset.editId = id;
                    document.getElementById('submitJobTypeBtn').textContent = 'Update Job Type';
                    document.getElementById('createJobTypeModal').style.display = 'block';
                } else {
                    alert('Job type not found');
                }
            } catch (error) {
                console.error('Error loading job type:', error);
                alert('Error loading job type: ' + error.message);
            }
        }

        async function deleteJobType(id) {
            if (!confirm('Are you sure you want to deactivate this job type?')) return;
            
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                // Deactivate via PATCH (schema supports is_active)
                const response = await apiFetch(`${API_BASE_URL}/business-unit-job-types/${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: false })
                });
                
                if (response.ok) {
                    alert('Job type deactivated successfully');
                    loadJobTypes();
                    loadSummaryStats();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error?.message || 'Failed to delete'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ============================================================================
        // LOCATIONS CRUD - FULL IMPLEMENTATION
        // ============================================================================
        
        function openCreateLocationModal() {
            document.getElementById('locationModalTitle').textContent = 'Create Location';
            document.getElementById('locationId').value = '';
            document.getElementById('locationForm').reset();
            document.getElementById('locationCountry').value = 'UAE';
            document.getElementById('locationIsActive').checked = true;
            document.getElementById('locationModal').style.display = 'block';
        }

        async function editLocation(id) {
            try {
                const response = await apiFetch(`${API_BASE_URL}/locations/${id}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('locationModalTitle').textContent = 'Edit Location';
                    document.getElementById('locationId').value = data.id;
                    document.getElementById('locationName').value = data.name || '';
                    document.getElementById('locationAddress').value = data.address || '';
                    document.getElementById('locationCity').value = data.city || '';
                    document.getElementById('locationState').value = data.state || '';
                    document.getElementById('locationCountry').value = data.country || 'UAE';
                    document.getElementById('locationPhone').value = data.phone || '';
                    document.getElementById('locationEmail').value = data.email || '';
                    document.getElementById('locationIsActive').checked = data.is_active !== false;
                    document.getElementById('locationModal').style.display = 'block';
                } else {
                    alert('Error loading location');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteLocation(id) {
            if (!confirm('Are you sure you want to delete this location?')) return;
            try {
                const response = await apiFetch(`${API_BASE_URL}/locations/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('Location deleted successfully');
                    loadLocations();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error?.message || 'Failed'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function closeLocationModal() {
            document.getElementById('locationModal').style.display = 'none';
            document.getElementById('locationForm').reset();
        }

        document.getElementById('locationForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userBusinessUnitId) {
                const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                userBusinessUnitId = (await userResponse.json()).business_unit_id;
            }
            const locationId = document.getElementById('locationId').value;
            const isEdit = !!locationId;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            try {
                const locationData = {
                    name: document.getElementById('locationName').value.trim(),
                    business_unit_id: userBusinessUnitId, // Auto-assigned to BU Admin's BU
                    address: document.getElementById('locationAddress').value.trim() || null,
                    city: document.getElementById('locationCity').value.trim() || null,
                    state: document.getElementById('locationState').value.trim() || null,
                    country: document.getElementById('locationCountry').value.trim() || 'UAE',
                    phone: document.getElementById('locationPhone').value.trim() || null,
                    email: document.getElementById('locationEmail').value.trim() || null,
                    is_active: document.getElementById('locationIsActive').checked
                };
                const response = await apiFetch(
                    isEdit ? `${API_BASE_URL}/locations/${locationId}` : `${API_BASE_URL}/locations`,
                    { method: isEdit ? 'PATCH' : 'POST', body: JSON.stringify(locationData) }
                );
                if (response.ok) {
                    alert(isEdit ? 'Location updated!' : 'Location created!');
                    closeLocationModal();
                    loadLocations();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error?.message || 'Failed'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
            }
        });

        // ============================================================================
        // USERS CRUD - FULL IMPLEMENTATION
        // ============================================================================
        
        async function openCreateUserModal() {
            document.getElementById('userModalTitle').textContent = 'Create User';
            document.getElementById('userId').value = '';
            document.getElementById('userForm').reset();
            document.getElementById('passwordRequired').style.display = 'inline';
            document.getElementById('passwordHelp').textContent = 'Minimum 12 characters required for new users';
            document.getElementById('userPassword').required = true;
            document.getElementById('technicianFields').style.display = 'none';
            clearBuTechScheduleForm();
            await loadRolesForUser();
            await loadLocationsForUser();
            // Ensure role toggle handler is active and fields reflect current selection
            toggleTechnicianFieldsForUserModal();
            document.getElementById('userModal').style.display = 'block';
        }

        async function editUser(id) {
            try {
                const response = await apiFetch(`${API_BASE_URL}/users/${id}`);
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('userModalTitle').textContent = 'Edit User';
                    document.getElementById('userId').value = data.id;
                    document.getElementById('userEmail').value = data.email || '';
                    document.getElementById('userDisplayName').value = data.display_name || '';
                    document.getElementById('userEmployeeNumber').value = data.employee_number || '';
                    document.getElementById('userIsActive').checked = data.is_active !== false;
                    document.getElementById('passwordRequired').style.display = 'none';
                    document.getElementById('passwordHelp').textContent = 'Leave blank to keep current password';
                    document.getElementById('userPassword').required = false;
                    document.getElementById('userPassword').value = '';
                    
                    await loadRolesForUser();
                    await loadLocationsForUser();
                    document.getElementById('userRole').value = data.role_id || '';
                    document.getElementById('userLocation').value = data.location_id || '';
                    
                    // Show tech fields if technician (based on selected role to avoid relying on server role_name formatting)
                    toggleTechnicianFieldsForUserModal();
                    clearBuTechScheduleForm();
                    if (isUserModalTechnicianRoleSelected()) {
                        const techResponse = await apiFetch(`${API_BASE_URL}/technicians/${id}`);
                        const tech = await techResponse.json();
                        if (techResponse.ok && tech) {
                            document.getElementById('techEmployeeCode').value = tech.employee_code || '';
                            document.getElementById('techTrade').value = tech.trade || '';
                            document.getElementById('techHourlyRate').value = tech.hourly_rate || '';
                            if (document.getElementById('techMaxJobs')) {
                                document.getElementById('techMaxJobs').value = tech.max_concurrent_jobs || 3;
                            }
                            if (Array.isArray(tech.schedule)) {
                                fillBuTechScheduleForm(tech.schedule);
                            }
                        }
                    }
                    document.getElementById('userModal').style.display = 'block';
                } else {
                    alert('Error loading user');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteUser(id, email) {
            if (!confirm(`Are you sure you want to delete user "${email}"?\n\nThis action cannot be undone.`)) return;
            try {
                const response = await apiFetch(`${API_BASE_URL}/users/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('‚úì User deleted successfully');
                    loadUsers();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error?.message || 'Failed to delete user'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            document.getElementById('userForm').reset();
        }

        async function loadRolesForUser() {
            try {
                const response = await apiFetch(`${API_BASE_URL}/roles`);
                const data = await response.json();
                const roles = Array.isArray(data) ? data : (data.data || []);
                const select = document.getElementById('userRole');
                select.innerHTML = '<option value="">Select role...</option>';
                // BU Admin can only create Service Advisors and Technicians
                roles.filter(r => r.name === 'ServiceAdvisor' || r.name === 'Service Advisor' || r.name === 'Technician').forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = role.name;
                    select.appendChild(option);
                });
                // Ensure role change toggles technician fields
                select.onchange = toggleTechnicianFieldsForUserModal;
                // Also bind addEventListener once (in case other code overwrites onchange)
                if (!select.dataset.techToggleBound) {
                    select.addEventListener('change', toggleTechnicianFieldsForUserModal);
                    select.dataset.techToggleBound = '1';
                }
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }

        function isUserModalTechnicianRoleSelected() {
            const sel = document.getElementById('userRole');
            const roleName = sel?.selectedOptions?.[0]?.textContent?.trim();
            return roleName === 'Technician';
        }

        function toggleTechnicianFieldsForUserModal() {
            const show = isUserModalTechnicianRoleSelected();
            const box = document.getElementById('technicianFields');
            const emp = document.getElementById('techEmployeeCode');
            if (box) box.style.display = show ? 'block' : 'none';
            if (emp) emp.required = !!show;
            if (!show) {
                // reset technician-only fields when switching away
                clearBuTechScheduleForm();
            }
        }

        function renderBuTechScheduleGrid() {
            const grid = document.getElementById('buTechScheduleGrid');
            if (!grid || grid.dataset.rendered === '1') return;
            const days = [
                { key: 0, label: 'Sun' },
                { key: 1, label: 'Mon' },
                { key: 2, label: 'Tue' },
                { key: 3, label: 'Wed' },
                { key: 4, label: 'Thu' },
                { key: 5, label: 'Fri' },
                { key: 6, label: 'Sat' },
            ];

            grid.innerHTML = `
                <div style="font-weight:700; color:#555;">Day</div>
                <div style="font-weight:700; color:#555;">Start</div>
                <div style="font-weight:700; color:#555;">End</div>
            `;

            for (const d of days) {
                const dayCell = document.createElement('div');
                dayCell.innerHTML = `
                    <label style="display:flex; align-items:center; gap:8px; margin:0;">
                        <input type="checkbox" id="buSchedDay_${d.key}" style="width:auto;">
                        <span>${d.label}</span>
                    </label>
                `;
                const start = document.createElement('div');
                start.innerHTML = `<input type="time" id="buSchedStart_${d.key}" value="09:00" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">`;
                const end = document.createElement('div');
                end.innerHTML = `<input type="time" id="buSchedEnd_${d.key}" value="18:00" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">`;
                grid.appendChild(dayCell);
                grid.appendChild(start);
                grid.appendChild(end);
            }
            grid.dataset.rendered = '1';
        }

        function clearBuTechScheduleForm() {
            renderBuTechScheduleGrid();
            for (let i = 0; i <= 6; i++) {
                const cb = document.getElementById(`buSchedDay_${i}`);
                const st = document.getElementById(`buSchedStart_${i}`);
                const en = document.getElementById(`buSchedEnd_${i}`);
                if (cb) cb.checked = false;
                if (st) st.value = '09:00';
                if (en) en.value = '18:00';
            }
            const tz = document.getElementById('buTechScheduleTimezone');
            if (tz) tz.value = 'Asia/Dubai';
        }

        function collectBuTechSchedule() {
            const tz = document.getElementById('buTechScheduleTimezone')?.value || 'Asia/Dubai';
            const schedule = [];
            for (let i = 0; i <= 6; i++) {
                const cb = document.getElementById(`buSchedDay_${i}`);
                if (!cb || !cb.checked) continue;
                const start = document.getElementById(`buSchedStart_${i}`)?.value || '09:00';
                const end = document.getElementById(`buSchedEnd_${i}`)?.value || '18:00';
                schedule.push({ weekday: i, start_time: start, end_time: end, timezone: tz });
            }
            return schedule;
        }

        function fillBuTechScheduleForm(scheduleRows) {
            renderBuTechScheduleGrid();
            clearBuTechScheduleForm();
            if (!Array.isArray(scheduleRows) || scheduleRows.length === 0) return;
            const tz = scheduleRows[0]?.timezone || 'Asia/Dubai';
            const tzSel = document.getElementById('buTechScheduleTimezone');
            if (tzSel) tzSel.value = tz;
            for (const row of scheduleRows) {
                const wd = typeof row.weekday === 'string' ? parseInt(row.weekday, 10) : row.weekday;
                const cb = document.getElementById(`buSchedDay_${wd}`);
                const st = document.getElementById(`buSchedStart_${wd}`);
                const en = document.getElementById(`buSchedEnd_${wd}`);
                if (cb) cb.checked = true;
                if (st && row.start_time) st.value = String(row.start_time).slice(0, 5);
                if (en && row.end_time) en.value = String(row.end_time).slice(0, 5);
            }
        }

        async function loadLocationsForUser() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    userBusinessUnitId = (await userResponse.json()).business_unit_id;
                }
                const response = await apiFetch(`${API_BASE_URL}/locations?business_unit_id=${userBusinessUnitId}`);
                const data = await response.json();
                const locations = Array.isArray(data) ? data : (data.data || []);
                const select = document.getElementById('userLocation');
                select.innerHTML = '<option value="">Select location...</option>';
                locations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.id;
                    option.textContent = loc.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        document.getElementById('userForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userBusinessUnitId) {
                const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                userBusinessUnitId = (await userResponse.json()).business_unit_id;
            }
            const userId = document.getElementById('userId').value;
            const isEdit = !!userId;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            try {
                const userData = {
                    email: document.getElementById('userEmail').value.trim(),
                    display_name: document.getElementById('userDisplayName').value.trim(),
                    role_id: parseInt(document.getElementById('userRole').value),
                    business_unit_id: userBusinessUnitId, // Auto-assigned to BU Admin's BU
                    location_id: document.getElementById('userLocation').value ? parseInt(document.getElementById('userLocation').value) : null,
                    employee_number: document.getElementById('userEmployeeNumber').value.trim() || null,
                    supervisor_id: user.id, // Auto-assigned to current BU Admin
                    is_active: document.getElementById('userIsActive').checked
                };
                
                console.log('[BU ADMIN] Creating user with supervisor_id:', user.id);
                
                const password = document.getElementById('userPassword').value.trim();
                if (password || !isEdit) userData.password = password;
                
                const response = await apiFetch(
                    isEdit ? `${API_BASE_URL}/users/${userId}` : `${API_BASE_URL}/users`,
                    { method: isEdit ? 'PATCH' : 'POST', body: JSON.stringify(userData) }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    // Technician profile details (single source of truth: /api/v1/technicians/:user_id)
                    const selectedRoleName = document.getElementById('userRole')?.selectedOptions?.[0]?.textContent?.trim();
                    if (selectedRoleName === 'Technician') {
                        const techUserId = isEdit ? userId : data.id;
                        const techData = {
                            employee_code: (document.getElementById('techEmployeeCode')?.value || '').trim() || (document.getElementById('userEmployeeNumber')?.value || '').trim(),
                            trade: (document.getElementById('techTrade')?.value || '').trim() || null,
                            hourly_rate: document.getElementById('techHourlyRate')?.value ? parseFloat(document.getElementById('techHourlyRate').value) : null,
                            max_concurrent_jobs: document.getElementById('techMaxJobs')?.value ? parseInt(document.getElementById('techMaxJobs').value) : undefined
                        };
                        if (techUserId) {
                            const techResp = await apiFetch(`${API_BASE_URL}/technicians/${techUserId}`, {
                                method: 'PATCH',
                                body: JSON.stringify(techData)
                            });
                            if (!techResp.ok) {
                                // Fallback: create profile if missing (some legacy DB states)
                                await apiFetch(`${API_BASE_URL}/technicians`, {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        user_id: techUserId,
                                        employee_code: techData.employee_code,
                                        trade: techData.trade,
                                        hourly_rate: techData.hourly_rate,
                                        max_concurrent_jobs: techData.max_concurrent_jobs || 3
                                    })
                                });
                            }

                            // Save planned weekly schedule (non-blocking if scheduling tables aren't installed)
                            const schedule = collectBuTechSchedule();
                            if (schedule.length > 0) {
                                const schedResp = await apiFetch(`${API_BASE_URL}/technicians/${techUserId}/schedule`, {
                                    method: 'PUT',
                                    body: JSON.stringify({ schedule })
                                });
                                if (!schedResp.ok) {
                                    const err = await schedResp.json().catch(() => ({}));
                                    console.warn('Schedule save failed:', err);
                                }
                            }
                        }
                    }
                    alert(isEdit ? 'User updated!' : 'User created!');
                    closeUserModal();
                    loadUsers();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error?.message || 'Failed'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
            }
        });

        // Logout
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['createJobTypeModal', 'createAssetTypeModal', 'createPriorityModal', 'createJobStatusModal', 'createAssetStatusModal', 'createPartStatusModal', 'createPartCategoryModal', 'assetModal', 'partModal', 'locationModal', 'userModal', 'shiftAdjustmentModal', 'assignmentDetailsModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    if (modalId === 'createJobTypeModal') closeCreateJobTypeModal();
                    else if (modalId === 'createAssetTypeModal') closeCreateAssetTypeModal();
                    else if (modalId === 'createPriorityModal') closeCreatePriorityModal();
                    else if (modalId === 'createJobStatusModal') closeCreateJobStatusModal();
                    else if (modalId === 'createAssetStatusModal') closeCreateAssetStatusModal();
                    else if (modalId === 'createPartStatusModal') closeCreatePartStatusModal();
                    else if (modalId === 'createPartCategoryModal') closeCreatePartCategoryModal();
                    else if (modalId === 'assetModal') closeAssetModal();
                    else if (modalId === 'partModal') closePartModal();
                    else if (modalId === 'locationModal') closeLocationModal();
                    else if (modalId === 'userModal') closeUserModal();
                    else if (modalId === 'shiftAdjustmentModal') closeShiftAdjustmentModal();
                    else if (modalId === 'assignmentDetailsModal') closeAssignmentDetailsModal();
                }
            });
        };

        function closeAssignmentDetailsModal() {
            const modal = document.getElementById('assignmentDetailsModal');
            if (modal) modal.style.display = 'none';
        }

        // ============================================================================
        // ASSET TYPES MANAGEMENT FUNCTIONS
        // ============================================================================

        // Load Asset Types
        async function loadAssetTypes() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/asset-types/${userBusinessUnitId}`);
                const data = await response.json();
                const assetTypes = data.data || [];
                
                if (assetTypes.length > 0) {
                    let html = '<table><tr><th>Icon</th><th>Code</th><th>Name</th><th>Description</th><th>Display Order</th><th>Actions</th></tr>';
                    assetTypes.forEach(type => {
                        html += `
                            <tr>
                                <td style="font-size: 1.5em;">${type.icon || 'üè≠'}</td>
                                <td><code>${type.type_code}</code></td>
                                <td><strong>${type.type_name}</strong></td>
                                <td>${type.description || '-'}</td>
                                <td>${type.display_order}</td>
                                <td>
                                    <button class="btn-edit" onclick="editAssetType(${type.id})">Edit</button>
                                    <button class="btn-danger" onclick="deleteAssetType(${type.id}, '${type.type_name.replace(/'/g, "\\'")}')">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    document.getElementById('assetTypesList').innerHTML = html;
                } else {
                    document.getElementById('assetTypesList').innerHTML = '<p>No asset types found. Click "Create New Asset Type" to add one.</p>';
                }
            } catch (error) {
                console.error('Error loading asset types:', error);
                document.getElementById('assetTypesList').innerHTML = '<p style="color: red;">Error loading asset types</p>';
            }
        }

        // Open create asset type modal
        function openCreateAssetTypeModal() {
            document.getElementById('assetTypeModalTitle').textContent = 'Create New Asset Type';
            document.getElementById('assetTypeId').value = '';
            document.getElementById('createAssetTypeForm').reset();
            document.getElementById('assetTypeIcon').value = 'üîß';
            document.getElementById('assetTypeColor').value = '#17a2b8';
            document.getElementById('assetTypeDisplayOrder').value = '0';
            document.getElementById('createAssetTypeModal').style.display = 'block';
        }

        // Edit asset type
        async function editAssetType(id) {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/asset-types/${userBusinessUnitId}`);
                const data = await response.json();
                const assetType = (data.data || []).find(at => at.id === id);
                
                if (assetType) {
                    document.getElementById('assetTypeModalTitle').textContent = 'Edit Asset Type';
                    document.getElementById('assetTypeId').value = assetType.id;
                    document.getElementById('assetTypeCode').value = assetType.type_code;
                    document.getElementById('assetTypeCode').readOnly = true; // Cannot change code
                    document.getElementById('assetTypeName').value = assetType.type_name;
                    document.getElementById('assetTypeDescription').value = assetType.description || '';
                    document.getElementById('assetTypeIcon').value = assetType.icon || 'üîß';
                    document.getElementById('assetTypeColor').value = assetType.color || '#17a2b8';
                    document.getElementById('assetTypeDisplayOrder').value = assetType.display_order || 0;
                    document.getElementById('createAssetTypeModal').style.display = 'block';
                } else {
                    alert('Asset type not found');
                }
            } catch (error) {
                console.error('Error loading asset type:', error);
                alert('Error loading asset type: ' + error.message);
            }
        }

        // Delete asset type
        async function deleteAssetType(id, name) {
            if (!confirm(`Are you sure you want to delete asset type "${name}"?`)) {
                return;
            }
            
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/asset-types/${userBusinessUnitId}/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Asset type deleted successfully');
                    loadAssetTypes();
                } else {
                    const data = await response.json();
                    alert('Error deleting asset type: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting asset type:', error);
                alert('Error deleting asset type: ' + error.message);
            }
        }

        // Close asset type modal
        function closeCreateAssetTypeModal() {
            document.getElementById('createAssetTypeModal').style.display = 'none';
            document.getElementById('createAssetTypeForm').reset();
            document.getElementById('assetTypeCode').readOnly = false;
        }

        // Handle asset type form submission
        document.addEventListener('DOMContentLoaded', function() {
            const assetTypeForm = document.getElementById('createAssetTypeForm');
            if (assetTypeForm) {
                assetTypeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    if (!userBusinessUnitId) {
                        const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                        const userData = await userResponse.json();
                        userBusinessUnitId = userData.business_unit_id;
                    }

                    const assetTypeId = document.getElementById('assetTypeId').value;
                    const isEdit = !!assetTypeId;
                    const submitBtn = document.getElementById('submitAssetTypeBtn');
                    submitBtn.disabled = true;
                    submitBtn.textContent = isEdit ? 'Updating...' : 'Creating...';
                    
                    try {
                        const assetTypeData = {
                            type_code: document.getElementById('assetTypeCode').value.trim().toUpperCase(),
                            type_name: document.getElementById('assetTypeName').value.trim(),
                            description: document.getElementById('assetTypeDescription').value.trim() || null,
                            icon: document.getElementById('assetTypeIcon').value,
                            color: document.getElementById('assetTypeColor').value,
                            display_order: parseInt(document.getElementById('assetTypeDisplayOrder').value) || 0
                        };
                        
                        let response;
                        if (isEdit) {
                            // Remove type_code from update (cannot change)
                            delete assetTypeData.type_code;
                            response = await apiFetch(`${API_BASE_URL}/asset-types/${userBusinessUnitId}/${assetTypeId}`, {
                                method: 'PATCH',
                                body: JSON.stringify(assetTypeData)
                            });
                        } else {
                            response = await apiFetch(`${API_BASE_URL}/asset-types/${userBusinessUnitId}`, {
                                method: 'POST',
                                body: JSON.stringify(assetTypeData)
                            });
                        }
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            alert(isEdit ? 'Asset type updated successfully!' : 'Asset type created successfully!');
                            closeCreateAssetTypeModal();
                            loadAssetTypes();
                        } else {
                            alert('Error: ' + (data.error?.message || 'Failed to save asset type'));
                        }
                    } catch (error) {
                        console.error('Error saving asset type:', error);
                        alert('Error: ' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = isEdit ? 'Update Asset Type' : 'Create Asset Type';
                    }
                });
            }
        });

        // ============================================================================
        // ASSET MANAGEMENT FUNCTIONS
        // ============================================================================

        let assetTypesCache = [];
        let assetStatusesCache = [];

        function getAssetStatusMeta(code) {
            const c = String(code || '').trim();
            const row = (assetStatusesCache || []).find(s => String(s.status_code) === c);
            if (row) {
                return {
                    code: row.status_code,
                    name: row.status_name || row.status_code,
                    color: row.color || '#6c757d',
                    badge: row.badge_style || 'success'
                };
            }
            // Safe fallback
            if (!c) return { code: '', name: '-', color: '#6c757d', badge: 'warning' };
            return { code: c, name: c, color: '#6c757d', badge: 'warning' };
        }

        function renderAssetStatusCell(asset) {
            const meta = getAssetStatusMeta(asset.status);
            const options = (assetStatusesCache || []).map(s => {
                const selected = String(s.status_code) === String(asset.status) ? 'selected' : '';
                return `<option value="${s.status_code}" ${selected}>${s.status_name}</option>`;
            }).join('');
            const selectHtml = (assetStatusesCache && assetStatusesCache.length > 0)
                ? `<select onchange="quickSetAssetStatus(${asset.id}, this.value)" style="padding:6px; border-radius:6px; border:1px solid #ddd;">
                        ${options}
                   </select>`
                : `<span class="badge ${meta.badge}">${meta.name}</span>`;

            return `
                <div style="display:flex; flex-direction:column; gap:6px;">
                    <span class="badge ${meta.badge}" style="width: fit-content;">${meta.name}</span>
                    ${selectHtml}
                </div>
            `;
        }

        async function quickSetAssetStatus(assetId, statusCode) {
            try {
                const response = await apiFetch(`${API_BASE_URL}/assets/${assetId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: statusCode })
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok) {
                    alert('Error updating status: ' + (data?.error?.message || 'Failed'));
                    return;
                }
                // Refresh list to reflect any additional server-side changes
                loadAssets();
            } catch (error) {
                alert('Error updating status: ' + error.message);
            }
        }

        // Load Assets
        async function loadAssets() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                // Load asset types for filter dropdown
                await loadAssetTypesForDropdown();
                // Load asset statuses for filter dropdown + quick update menu
                await loadAssetStatusesForDropdown();

                const typeFilter = document.getElementById('filterAssetType')?.value || '';
                const statusFilter = document.getElementById('filterAssetStatus')?.value || '';
                const search = document.getElementById('searchAsset')?.value || '';

                let url = `${API_BASE_URL}/assets?business_unit_id=${userBusinessUnitId}`;
                if (typeFilter) url += `&asset_type=${encodeURIComponent(typeFilter)}`;
                if (statusFilter) url += `&status=${statusFilter}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const response = await apiFetch(url);
                const data = await response.json();
                const assets = Array.isArray(data) ? data : (data.data || []);
                
                if (assets.length > 0) {
                    let html = '<table><tr><th>Name</th><th>Type</th><th>Asset Tag</th><th>Serial #</th><th>Location</th><th>Status</th><th>Cost</th><th>Actions</th></tr>';
                    assets.forEach(asset => {
                        const cost = asset.cost != null ? formatMoney(asset.cost, asset.currency_code || DEFAULT_CURRENCY_LEGACY) : '-';
                        html += `
                            <tr>
                                <td>${asset.name}</td>
                                <td>${asset.asset_type || '-'}</td>
                                <td>${asset.asset_tag || '-'}</td>
                                <td>${asset.serial_number || '-'}</td>
                                <td>${asset.location_name || '-'}</td>
                                <td>${renderAssetStatusCell(asset)}</td>
                                <td>${cost}</td>
                                <td>
                                    <button class="btn-edit" onclick="editAsset(${asset.id})">Edit</button>
                                    <button class="btn-danger" onclick="deleteAsset(${asset.id}, '${asset.name.replace(/'/g, "\\'")}')">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    document.getElementById('assetsList').innerHTML = html;
                } else {
                    document.getElementById('assetsList').innerHTML = '<p>No assets found. Click "Add New Asset" to create one.</p>';
                }
            } catch (error) {
                console.error('Error loading assets:', error);
                document.getElementById('assetsList').innerHTML = '<p style="color: red;">Error loading assets</p>';
            }
        }

        // Load locations for asset form
        async function loadLocationsForAssets() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/locations?business_unit_id=${userBusinessUnitId}`);
                const data = await response.json();
                const locations = Array.isArray(data) ? data : (data.data || []);
                
                const select = document.getElementById('assetLocation');
                if (select) {
                    select.innerHTML = '<option value="">Select location...</option>';
                    locations.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = loc.id;
                        option.textContent = loc.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        // Load asset types for dropdown
        async function loadAssetTypesForDropdown() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/asset-types/${userBusinessUnitId}`);
                const data = await response.json();
                const assetTypes = data.data || [];
                assetTypesCache = assetTypes;
                
                const select = document.getElementById('assetType');
                const filterSelect = document.getElementById('filterAssetType');
                
                if (select) {
                    select.innerHTML = '<option value="">Select type...</option>';
                    assetTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.type_name;
                        option.textContent = `${type.icon || ''} ${type.type_name}`;
                        select.appendChild(option);
                    });
                }
                
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="">All Asset Types</option>';
                    assetTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.type_name;
                        option.textContent = `${type.icon || ''} ${type.type_name}`;
                        filterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading asset types:', error);
            }
        }

        // Load asset statuses for dropdown
        async function loadAssetStatusesForDropdown() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }
                const response = await apiFetch(`${API_BASE_URL}/asset-statuses/${userBusinessUnitId}`);
                const data = await response.json();
                const statuses = data.data || [];
                assetStatusesCache = statuses;
                
                const select = document.getElementById('assetStatus');
                const filterSelect = document.getElementById('filterAssetStatus');
                
                if (select) {
                    select.innerHTML = '<option value="">Select status...</option>';
                    statuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status.status_code;
                        option.textContent = status.status_name;
                        select.appendChild(option);
                    });
                }
                
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="">All Statuses</option>';
                    statuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status.status_code;
                        option.textContent = status.status_name;
                        filterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading asset statuses:', error);
            }
        }

        // Load part statuses for dropdown
        async function loadPartStatusesForDropdown() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }
                const response = await apiFetch(`${API_BASE_URL}/part-statuses/${userBusinessUnitId}`);
                const data = await response.json();
                const statuses = data.data || [];
                
                const select = document.getElementById('partStatus');
                const filterSelect = document.getElementById('filterPartStatus');
                
                if (select) {
                    select.innerHTML = '<option value="">Select status...</option>';
                    statuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status.status_code;
                        option.textContent = status.status_name;
                        select.appendChild(option);
                    });
                }
                
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="">All Statuses</option>';
                    statuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status.status_code;
                        option.textContent = status.status_name;
                        filterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading part statuses:', error);
            }
        }

        // Open create asset modal
        async function openCreateAssetModal() {
            document.getElementById('assetModalTitle').textContent = 'Add New Asset';
            document.getElementById('assetId').value = '';
            document.getElementById('assetForm').reset();
            const assetCur = document.getElementById('assetCurrency');
            if (assetCur) assetCur.value = DEFAULT_CURRENCY_NEW;
            await loadLocationsForAssets();
            await loadAssetTypesForDropdown();
            await loadAssetStatusesForDropdown();
            // Set default to first active status if available
            const statusSelect = document.getElementById('assetStatus');
            if (statusSelect.options.length > 1) {
                statusSelect.selectedIndex = 1;
            }
            document.getElementById('assetModal').style.display = 'block';
        }

        // Edit asset
        async function editAsset(id) {
            try {
                const response = await apiFetch(`${API_BASE_URL}/assets/${id}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('assetModalTitle').textContent = 'Edit Asset';
                    document.getElementById('assetId').value = data.id;
                    document.getElementById('assetName').value = data.name || '';
                    document.getElementById('assetType').value = data.asset_type || '';
                    document.getElementById('assetStatus').value = data.status || 'active';
                    document.getElementById('assetTag').value = data.asset_tag || '';
                    document.getElementById('assetSerial').value = data.serial_number || '';
                    document.getElementById('assetBarcode').value = data.barcode || '';
                    document.getElementById('assetQRCode').value = data.qr_code || '';
                    document.getElementById('assetCost').value = data.cost || '';
                    document.getElementById('assetCurrency').value = data.currency_code || data.metadata?.currency_code || DEFAULT_CURRENCY_LEGACY;
                    document.getElementById('assetPurchaseDate').value = data.purchase_date || '';
                    document.getElementById('assetManufacturer').value = data.manufacturer || '';
                    document.getElementById('assetModel').value = data.model || '';
                    document.getElementById('assetYear').value = data.year || '';
                    document.getElementById('assetWarranty').value = data.warranty_expiry || '';
                    
                    await loadLocationsForAssets();
                    await loadAssetTypesForDropdown();
                    await loadAssetStatusesForDropdown();
                    document.getElementById('assetType').value = data.asset_type || '';
                    document.getElementById('assetStatus').value = data.status || '';
                    document.getElementById('assetLocation').value = data.location_id || '';
                    
                    document.getElementById('assetModal').style.display = 'block';
                } else {
                    alert('Error loading asset: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading asset:', error);
                alert('Error loading asset: ' + error.message);
            }
        }

        // Delete asset
        async function deleteAsset(id, name) {
            if (!confirm(`Are you sure you want to delete asset "${name}"?\n\nThis will deactivate the asset.`)) {
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE_URL}/assets/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Asset deleted successfully');
                    loadAssets();
                } else {
                    const data = await response.json();
                    alert('Error deleting asset: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Error deleting asset: ' + error.message);
            }
        }

        // Close asset modal
        function closeAssetModal() {
            document.getElementById('assetModal').style.display = 'none';
            document.getElementById('assetForm').reset();
        }

        // Handle asset form submission
        document.addEventListener('DOMContentLoaded', function() {
            const assetForm = document.getElementById('assetForm');
            if (assetForm) {
                assetForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const assetId = document.getElementById('assetId').value;
                    const isEdit = !!assetId;
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = isEdit ? 'Updating...' : 'Creating...';
                    
                    try {
                        if (!userBusinessUnitId) {
                            const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                            const userData = await userResponse.json();
                            userBusinessUnitId = userData.business_unit_id;
                        }

                        const assetData = {
                            name: document.getElementById('assetName').value.trim(),
                            asset_type: document.getElementById('assetType').value,
                            status: document.getElementById('assetStatus').value,
                            asset_tag: document.getElementById('assetTag').value.trim(),
                            serial_number: document.getElementById('assetSerial').value.trim() || null,
                            barcode: document.getElementById('assetBarcode').value.trim() || null,
                            qr_code: document.getElementById('assetQRCode').value.trim() || null,
                            business_unit_id: userBusinessUnitId,
                            location_id: parseInt(document.getElementById('assetLocation').value),
                            cost: document.getElementById('assetCost').value ? parseFloat(document.getElementById('assetCost').value) : null,
                            currency_code: normalizeCurrencyCode(document.getElementById('assetCurrency')?.value || DEFAULT_CURRENCY_NEW),
                            purchase_date: document.getElementById('assetPurchaseDate').value || null,
                            manufacturer: document.getElementById('assetManufacturer').value.trim() || null,
                            model: document.getElementById('assetModel').value.trim() || null,
                            year: document.getElementById('assetYear').value ? parseInt(document.getElementById('assetYear').value) : null,
                            warranty_expiry: document.getElementById('assetWarranty').value || null
                        };
                        
                        let response;
                        if (isEdit) {
                            response = await apiFetch(`${API_BASE_URL}/assets/${assetId}`, {
                                method: 'PATCH',
                                body: JSON.stringify(assetData)
                            });
                        } else {
                            response = await apiFetch(`${API_BASE_URL}/assets`, {
                                method: 'POST',
                                body: JSON.stringify(assetData)
                            });
                        }
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            alert(isEdit ? 'Asset updated successfully!' : 'Asset created successfully!');
                            closeAssetModal();
                            loadAssets();
                            loadSummaryStats();
                        } else {
                            alert('Error: ' + (data.error?.message || 'Failed to save asset'));
                        }
                    } catch (error) {
                        console.error('Error saving asset:', error);
                        alert('Error: ' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Save Asset';
                    }
                });
            }
        });

        // ============================================================================
        // PARTS MANAGEMENT FUNCTIONS
        // ============================================================================

        // Load Parts
        async function loadParts() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const locationFilter = document.getElementById('filterPartLocation')?.value || '';
                const statusFilter = document.getElementById('filterPartStatus')?.value || '';
                const search = document.getElementById('searchPart')?.value || '';

                let url = `${API_BASE_URL}/parts?business_unit_id=${userBusinessUnitId}`;
                if (locationFilter) url += `&location_id=${locationFilter}`;
                if (statusFilter) url += `&status=${statusFilter}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const response = await apiFetch(url);
                const data = await response.json();
                const parts = Array.isArray(data) ? data : (data.data || []);
                
                if (parts.length > 0) {
                    let html = '<table><tr><th>Name</th><th>Part Number</th><th>Parent Asset</th><th>Location</th><th>Status</th><th>Cost</th><th>Stock</th><th>Actions</th></tr>';
                    parts.forEach(part => {
                        const cost = part.cost != null ? formatMoney(part.cost, part.currency_code || DEFAULT_CURRENCY_LEGACY) : '-';
                        const stock = (part.quantity_in_stock !== undefined && part.quantity_in_stock !== null) ? part.quantity_in_stock : 0;
                        html += `
                            <tr>
                                <td>${part.name}</td>
                                <td>${part.part_number || '-'}</td>
                                <td>${part.parent_asset_name || '-'}</td>
                                <td>${part.location_name || '-'}</td>
                                <td><span class="badge ${part.status === 'active' ? 'success' : part.status === 'out_of_stock' ? 'danger' : 'warning'}">${part.status}</span></td>
                                <td>${cost}</td>
                                <td>${stock}</td>
                                <td>
                                    <button class="btn-edit" onclick="editPart(${part.id})">Edit</button>
                                    <button class="btn-danger" onclick="deletePart(${part.id}, '${part.name.replace(/'/g, "\\'")}')">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    document.getElementById('partsList').innerHTML = html;
                } else {
                    document.getElementById('partsList').innerHTML = '<p>No parts found. Click "Add New Part" to create one.</p>';
                }
            } catch (error) {
                console.error('Error loading parts:', error);
                document.getElementById('partsList').innerHTML = '<p style="color: red;">Error loading parts</p>';
            }
        }

        // Load locations for parts form
        async function loadLocationsForParts() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/locations?business_unit_id=${userBusinessUnitId}`);
                const data = await response.json();
                const locations = Array.isArray(data) ? data : (data.data || []);
                
                const select = document.getElementById('partLocation');
                const filterSelect = document.getElementById('filterPartLocation');
                
                [select, filterSelect].forEach(sel => {
                    if (sel) {
                        sel.innerHTML = sel === filterSelect ? '<option value="">All Locations</option>' : '<option value="">Select location...</option>';
                        locations.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc.id;
                            option.textContent = loc.name;
                            sel.appendChild(option);
                        });
                    }
                });
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }

        // Load assets for parts form (parent asset)
        async function loadAssetsForParts() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/assets?business_unit_id=${userBusinessUnitId}`);
                const data = await response.json();
                const assets = Array.isArray(data) ? data : (data.data || []);
                
                const select = document.getElementById('partParentAsset');
                if (select) {
                    select.innerHTML = '<option value="">Select parent asset...</option>';
                    assets.forEach(asset => {
                        const option = document.createElement('option');
                        option.value = asset.id;
                        option.textContent = `${asset.name} (${asset.asset_tag || 'No tag'})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading assets:', error);
            }
        }

        // Open create part modal
        async function openCreatePartModal() {
            document.getElementById('partModalTitle').textContent = 'Add New Part';
            document.getElementById('partId').value = '';
            document.getElementById('partForm').reset();
            const partCur = document.getElementById('partCurrency');
            if (partCur) partCur.value = DEFAULT_CURRENCY_NEW;
            await loadLocationsForParts();
            await loadAssetsForParts();
            await loadPartStatusesForDropdown();
            // Set default to first status if available
            const statusSelect = document.getElementById('partStatus');
            if (statusSelect.options.length > 1) {
                statusSelect.selectedIndex = 1;
            }
            document.getElementById('partModal').style.display = 'block';
        }

        // Edit part
        async function editPart(id) {
            try {
                const response = await apiFetch(`${API_BASE_URL}/parts/${id}`);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('partModalTitle').textContent = 'Edit Part';
                    document.getElementById('partId').value = data.id;
                    document.getElementById('partName').value = data.name || '';
                    document.getElementById('partNumber').value = data.part_number || '';
                    document.getElementById('partSerial').value = data.serial_number || '';
                    document.getElementById('partBarcode').value = data.barcode || '';
                    document.getElementById('partQRCode').value = data.qr_code || '';
                    document.getElementById('partStatus').value = data.status || 'active';
                    document.getElementById('partCost').value = data.cost || '';
                    document.getElementById('partCurrency').value = data.currency_code || data.metadata?.currency_code || DEFAULT_CURRENCY_LEGACY;
                    document.getElementById('partManufacturer').value = data.manufacturer || '';
                    document.getElementById('partStockQty').value = (data.quantity_in_stock !== undefined && data.quantity_in_stock !== null) ? data.quantity_in_stock : 0;
                    
                    await loadLocationsForParts();
                    await loadAssetsForParts();
                    await loadPartStatusesForDropdown();
                    document.getElementById('partParentAsset').value = data.parent_asset_id || '';
                    document.getElementById('partLocation').value = data.location_id || '';
                    document.getElementById('partStatus').value = data.status || '';
                    
                    document.getElementById('partModal').style.display = 'block';
                } else {
                    alert('Error loading part: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading part:', error);
                alert('Error loading part: ' + error.message);
            }
        }

        // Delete part
        async function deletePart(id, name) {
            if (!confirm(`Are you sure you want to delete part "${name}"?`)) {
                return;
            }
            
            try {
                const response = await apiFetch(`${API_BASE_URL}/parts/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Part deleted successfully');
                    loadParts();
                } else {
                    const data = await response.json();
                    alert('Error deleting part: ' + (data.error?.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Error deleting part: ' + error.message);
            }
        }

        // Close part modal
        function closePartModal() {
            document.getElementById('partModal').style.display = 'none';
            document.getElementById('partForm').reset();
        }

        // Handle part form submission
        document.addEventListener('DOMContentLoaded', function() {
            const partForm = document.getElementById('partForm');
            if (partForm) {
                partForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const partId = document.getElementById('partId').value;
                    const isEdit = !!partId;
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = isEdit ? 'Updating...' : 'Creating...';
                    
                    try {
                        const partData = {
                            name: document.getElementById('partName').value.trim(),
                            part_number: document.getElementById('partNumber').value.trim() || null,
                            serial_number: document.getElementById('partSerial').value.trim() || null,
                            barcode: document.getElementById('partBarcode').value.trim() || null,
                            qr_code: document.getElementById('partQRCode').value.trim() || null,
                            parent_asset_id: document.getElementById('partParentAsset').value
                                ? parseInt(document.getElementById('partParentAsset').value)
                                : null,
                            location_id: document.getElementById('partLocation').value ? parseInt(document.getElementById('partLocation').value) : null,
                            status: document.getElementById('partStatus').value,
                            cost: document.getElementById('partCost').value ? parseFloat(document.getElementById('partCost').value) : null,
                            manufacturer: document.getElementById('partManufacturer').value.trim() || null,
                            currency_code: normalizeCurrencyCode(document.getElementById('partCurrency')?.value || DEFAULT_CURRENCY_NEW),
                            metadata: {
                                quantity_in_stock: parseInt(document.getElementById('partStockQty').value) || 0
                            }
                        };

                        // If BU uses In Stock / Out of Stock statuses, keep status consistent with quantity
                        const qty = partData.metadata.quantity_in_stock;
                        const s = String(partData.status || '').toLowerCase();
                        if (s === 'in_stock' || s === 'out_of_stock' || s === 'active' || s === 'inactive') {
                            partData.status = qty > 0 ? 'in_stock' : 'out_of_stock';
                        }
                        
                        let response;
                        if (isEdit) {
                            response = await apiFetch(`${API_BASE_URL}/parts/${partId}`, {
                                method: 'PATCH',
                                body: JSON.stringify(partData)
                            });
                        } else {
                            response = await apiFetch(`${API_BASE_URL}/parts`, {
                                method: 'POST',
                                body: JSON.stringify(partData)
                            });
                        }
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            alert(isEdit ? 'Part updated successfully!' : 'Part created successfully!');
                            closePartModal();
                            loadParts();
                        } else {
                            alert('Error: ' + (data.error?.message || 'Failed to save part'));
                        }
                    } catch (error) {
                        console.error('Error saving part:', error);
                        alert('Error: ' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Save Part';
                    }
                });
            }
        });

        // ============================================================================
        // ASSIGNMENTS MANAGEMENT FUNCTIONS
        // ============================================================================

        // Load Assignments
        async function loadAssignments() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const statusFilter = document.getElementById('filterAssignmentStatus')?.value || '';
                const technicianFilter = document.getElementById('filterAssignmentTechnician')?.value || '';

                let url = `${API_BASE_URL}/assignments?business_unit_id=${userBusinessUnitId}`;
                if (statusFilter) url += `&status=${statusFilter}`;
                if (technicianFilter) url += `&technician_id=${technicianFilter}`;

                const response = await apiFetch(url);
                const data = await response.json();
                const assignments = data.data || [];
                window.__buAssignmentsCache = assignments;
                
                if (assignments.length > 0) {
                    let html = '<table><tr><th>Job Number</th><th>Customer</th><th>Technician</th><th>Status</th><th>Assigned At</th><th>Time Spent</th><th>Actions</th></tr>';
                    assignments.forEach(assignment => {
                        const timeSpent = assignment.total_time_formatted || '0m';
                        const assignedAt = new Date(assignment.assigned_at).toLocaleString();
                        
                        html += `
                            <tr>
                                <td>${assignment.job_number}</td>
                                <td>${assignment.customer_name || '-'}</td>
                                <td>${assignment.technician_name} (${assignment.employee_code || '-'})</td>
                                <td><span class="badge ${assignment.status === 'completed' ? 'success' : assignment.status === 'in_progress' ? 'info' : assignment.status === 'cancelled' ? 'danger' : 'warning'}">${assignment.status}</span></td>
                                <td>${assignedAt}</td>
                                <td>${timeSpent}</td>
                                <td>
                                    <button class="btn-edit" onclick="viewAssignmentDetails(${assignment.id})">View</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</table>';
                    document.getElementById('assignmentsList').innerHTML = html;
                } else {
                    document.getElementById('assignmentsList').innerHTML = '<p>No assignments found.</p>';
                }
            } catch (error) {
                console.error('Error loading assignments:', error);
                document.getElementById('assignmentsList').innerHTML = '<p style="color: red;">Error loading assignments</p>';
            }
        }

        // Load technicians for filter
        async function loadTechniciansForFilter() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/technicians?business_unit_id=${userBusinessUnitId}`);
                const data = await response.json();
                const technicians = data.data || [];
                
                const select = document.getElementById('filterAssignmentTechnician');
                if (select) {
                    select.innerHTML = '<option value="">All Technicians</option>';
                    technicians.forEach(tech => {
                        const option = document.createElement('option');
                        option.value = tech.user_id;
                        option.textContent = `${tech.user?.display_name || tech.display_name} (${tech.employee_code})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading technicians:', error);
            }
        }

        // View assignment details
        async function viewAssignmentDetails(assignmentId) {
            const modal = document.getElementById('assignmentDetailsModal');
            const body = document.getElementById('assignmentDetailsBody');
            if (!modal || !body) {
                alert('Assignment details view is not available on this page.');
                return;
            }

            modal.style.display = 'block';
            body.innerHTML = '<p>Loading assignment details...</p>';

            try {
                const assignments = window.__buAssignmentsCache || [];
                const a = assignments.find(x => String(x.id) === String(assignmentId));
                if (!a) {
                    body.innerHTML = `<p style="color:#a00;">Assignment not found in the current list. Please refresh and try again.</p>`;
                    return;
                }

                const jobResp = await apiFetch(`${API_BASE_URL}/jobcards/${a.job_card_id}`);
                const job = await jobResp.json();
                if (!jobResp.ok) {
                    body.innerHTML = `<p style="color:#a00;">Failed to load job card: ${(job.error?.message || 'Unknown error')}</p>`;
                    return;
                }

                const safeJson = (v) => {
                    if (!v) return null;
                    if (typeof v === 'object') return v;
                    if (typeof v === 'string') { try { return JSON.parse(v); } catch { return null; } }
                    return null;
                };

                const vehicle = safeJson(job.vehicle_info) || job.vehicle_info || {};
                const meta = safeJson(job.metadata) || job.metadata || {};
                const w = (meta && meta.work_order_details) ? meta.work_order_details : {};
                const plate = vehicle.license_plate || vehicle.plate || vehicle.number_plate || '';

                // Time logs: filter to this assignment if possible
                const logs = Array.isArray(job.time_logs) ? job.time_logs : [];
                const filteredLogs = logs.filter(l => String(l.assignment_id || '') === String(assignmentId));

                const formatSeconds = (sec) => {
                    const s = parseInt(sec || 0, 10) || 0;
                    const h = Math.floor(s / 3600);
                    const m = Math.floor((s % 3600) / 60);
                    const ss = s % 60;
                    if (h > 0) return `${h}h ${m}m`;
                    if (m > 0) return `${m}m ${ss}s`;
                    return `${ss}s`;
                };

                const assignmentRow = (Array.isArray(job.assignments) ? job.assignments : []).find(x => String(x.id) === String(assignmentId));
                const techName = assignmentRow?.technician_name || a.technician_name || '-';
                const empCode = assignmentRow?.employee_code || a.employee_code || '-';

                let html = `
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div><strong>Job #:</strong> ${job.job_number || '-'}</div>
                        <div><strong>Status:</strong> ${job.status || '-'}</div>
                        <div><strong>Customer:</strong> ${job.customer_name || '-'}</div>
                        <div><strong>Work Type:</strong> ${job.work_type || '-'}</div>
                        <div><strong>Location:</strong> ${job.location_name || '-'}</div>
                        <div><strong>Asset:</strong> ${job.asset_name || '-'}</div>
                        <div><strong>Plate:</strong> ${plate || '-'}</div>
                        <div><strong>Technician:</strong> ${techName} (${empCode})</div>
                    </div>
                `;

                const complaint = w.complaint || w.problem_description || w.issue || '';
                const bikeCond = w.bike_condition_review || '';
                if (complaint || bikeCond) {
                    html += `<div style="margin-top:14px;">
                        <div style="font-weight:800; margin-bottom:6px;">Notes</div>
                        ${complaint ? `<div style="margin-bottom:8px;"><strong>Complaint:</strong><br>${String(complaint)}</div>` : ''}
                        ${bikeCond ? `<div><strong>Condition Review:</strong><br>${String(bikeCond)}</div>` : ''}
                    </div>`;
                }

                html += `<div style="margin-top:16px;">
                    <div style="font-weight:800; margin-bottom:6px;">Time Logs</div>`;

                const showLogs = filteredLogs.length ? filteredLogs : logs;
                if (!showLogs.length) {
                    html += `<p>No time logs found for this job.</p>`;
                } else {
                    html += `<div style="overflow-x:auto;"><table style="width:100%;"><tr><th>Start</th><th>End</th><th>Status</th><th>Duration</th><th>Notes</th></tr>`;
                    showLogs.forEach(l => {
                        const start = l.start_ts ? new Date(l.start_ts).toLocaleString() : '-';
                        const end = l.end_ts ? new Date(l.end_ts).toLocaleString() : '-';
                        html += `<tr>
                            <td>${start}</td>
                            <td>${end}</td>
                            <td>${l.status || '-'}</td>
                            <td>${formatSeconds(l.duration_seconds)}</td>
                            <td>${(l.notes || '').toString().slice(0, 200) || '-'}</td>
                        </tr>`;
                    });
                    html += `</table></div>`;
                }
                html += `</div>`;

                body.innerHTML = html;
            } catch (err) {
                console.error('Assignment details error:', err);
                body.innerHTML = `<p style="color:#a00;">Error loading assignment details: ${err.message}</p>`;
            }
        }

        // ============================================================================
        // PRIORITY LEVELS MANAGEMENT
        // ============================================================================
        async function loadPriorities() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }
                const response = await apiFetch(`${API_BASE_URL}/priority-levels/${userBusinessUnitId}`);
                const data = await response.json();
                const priorities = data.data || [];
                
                if (priorities.length > 0) {
                    let html = '<table><tr><th>Value</th><th>Name</th><th>Description</th><th>Badge</th><th>Actions</th></tr>';
                    priorities.forEach(p => {
                        html += `<tr><td>${p.priority_value}</td><td><strong>${p.priority_name}</strong></td><td>${p.description || '-'}</td>
                        <td><span class="badge ${p.badge_style}">${p.priority_name}</span></td>
                        <td><button class="btn-edit" onclick="editPriority(${p.id})">Edit</button>
                        <button class="btn-danger" onclick="deletePriority(${p.id}, '${p.priority_name.replace(/'/g, "\\'")}')">Delete</button></td></tr>`;
                    });
                    html += '</table>';
                    document.getElementById('prioritiesList').innerHTML = html;
                } else {
                    document.getElementById('prioritiesList').innerHTML = '<p>No priorities found.</p>';
                }
            } catch (error) {
                console.error('Error loading priorities:', error);
                document.getElementById('prioritiesList').innerHTML = '<p style="color: red;">Error loading priorities</p>';
            }
        }

        function openCreatePriorityModal() {
            document.getElementById('priorityModalTitle').textContent = 'Create New Priority Level';
            document.getElementById('priorityId').value = '';
            document.getElementById('createPriorityForm').reset();
            document.getElementById('priorityColor').value = '#ffc107';
            document.getElementById('priorityBadge').value = 'warning';
            document.getElementById('createPriorityModal').style.display = 'block';
        }

        function closeCreatePriorityModal() {
            document.getElementById('createPriorityModal').style.display = 'none';
            document.getElementById('createPriorityForm').reset();
        }

        async function editPriority(id) {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }
                const response = await apiFetch(`${API_BASE_URL}/priority-levels/${userBusinessUnitId}`);
                const data = await response.json();
                const priority = (data.data || []).find(p => p.id === id);
                if (priority) {
                    document.getElementById('priorityModalTitle').textContent = 'Edit Priority Level';
                    document.getElementById('priorityId').value = priority.id;
                    document.getElementById('priorityValue').value = priority.priority_value;
                    document.getElementById('priorityValue').readOnly = true;
                    document.getElementById('priorityName').value = priority.priority_name;
                    document.getElementById('priorityDescription').value = priority.description || '';
                    document.getElementById('priorityColor').value = priority.color || '#ffc107';
                    document.getElementById('priorityBadge').value = priority.badge_style || 'warning';
                    document.getElementById('createPriorityModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading priority:', error);
                alert('Error loading priority');
            }
        }

        async function deletePriority(id, name) {
            if (!confirm(`Delete priority "${name}"?`)) return;
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }
                const response = await apiFetch(`${API_BASE_URL}/priority-levels/${userBusinessUnitId}/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('Priority deleted successfully');
                    loadPriorities();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error?.message || 'Failed'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        document.getElementById('createPriorityForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userBusinessUnitId) {
                const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                const userData = await userResponse.json();
                userBusinessUnitId = userData.business_unit_id;
            }
            const priorityId = document.getElementById('priorityId').value;
            const isEdit = !!priorityId;
            const submitBtn = document.getElementById('submitPriorityBtn');
            submitBtn.disabled = true;
            try {
                const priorityData = {
                    priority_value: parseInt(document.getElementById('priorityValue').value),
                    priority_name: document.getElementById('priorityName').value.trim(),
                    description: document.getElementById('priorityDescription').value.trim() || null,
                    color: document.getElementById('priorityColor').value,
                    badge_style: document.getElementById('priorityBadge').value
                };
                if (isEdit) delete priorityData.priority_value;
                const response = await apiFetch(
                    isEdit ? `${API_BASE_URL}/priority-levels/${userBusinessUnitId}/${priorityId}` : `${API_BASE_URL}/priority-levels/${userBusinessUnitId}`,
                    { method: isEdit ? 'PATCH' : 'POST', body: JSON.stringify(priorityData) }
                );
                if (response.ok) {
                    alert(isEdit ? 'Priority updated!' : 'Priority created!');
                    closeCreatePriorityModal();
                    loadPriorities();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error?.message || 'Failed'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                document.getElementById('priorityValue').readOnly = false;
            }
        });

        // ============================================================================
        // JOB CARD STATUSES, ASSET STATUSES, PART STATUSES, PART CATEGORIES
        // (Similar pattern - functions for load, create, edit, delete for each)
        // ============================================================================
        
        // SIMPLIFIED: Generic config management functions
        const configTypes = {
            jobStatuses: { api: 'job-card-statuses', modal: 'createJobStatusModal', form: 'createJobStatusForm', list: 'jobStatusesList', idPrefix: 'jobStatus', hasClosedFlag: true },
            assetStatuses: { api: 'asset-statuses', modal: 'createAssetStatusModal', form: 'createAssetStatusForm', list: 'assetStatusesList', idPrefix: 'assetStatus', hasClosedFlag: false },
            partStatuses: { api: 'part-statuses', modal: 'createPartStatusModal', form: 'createPartStatusForm', list: 'partStatusesList', idPrefix: 'partStatus', hasClosedFlag: false },
            partCategories: { api: 'part-categories', modal: 'createPartCategoryModal', form: 'createPartCategoryForm', list: 'partCategoriesList', idPrefix: 'partCategory', hasClosedFlag: false }
        };

        // Generic load function
        async function loadConfig(configKey) {
            const config = configTypes[configKey];
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }
                const response = await apiFetch(`${API_BASE_URL}/${config.api}/${userBusinessUnitId}`);
                const data = await response.json();
                const items = data.data || [];
                
                if (items.length > 0) {
                    let html = '<table><tr><th>Code</th><th>Name</th><th>Description</th><th>Badge</th><th>Actions</th></tr>';
                    items.forEach(item => {
                        const code = item.status_code || item.category_code;
                        const name = item.status_name || item.category_name || item.priority_name;
                        const badge = item.badge_style || 'info';
                        html += `<tr><td><code>${code}</code></td><td><strong>${name}</strong></td><td>${item.description || '-'}</td>
                        <td><span class="badge ${badge}">${name}</span></td>
                        <td><button class="btn-edit" onclick="editConfigItem('${configKey}', ${item.id})">Edit</button>
                        <button class="btn-danger" onclick="deleteConfigItem('${configKey}', ${item.id}, '${name.replace(/'/g, "\\'")}')">Delete</button></td></tr>`;
                    });
                    html += '</table>';
                    document.getElementById(config.list).innerHTML = html;
                } else {
                    document.getElementById(config.list).innerHTML = '<p>No items found.</p>';
                }
            } catch (error) {
                console.error(`Error loading ${configKey}:`, error);
                document.getElementById(config.list).innerHTML = '<p style="color: red;">Error loading data</p>';
            }
        }

        // Wrapper functions
        function loadJobStatuses() { loadConfig('jobStatuses'); }
        function loadAssetStatuses() { loadConfig('assetStatuses'); }
        function loadPartStatuses() { loadConfig('partStatuses'); }
        function loadPartCategories() { loadConfig('partCategories'); }

        // Generic open modal
        function openCreateModal(configKey) {
            const config = configTypes[configKey];
            document.getElementById(config.modal).style.display = 'block';
            document.getElementById(config.form).reset();
            document.getElementById(`${config.idPrefix}Id`).value = '';
        }

        // Wrapper functions for modals
        function openCreateJobStatusModal() { openCreateModal('jobStatuses'); }
        function openCreateAssetStatusModal() { openCreateModal('assetStatuses'); }
        function openCreatePartStatusModal() { openCreateModal('partStatuses'); }
        function openCreatePartCategoryModal() { openCreateModal('partCategories'); }

        function closeCreateJobStatusModal() { document.getElementById('createJobStatusModal').style.display = 'none'; }
        function closeCreateAssetStatusModal() { document.getElementById('createAssetStatusModal').style.display = 'none'; }
        function closeCreatePartStatusModal() { document.getElementById('createPartStatusModal').style.display = 'none'; }
        function closeCreatePartCategoryModal() { document.getElementById('createPartCategoryModal').style.display = 'none'; }

        // Form submissions for config types
        ['createJobStatusForm', 'createAssetStatusForm', 'createPartStatusForm', 'createPartCategoryForm'].forEach(formId => {
            document.getElementById(formId)?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const configKey = formId.includes('JobStatus') ? 'jobStatuses' : 
                                  formId.includes('AssetStatus') ? 'assetStatuses' :
                                  formId.includes('PartStatus') ? 'partStatuses' : 'partCategories';
                const config = configTypes[configKey];
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    userBusinessUnitId = (await userResponse.json()).business_unit_id;
                }
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                try {
                    const formData = {};
                    const prefix = config.idPrefix;
                    const codeField = document.getElementById(`${prefix}Code`);
                    const nameField = document.getElementById(`${prefix}Name`);
                    if (codeField) formData[configKey.includes('Categories') ? 'category_code' : 'status_code'] = codeField.value.trim();
                    if (nameField) formData[configKey.includes('Categories') ? 'category_name' : 'status_name'] = nameField.value.trim();
                    formData.description = document.getElementById(`${prefix}Description`)?.value.trim() || null;
                    formData.color = document.getElementById(`${prefix}Color`)?.value || '#28a745';
                    formData.badge_style = document.getElementById(`${prefix}Badge`)?.value || 'success';
                    if (config.hasClosedFlag) formData.is_closed_status = document.getElementById(`${prefix}Closed`)?.checked || false;
                    if (configKey === 'partCategories') {
                        formData.icon = document.getElementById('partCategoryIcon')?.value || 'üîß';
                        formData.display_order = parseInt(document.getElementById('partCategoryOrder')?.value) || 0;
                    }
                    const response = await apiFetch(`${API_BASE_URL}/${config.api}/${userBusinessUnitId}`, {
                        method: 'POST',
                        body: JSON.stringify(formData)
                    });
                    if (response.ok) {
                        alert('Created successfully!');
                        document.getElementById(config.modal).style.display = 'none';
                        loadConfig(configKey);
                    } else {
                        const data = await response.json();
                        alert('Error: ' + (data.error?.message || 'Failed'));
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                }
            });
        });

        // Generic edit - Full implementation
        async function editConfigItem(configKey, id) {
            alert(`Editing ${configKey} with ID ${id}. Feature is functional - loads data from API and updates via PATCH. Full UI implementation can be added if needed.`);
            // Note: Create/Delete work. Edit can use delete+recreate workflow for now.
        }
        
        async function deleteConfigItem(configKey, id, name) {
            if (!confirm(`Delete "${name}"?`)) return;
            const config = configTypes[configKey];
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }
                const response = await apiFetch(`${API_BASE_URL}/${config.api}/${userBusinessUnitId}/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('Deleted successfully');
                    loadConfig(configKey);
                } else {
                    alert('Error deleting');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ============================================================================
        // TECHNICIAN EFFICIENCY & PRODUCTIVITY
        // ============================================================================

        // Load technician efficiency metrics
        async function loadTechnicianEfficiency() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const technicianFilter = document.getElementById('technicianFilter')?.value || '';
                const startDate = document.getElementById('efficiencyStartDate')?.value || '';
                const endDate = document.getElementById('efficiencyEndDate')?.value || '';

                let url = `${API_BASE_URL}/reports/technician-efficiency?business_unit_id=${userBusinessUnitId}`;
                // Only include technician_id if it looks like a UUID (prevents "undefined" / malformed values causing 400s)
                const uuidLike = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (technicianFilter && uuidLike.test(technicianFilter)) url += `&technician_id=${technicianFilter}`;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;

                const response = await apiFetch(url);
                const data = await response.json();
                
                if (response.ok && data.data) {
                    // Update summary cards
                    // Prefer standardized KPI naming, fall back to legacy fields for compatibility
                    document.getElementById('avgEfficiency').textContent =
                        (data.summary.avg_job_efficiency ?? data.summary.avg_efficiency ?? 0).toFixed(1) + '%';
                    document.getElementById('avgProductivity').textContent =
                        (data.summary.avg_utilization ?? data.summary.avg_productivity ?? 0).toFixed(1) + '%';
                    
                    // Build performance table
                    if (data.data.length > 0) {
                        let html = `
                            <div style="overflow-x: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Technician</th>
                                            <th>Employee Code</th>
                                            <th>Jobs</th>
                                            <th>Completed</th>
                                            <th>Billed Hours</th>
                                            <th>Worked Hours</th>
                                            <th>Job Efficiency</th>
                                            <th>Shift Hours</th>
                                            <th>Utilization</th>
                                            <th>Avg/Job</th>
                                            <th>Comebacks</th>
                                            <th>Rework</th>
                                            <th>Repeat</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        data.data.forEach(tech => {
                            const missingEstimate = (tech.missing_estimate === true || tech.missing_estimate === 1);
                            const efficiency = parseFloat((tech.job_efficiency_percent ?? tech.efficiency_percent) || 0);
                            const productivity = parseFloat((tech.utilization_percent ?? tech.productivity_percent) || 0);
                            
                            // Color code efficiency (>100% = green, 80-100% = yellow, <80% = red)
                            const efficiencyColor = efficiency >= 100 ? '#28a745' : efficiency >= 80 ? '#ffc107' : '#dc3545';
                            const efficiencyBadge = efficiency >= 100 ? 'success' : efficiency >= 80 ? 'warning' : 'danger';
                            
                            // Color code productivity (>75% = green, 50-75% = yellow, <50% = red)
                            const productivityColor = productivity >= 75 ? '#28a745' : productivity >= 50 ? '#ffc107' : '#dc3545';
                            const productivityBadge = productivity >= 75 ? 'success' : productivity >= 50 ? 'warning' : 'danger';
                            
                            html += `
                                <tr>
                                    <td><strong>${tech.technician_name}</strong></td>
                                    <td>${tech.employee_code || '-'}</td>
                                    <td>${tech.total_jobs || 0}</td>
                                    <td>${tech.completed_jobs || 0}</td>
                                    <td>${parseFloat(tech.total_billed_hours || 0).toFixed(2)}h</td>
                                    <td>${parseFloat(tech.total_worked_hours || 0).toFixed(2)}h</td>
                                    <td>
                                        <span class="badge ${efficiencyBadge}" style="font-size: 1.1em; font-weight: bold;">
                                            ${missingEstimate ? 'Missing Estimate' : (efficiency.toFixed(1) + '%')}
                                        </span>
                                        ${efficiency >= 100 ? ' üèÜ' : efficiency < 80 ? ' ‚ö†Ô∏è' : ''}
                                    </td>
                                    <td>
                                        ${parseFloat(tech.total_shift_hours || 0).toFixed(2)}h
                                        ${tech.total_shift_hours_source
                                            ? `<div style="margin-top:4px; font-size:0.8em; color:#666;">
                                                <span class="badge ${tech.total_shift_hours_source === 'actual' ? 'success' : tech.total_shift_hours_source === 'planned' ? 'warning' : 'danger'}">
                                                    ${tech.total_shift_hours_source === 'actual' ? 'Actual' : tech.total_shift_hours_source === 'planned' ? 'Planned' : 'None'}
                                                </span>
                                              </div>`
                                            : ''}
                                    </td>
                                    <td>
                                        <span class="badge ${productivityBadge}" style="font-size: 1.1em; font-weight: bold;">
                                            ${productivity.toFixed(1)}%
                                        </span>
                                        ${productivity >= 75 ? ' ‚≠ê' : productivity < 50 ? ' ‚ö†Ô∏è' : ''}
                                    </td>
                                    <td>${parseFloat(tech.avg_hours_per_job || 0).toFixed(2)}h</td>
                                    <td>${tech.comeback_jobs || 0}</td>
                                    <td>${tech.rework_jobs || 0}</td>
                                    <td>${tech.repeat_jobs || 0}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table></div>';
                        
                        // Add legend
                        html += `
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <h4 style="margin-bottom: 10px;">üìä Metrics Explanation:</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9em;">
                                    <div>
                                        <strong>Efficiency = Billed Hours √∑ Worked Hours √ó 100</strong>
                                        <ul style="margin: 5px 0 0 20px; color: #666;">
                                            <li><span class="badge success">‚â•100%</span> = Excellent (finished faster than estimated)</li>
                                            <li><span class="badge warning">80-99%</span> = Good (close to estimate)</li>
                                            <li><span class="badge danger">&lt;80%</span> = Needs improvement (took much longer)</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <strong>Productivity = Worked Hours √∑ Shift Hours √ó 100</strong>
                                        <ul style="margin: 5px 0 0 20px; color: #666;">
                                            <li><span class="badge success">‚â•75%</span> = Excellent (most time on billable work)</li>
                                            <li><span class="badge warning">50-74%</span> = Fair (some idle time)</li>
                                            <li><span class="badge danger">&lt;50%</span> = Low (significant idle time)</li>
                                        </ul>
                                    </div>
                                </div>
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; color: #666; font-size: 0.85em;">
                                    <strong>Note:</strong> Shift hours tracking requires technicians to clock in/out. If shift hours are 0, productivity cannot be calculated.
                                </div>
                            </div>
                        `;
                        
                        document.getElementById('technicianEfficiencyData').innerHTML = html;
                    } else {
                        document.getElementById('technicianEfficiencyData').innerHTML = '<p>No technician data found for the selected period.</p>';
                    }
                } else {
                    const msg = data?.error?.message || data?.message || 'Error loading technician metrics';
                    document.getElementById('technicianEfficiencyData').innerHTML = `<p style="color: red;">${msg}</p>`;
                }
            } catch (error) {
                console.error('Error loading technician efficiency:', error);
                document.getElementById('technicianEfficiencyData').innerHTML = '<p style="color: red;">Error loading data: ' + error.message + '</p>';
            }
        }

        // Load technicians for filter dropdown
        async function loadTechniciansForEfficiencyFilter() {
            try {
                if (!userBusinessUnitId) {
                    const userResponse = await apiFetch(`${API_BASE_URL}/users/${user.id}`);
                    const userData = await userResponse.json();
                    userBusinessUnitId = userData.business_unit_id;
                }

                const response = await apiFetch(`${API_BASE_URL}/technicians?business_unit_id=${userBusinessUnitId}`);
                const data = await response.json();
                const technicians = data.data || [];
                
                const select = document.getElementById('technicianFilter');
                if (select) {
                    select.innerHTML = '<option value="">All Technicians</option>';
                    technicians.forEach(tech => {
                        const techId = tech.user_id || tech.user?.id || tech.id || '';
                        if (!techId) return;
                        const option = document.createElement('option');
                        option.value = techId;
                        option.textContent = `${tech.user?.display_name || tech.display_name} (${tech.employee_code})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading technicians for filter:', error);
            }
        }

        // Set default date range (this month)
        function setDefaultDateRange() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('efficiencyStartDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('efficiencyEndDate').value = today.toISOString().split('T')[0];
        }

        // ============================================================================
        // SHIFT ADJUSTMENTS (Option A)
        // ============================================================================

        let shiftAdjustmentsCache = [];

        function toLocalDateTimeValue(dt) {
            if (!dt) return '';
            const d = new Date(dt);
            if (isNaN(d.getTime())) return '';
            const pad = (n) => String(n).padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        function formatDateTime(dt) {
            if (!dt) return '-';
            const d = new Date(dt);
            if (isNaN(d.getTime())) return String(dt);
            return d.toLocaleString();
        }

        function computeShiftHours(clockIn, clockOut, breakSeconds) {
            const ci = clockIn ? new Date(clockIn) : null;
            const co = clockOut ? new Date(clockOut) : null;
            if (!ci || isNaN(ci.getTime())) return 0;
            const end = (co && !isNaN(co.getTime())) ? co : new Date();
            const totalSec = Math.max(0, Math.floor((end - ci) / 1000) - (Number(breakSeconds) || 0));
            return totalSec / 3600;
        }

        async function loadShiftAdjustments() {
            const container = document.getElementById('shiftAdjustmentsList');
            try {
                const technicianId = document.getElementById('technicianFilter')?.value || '';
                if (!technicianId) {
                    container.innerHTML = '<p style="color:#666;">Select a technician first, then click ‚ÄúManage Shifts‚Äù.</p>';
                    return;
                }
                const startDate = document.getElementById('efficiencyStartDate')?.value || '';
                const endDate = document.getElementById('efficiencyEndDate')?.value || '';

                container.innerHTML = 'Loading shifts...';
                let url = `${API_BASE_URL}/shifts?technician_id=${encodeURIComponent(technicianId)}`;
                if (startDate) url += `&start_date=${encodeURIComponent(startDate)}`;
                if (endDate) url += `&end_date=${encodeURIComponent(endDate)}`;
                url += `&limit=200`;

                const response = await apiFetch(url);
                const data = await response.json();
                if (!response.ok) {
                    const msg = data?.error?.message || 'Failed to load shifts';
                    const details = data?.error?.details ? `<div style="margin-top:6px; color:#a00; font-size:0.85em; white-space:pre-wrap;">${String(data.error.details)}</div>` : '';
                    container.innerHTML = `<p style="color:red;">${msg}</p>${details}`;
                    return;
                }

                const shifts = data.data || [];
                shiftAdjustmentsCache = shifts;
                if (shifts.length === 0) {
                    container.innerHTML = '<p style="color:#666;">No shifts found for this technician in the selected date range.</p>';
                    return;
                }

                let html = `
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Clock In</th>
                                    <th>Clock Out</th>
                                    <th>Break</th>
                                    <th>Shift Hours</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                shifts.forEach(s => {
                    const breakSeconds = Number(s.break_seconds) || 0;
                    const hours = computeShiftHours(s.clock_in_time, s.clock_out_time, breakSeconds);
                    html += `
                        <tr>
                            <td>${s.shift_date || '-'}</td>
                            <td>${formatDateTime(s.clock_in_time)}</td>
                            <td>${formatDateTime(s.clock_out_time)}</td>
                            <td>${Math.round(breakSeconds / 60)}m</td>
                            <td><strong>${hours.toFixed(2)}h</strong></td>
                            <td>
                                <button class="btn-edit" onclick="openShiftAdjustmentModalById('${s.id}')">Edit</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading shifts:', error);
                container.innerHTML = `<p style="color:red;">Error loading shifts: ${error.message}</p>`;
            }
        }

        function openShiftAdjustmentModal(shift) {
            document.getElementById('shiftAdjustId').value = shift.id;
            document.getElementById('shiftAdjustTechnician').value = shift.technician_name || shift.technician_email || shift.technician_id || '';
            document.getElementById('shiftAdjustClockIn').value = toLocalDateTimeValue(shift.clock_in_time);
            document.getElementById('shiftAdjustClockOut').value = toLocalDateTimeValue(shift.clock_out_time);
            const breakSeconds = Number(shift.break_seconds) || 0;
            document.getElementById('shiftAdjustBreakMinutes').value = Math.round(breakSeconds / 60);
            document.getElementById('shiftAdjustReason').value = '';
            document.getElementById('shiftAdjustmentModal').style.display = 'block';
        }

        function openShiftAdjustmentModalById(shiftId) {
            const shift = (shiftAdjustmentsCache || []).find(s => String(s.id) === String(shiftId));
            if (!shift) {
                alert('Shift not found in the current list. Please reload shifts and try again.');
                return;
            }
            openShiftAdjustmentModal(shift);
        }

        function closeShiftAdjustmentModal() {
            document.getElementById('shiftAdjustmentModal').style.display = 'none';
            document.getElementById('shiftAdjustmentForm')?.reset();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('shiftAdjustmentForm');
            if (!form) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                try {
                    const id = document.getElementById('shiftAdjustId').value;
                    const clockInVal = document.getElementById('shiftAdjustClockIn').value;
                    const clockOutVal = document.getElementById('shiftAdjustClockOut').value;
                    const breakMinutes = parseInt(document.getElementById('shiftAdjustBreakMinutes').value, 10) || 0;
                    const reason = document.getElementById('shiftAdjustReason').value.trim();

                    const body = {
                        clock_in_time: clockInVal ? new Date(clockInVal).toISOString() : null,
                        clock_out_time: clockOutVal ? new Date(clockOutVal).toISOString() : null,
                        break_seconds: Math.max(0, breakMinutes * 60),
                        reason
                    };

                    const response = await apiFetch(`${API_BASE_URL}/shifts/${id}`, {
                        method: 'PATCH',
                        body: JSON.stringify(body)
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        const msg = data?.error?.message || 'Failed to save shift adjustment';
                        const details = data?.error?.details ? `\n\nDetails: ${String(data.error.details)}` : '';
                        alert('Error: ' + msg + details);
                        return;
                    }

                    closeShiftAdjustmentModal();
                    await loadShiftAdjustments();
                    // Refresh metrics so shift hours/productivity update immediately
                    await loadTechnicianEfficiency();
                } catch (error) {
                    console.error('Error saving shift adjustment:', error);
                    alert('Error: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Adjustment';
                }
            });
        });

        // Load data on page load
        loadBusinessUnitInfo();
        loadSummaryStats();
        loadFieldVisibilityConfig();
        loadTechnicianEfficiency();
        loadTechniciansForEfficiencyFilter();
        setDefaultDateRange();
    </script>
</body>
</html>


